<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2021-03-24 Wed 06:00 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Linux</title>
<meta name="generator" content="Org mode" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="shortcut icon" href="/public_html/favicon.ico" type="image/x-icon">
<link rel="stylesheet" type="text/css" href="https://joesanmarzano.duckdns.org/public_html/css/org-html-themes-master/styles/html-export.css"/>
<link rel="stylesheet" type="text/css" href="https://joesanmarzano.duckdns.org/public_html/css/org-html-themes-master/styles/bigblow/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://joesanmarzano.duckdns.org/public_html/css/org-html-themes-master/styles/bigblow/css/hideshow.css"/>
<link rel="stylesheet" type="text/css" href="https://joesanmarzano.duckdns.org/public_html/css/org-html-themes-master/styles/bigblow/css/code.css">

<script type="text/javascript" src="https://joesanmarzano.duckdns.org/public_html/css/org-html-themes-master/styles/bigblow/js/jquery-1.11.0.min.js"></script>
<script type="text/javascript" src="https://joesanmarzano.duckdns.org/public_html/css/org-html-themes-master/styles/bigblow/js/jquery-ui-1.10.2.min.js"></script>
<script type="text/javascript" src="https://joesanmarzano.duckdns.org/public_html/css/org-html-themes-master/styles/bigblow/js/jquery.localscroll-min.js"></script>
<script type="text/javascript" src="https://joesanmarzano.duckdns.org/public_html/css/org-html-themes-master/styles/bigblow/js/jquery.scrollTo-1.4.3.1-min.js"></script>
<script type="text/javascript" src="https://joesanmarzano.duckdns.org/public_html/css/org-html-themes-master/styles/bigblow/js/jquery.zclip.min.js"></script>
<script type="text/javascript" src="https://joesanmarzano.duckdns.org/public_html/css/org-html-themes-master/styles/bigblow/js/bigblow.js"></script>
<script type="text/javascript" src="https://joesanmarzano.duckdns.org/public_html/css/org-html-themes-master/styles/bigblow/js/hideshow.js"></script>
<script type="text/javascript" src="https://joesanmarzano.duckdns.org/public_html/css/org-html-themes-master/styles/bigblow/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div style = "text-align: right; margin-top: 5px">
   <a accesskey="h" href="" style="font: 20px arial,helvetica,clean,sans-serif"></a>
   <a accesskey="H" href="https://joesanmarzano.duckdns.org/public_html/" style="font: 20px arial,helvetica,clean,sans-serif;margin: 30px;"> HOME </a>
</div><div id="content">
<h1 class="title">Linux</h1>

<div id="outline-container-org3587d4e" class="outline-2">
<h2 id="org3587d4e">Links</h2>
<div class="outline-text-2" id="text-org3587d4e">
<ul class="org-ul">
<li>Man Pages: <a href="https://www.kernel.org/doc/man-pages/">https://www.kernel.org/doc/man-pages/</a></li>
</ul>
</div>
</div>
<div id="outline-container-org68cecb0" class="outline-2">
<h2 id="org68cecb0">Installation</h2>
<div class="outline-text-2" id="text-org68cecb0">
</div>
<div id="outline-container-org32815cf" class="outline-3">
<h3 id="org32815cf">MicroSD Card</h3>
<div class="outline-text-3" id="text-org32815cf">
<p>
Get an image and some kind of Flashing Tool, e.g. WindowsWin32DiskImager
or <a href="https://etcher.io/">https://etcher.io/</a>.
</p>

<p>
Note: The image (e.g. 2GB) might have to be enlarged to fit the full size of
      the SD-Card.
</p>
</div>
</div>
</div>

<div id="outline-container-orgf8c310a" class="outline-2">
<h2 id="orgf8c310a">Administration</h2>
<div class="outline-text-2" id="text-orgf8c310a">
</div>
<div id="outline-container-org23a1a76" class="outline-3">
<h3 id="org23a1a76">Cron</h3>
<div class="outline-text-3" id="text-org23a1a76">
<p>
Cron Jobs can get lost (on updates?) - back them up.
The files can be found in <code>/var/spool/cron/crontabs/</code>.
</p>

<p>
The command
</p>
<pre class="example">
crontab -e
</pre>

<p>
will open the crontab (cron config file) of the current user
</p>

<p>
Change cron of a different user:
</p>
<pre class="example">
crontab -u www-data -e
</pre>


<p>
<b>Syntax</b>
</p>
<ul class="org-ul">
<li>Crontab expression editor:  <a href="https://crontab.guru/">https://crontab.guru/</a></li>
</ul>

<pre class="example">
[minute    hour    day-of-month    month    day-of-week     command]
 0-59      0-23    1-31            1-12     0-6 (Sun - Sat)
</pre>


<p>
Special Characters
</p>
<ul class="org-ul">
<li><code>*</code>   every minute, hour, day, month, etc.</li>
<li><code>-</code>   time range</li>
<li><code>,</code>   e.g. <code>0,20,40</code>  every 20 minutes</li>
<li><code>/</code>   e.g. <code>*/2*</code>     every 2 minutes, hours, days, etc.</li>
</ul>

<p>
Special Strings
</p>
<ul class="org-ul">
<li><code>@reboot</code></li>
<li><code>@yearly</code></li>
<li><code>@annually</code></li>
<li><code>@monthly</code></li>
<li><code>@weekly</code></li>
<li><code>@daily</code></li>
<li><code>@hourly</code></li>
<li><code>@midnight</code></li>
</ul>

<hr />
<p>
<b>Examples</b>
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left"><code>* * * * *</code> or <code>0-59 0-23 0-31 0-12 0-7</code></td>
<td class="org-left">every minute of every day</td>
</tr>

<tr>
<td class="org-left"><code>0 * * * *</code></td>
<td class="org-left">every hour</td>
</tr>

<tr>
<td class="org-left"><code>*/15 * * * *</code></td>
<td class="org-left">every 15 mins</td>
</tr>

<tr>
<td class="org-left"><code>0 */2 * * *</code></td>
<td class="org-left">every 2 hours</td>
</tr>

<tr>
<td class="org-left"><code>0 0 * * 0</code></td>
<td class="org-left">every Sunday midnight</td>
</tr>

<tr>
<td class="org-left"><code>0,15,25 * * * *</code></td>
<td class="org-left">0, 15, 25 min. after the full hour</td>
</tr>

<tr>
<td class="org-left"><code>07-59/5 06 * * *</code></td>
<td class="org-left">every min. at 6 starting at 6:07</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<pre class="example">
@hourly /home/odroid/script.sh
</pre>


<pre class="example">
0 1 * * 1 ~/bin/Backup/makeBigDataBackup.sh
</pre>

<p>
this runs
every Monday at 01:00
</p>

<pre class="example">
30 3 1 */3 * /path/to/script
</pre>

<p>
every 3 months at 03:30 on the 1st of Jan, Apr, Jul, Oct
</p>

<p>
alternatively:
</p>
<pre class="example">
30 3 1 Jan,Apr,Jul,Oct * /path/to/script 
</pre>

<p>
Note: The first three Letters of the month names are used.
</p>

<p>
You can also put a script in one of those folders:
</p>
<pre class="example">
/etc/cron.daily, /etc/cron.hourly, /etc/cron.monthly, /etc/cron.weekly
</pre>


<p>
See also: <a href="../Hardware/Odroid XU4.html#orgc0987c7">Odroid XU4.org::Cron Tasks</a>
</p>
</div>
</div>

<div id="outline-container-org3d9d5c8" class="outline-3">
<h3 id="org3d9d5c8">Configuration files</h3>
<div class="outline-text-3" id="text-org3d9d5c8">
<p>
Configuration files for applications are usually found in <i>etc</i>.
</p>

<ul class="org-ul">
<li>network
<ul class="org-ul">
<li><code>/etc/network/interfaces</code></li>
<li><p>
<code>/etc/samba/smb.conf</code>
</p>
<pre class="example">
apt-get install samba
</pre></li>
<li>NFS Client List: <code>/etc/exports</code></li>
</ul></li>

<li>mounting
<ul class="org-ul">
<li>fstab</li>
</ul></li>
<li>system
<ul class="org-ul">
<li>/etc/apt/sources.list.d</li>
</ul></li>
<li>security
<ul class="org-ul">
<li>/etc/passwd</li>
</ul></li>
<li>/etc/profile
Set environmental items for a users shell.
<ul class="org-ul">
<li>also ~/.profile or ~/.bash_profile</li>
<li>/etc/profile.d
Contains scripts executed from profile</li>
<li>etc/bash.bashrc
Used for setting command aliases and functions
used by users.</li>
</ul></li>
<li><p>
boot
For starting scripts and programs with root at bootup, make an entry in:
</p>
<pre class="example">
/etc/rc.local
</pre>

<p>
Don't use this with systemd!
</p></li>
</ul>
</div>
</div>

<div id="outline-container-orga14defa" class="outline-3">
<h3 id="orga14defa">Log files</h3>
<div class="outline-text-3" id="text-orga14defa">
<ul class="org-ul">
<li><code>var/log/</code></li>
<li>dmesg</li>
<li>syslog</li>
<li>kern.log</li>
<li>Network</li>
</ul>
<pre class="example">
sudo view /var/log/syslog
</pre>
</div>
</div>
<div id="outline-container-org43f2725" class="outline-3">
<h3 id="org43f2725">Startup</h3>
<div class="outline-text-3" id="text-org43f2725">
<ul class="org-ul">
<li><code>/etc/init.d</code></li>
<li><code>/etc/init/</code></li>
<li><code>/etc/systemd</code></li>
</ul>
</div>

<div id="outline-container-org4acf866" class="outline-4">
<h4 id="org4acf866">rc.local</h4>
<div class="outline-text-4" id="text-org4acf866">
<p>
The <code>/etc/rc.local</code> file runs (root) after all the other init level scripts have run.
</p>
</div>
</div>
<div id="outline-container-org668d0a1" class="outline-4">
<h4 id="org668d0a1">init.d directory</h4>
<div class="outline-text-4" id="text-org668d0a1">
<p>
Contains various start/stop scripts for system services, like:
</p>
<ul class="org-ul">
<li>apache2</li>
<li>networking</li>
<li>transmission-daemon</li>
<li>samba</li>
<li>mysql</li>
<li>lirc</li>
<li>cron</li>
</ul>

<p>
These scripts can be run like so:
</p>
<pre class="example">
/etc/init.d/apache2 OPTION
</pre>


<p>
OPTION might be:
</p>
<ul class="org-ul">
<li>start</li>
<li>stop</li>
<li>reload</li>
<li>restart</li>
<li>force-reload</li>
</ul>
</div>
</div>

<div id="outline-container-org9328649" class="outline-4">
<h4 id="org9328649">systemd</h4>
<div class="outline-text-4" id="text-org9328649">
<p>
Session manager for managing system services from boot to shutdown.
</p>

<p>
You can create your own services by creating a <code>.service</code> file in the 
directory: 
</p>
<pre class="example">
/etc/systemd/system/
</pre>
</div>
</div>
<div id="outline-container-org81e32bd" class="outline-4">
<h4 id="org81e32bd">Runlevel</h4>
<div class="outline-text-4" id="text-org81e32bd">
<p>
System state mainly relevant for the boot process or maintenance. Every runlevel 
has specific services associated with it. 
</p>

<p>
Standard runlevels are:
</p>
<dl class="org-dl">
<dt><code>0</code></dt><dd>Shutdown</dd>
<dt><code>S</code></dt><dd>Single user mode (no network, no daemons)</dd>
<dt><code>6</code></dt><dd>Reboot</dd>
</dl>

<p>
Runlevel directories:
</p>
<pre class="example">
/etc/rc0.d
/etc/rc1.d
...
</pre>
</div>
</div>
</div>

<div id="outline-container-org4623c96" class="outline-3">
<h3 id="org4623c96">Sound</h3>
<div class="outline-text-3" id="text-org4623c96">
<ul class="org-ul">
<li>ALSA (Advanced Linux Sound Architecture)</li>
<li>OSS (Open Sound System)</li>
</ul>

<p>
Above those we find Soundserver.
</p>
<dl class="org-dl">
<dt>PulseAudio</dt><dd>PulseAudio normally runs in user mode, i.e. a user has
to be logged in and active.</dd>
</dl>

<pre class="example">
Soundsource -&gt; PulseAudio -&gt; ALSA drivers -&gt; Hardware
</pre>


<p>
PulseAudio tools
</p>
<ul class="org-ul">
<li><code>alsamixer</code>
terminal tool</li>
<li><code>pactl</code> 
Control a running PulseAudio sound server.</li>

<li><code>pacmd</code>
Reconfigure a PulseAudio sound server during runtime.
Has more options than <code>pactl</code></li>
<li><code>pavucontrol</code> (PulseAudio Volume Control)
The GUI tool.</li>
<li><code>pavumeter</code>   (PulseAudio Meter)
Display Output-/Input-Levels</li>
<li><code>paprefs</code>     (PulseAudio Preferences)
Network access</li>
</ul>
</div>
</div>

<div id="outline-container-org9907238" class="outline-3">
<h3 id="org9907238">TTY subsystem</h3>
<div class="outline-text-3" id="text-org9907238">
<p>
Origin: Teletype (Fernschreiber) Machines, Telex network
</p>

<p>
Text only virtual console, e.g. <code>/dev/pts/0</code> (tty driver) having it's own
<code>stdin</code>, <code>stdout</code>, <code>stderr</code>. 
</p>

<p>
The tty driver keeps track of the processes. 
</p>

<dl class="org-dl">
<dt>tty</dt><dd>show current virtual console</dd>
</dl>
</div>
</div>
</div>
<div id="outline-container-orge0a1043" class="outline-2">
<h2 id="orge0a1043">Networking</h2>
<div class="outline-text-2" id="text-orge0a1043">
</div>
<div id="outline-container-org2afad6f" class="outline-3">
<h3 id="org2afad6f">Samba</h3>
<div class="outline-text-3" id="text-org2afad6f">
<p>
/etc/samba/smb.conf
</p>

<p>
Structure of the file:
</p>
<ul class="org-ul">
<li>[global]</li>
<li>[homes]</li>
<li>[printers]</li>
<li>[&lt;Share&gt;]</li>
</ul>

<p>
Mount Windows Samab-Share, with full access:
</p>
<pre class="example">
//192.168.10.3/team/    /media/team     cifs    defaults,rw,user=&lt;usr&gt;,pass=&lt;pwd&gt;,file_mode=0777,dir_mode=0777        0       0
</pre>
</div>
</div>

<div id="outline-container-org3952fb1" class="outline-3">
<h3 id="org3952fb1">Internet</h3>
<div class="outline-text-3" id="text-org3952fb1">
<p>
Set DNS server ip address:
Add entry in <code>/etc/resolv.conf</code>, i.e. <code>nameserver 8.8.8.8</code>. 
</p>
</div>

<div id="outline-container-org8a60ac1" class="outline-4">
<h4 id="org8a60ac1">Download files from server</h4>
<div class="outline-text-4" id="text-org8a60ac1">
<ul class="org-ul">
<li><p>
rsync
</p>
<pre class="example">
rsync -s -chavzP --stats odroid@joesanmarzano.duckdns.org:"/media/BigData/Filmarchiv/8 Blickwinkel/8 Blickwinkel.avi" /mnt/c/Users/jh/Desktop
</pre></li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-orgf2522bb" class="outline-2">
<h2 id="orgf2522bb">Kernel</h2>
<div class="outline-text-2" id="text-orgf2522bb">
</div>
<div id="outline-container-org83d3710" class="outline-3">
<h3 id="org83d3710">Links</h3>
<div class="outline-text-3" id="text-org83d3710">
<ul class="org-ul">
<li>Core API Documentation: <a href="https://www.kernel.org/doc/html/v4.12/core-api/index.html">https://www.kernel.org/doc/html/v4.12/core-api/index.html</a></li>
<li>Man Pages: <a href="https://www.kernel.org/doc/man-pages/">https://www.kernel.org/doc/man-pages/</a></li>
<li>Linux Kernel Teaching: <a href="https://linux-kernel-labs.github.io/refs/heads/master/index.html">https://linux-kernel-labs.github.io/refs/heads/master/index.html</a></li>
<li>List of System Calls: <a href="https://fedora.juszkiewicz.com.pl/syscalls.html">https://fedora.juszkiewicz.com.pl/syscalls.html</a></li>
</ul>
</div>
</div>
<div id="outline-container-org8ac2b80" class="outline-3">
<h3 id="org8ac2b80">Building the Kernel</h3>
<div class="outline-text-3" id="text-org8ac2b80">
<p>
Main steps:
</p>
<ul class="org-ul">
<li><p>
get source <a href="https://www.kernel.org/pub/linux/kernel/">https://www.kernel.org/pub/linux/kernel/</a>
Example:
</p>
<pre class="example">
wget https://cdn.kernel.org/pub/linux/kernel/v5.x/linux-5.8.12.tar.xz
tar xf linux-3.10.tar.xz
</pre></li>
<li>configure</li>
<li>build</li>
<li>install</li>
</ul>

<p>
Comments:
</p>
<ul class="org-ul">
<li>Don't build the Kernel with root privileges!</li>
<li>Don't put the kernel source code in <i>usr/src/linux</i>!
This is the location of the kernel you are working on.
Use a local user directory for your new kernel.</li>
</ul>

<p>
The System you work on might get messed up.
</p>

<p>
To get a full Linux system four elements are needed:
</p>
<ul class="org-ul">
<li>Toolchain</li>
<li>Bootloader</li>
<li>Kernel</li>
<li>Root Filesystem</li>
</ul>
</div>

<div id="outline-container-org421aa70" class="outline-4">
<h4 id="org421aa70">Compile Kernel on ARM7</h4>
</div>
<div id="outline-container-orgb8218e3" class="outline-4">
<h4 id="orgb8218e3">Compile Kernel on Ubuntu</h4>
<div class="outline-text-4" id="text-orgb8218e3">
<p>
Get the kernel sources
</p>
<pre class="example">
wget https://cdn.kernel.org/pub/linux/kernel/v5.x/linux-5.8.12.tar.xz
</pre>

<p>
Unzip the source
</p>
<pre class="example">
tar xf linux-5.8.12.tar.xz 
</pre>

<p>
Copy the existing config file
</p>
<pre class="example">
cd linux-5.8.12
cp /boot/config-5.4.0-48-generic .config
</pre>

<p>
Set Architecture
</p>
<pre class="example">
export ARCH=x86_64
make menuconfig
</pre>

<p>
Build the kernel binary (using 8 cores)
</p>
<pre class="example">
make -j8
</pre>

<p>
Install kernel
</p>
<pre class="example">
sudo make modules_install
</pre>

<p>
(this installs the .ko files to <code>lib/modules</code>)
</p>
<pre class="example">
sudo make install
</pre>

<p>
   (this copies <code>vmlinuzXXX</code>, <code>initrd.imgXXX</code>, <code>System.mapXXX</code> to <code>/boot</code>)
Update grub 
</p>
<ul class="org-ul">
<li>not needed on Ubuntu (already done with make install)</li>
</ul>
</div>
</div>

<div id="outline-container-org2eecafa" class="outline-4">
<h4 id="org2eecafa">Toolchain</h4>
<div class="outline-text-4" id="text-org2eecafa">
<p>
Tools needed to configure, build and boot the Kernel.
(For the required version of a tool see <i>Documentation/Changes</i>.)
</p>

<p>
Tools for building the Kernel:
</p>
<ul class="org-ul">
<li><p>
GIT
</p>
<pre class="example">
sudo apt-get install git
git config --global user.name "hamajo75"
</pre></li>
<li><p>
Compiler
<i>gcc</i> has to be used. (<a href="http://gcc.gnu.org">http://gcc.gnu.org</a>)
</p>
<pre class="example">
gcc --version
</pre>

<p>
Example: (BeagleBone)
</p>
<pre class="example">
sudo apt-get install gcc-arm-linux-gnueabi
</pre></li>
<li><p>
Linker
The <i>binutils</i> are a set of tools to do linking and assembling.
</p>
<pre class="example">
ld -v  
</pre></li>
<li><p>
Make
Calls the compiler and tools to actually build the kernel.
</p>
<pre class="example">
make --version
</pre></li>
</ul>
</div>
</div>
<div id="outline-container-org8e40ab0" class="outline-4">
<h4 id="org8e40ab0">Bootloader</h4>
<div class="outline-text-4" id="text-org8e40ab0">
<ul class="org-ul">
<li>Grub</li>
<li>U-Boot (embedded)
needs a uImage or a zImage</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgc19df06" class="outline-3">
<h3 id="orgc19df06">Processes</h3>
<div class="outline-text-3" id="text-orgc19df06">
<p>
When a parent process dies init becomes the adoptive parent of the 
orphaned children.
</p>

<p>
wait();
waitpid();
</p>
</div>
<div id="outline-container-org62e6d20" class="outline-4">
<h4 id="org62e6d20">Inter Process Communication (IPC)</h4>
<div class="outline-text-4" id="text-org62e6d20">
</div>
<div id="outline-container-orgadf3186" class="outline-5">
<h5 id="orgadf3186">Pipes</h5>
<div class="outline-text-5" id="text-orgadf3186">
<p>
Create a named pipe: mkfifo myfifo
</p>

<p>
Put something in:
</p>
<pre class="example">
echo Hello Joe &gt; myfifo
</pre>

<p>
Take something out:
</p>
<pre class="example">
cat myfifo
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org99427ab" class="outline-3">
<h3 id="org99427ab">Boot Process</h3>
<div class="outline-text-3" id="text-org99427ab">
</div>
<div id="outline-container-org6aa78c0" class="outline-4">
<h4 id="org6aa78c0">Bootloader (grub)</h4>
<div class="outline-text-4" id="text-org6aa78c0">
<p>
Load the kernel binary into RAM and start.
</p>

<p>
The kernel image can be loaded form various places.
The image is normally compressed, so it also has to be decompressed.
</p>
</div>
</div>
<div id="outline-container-orgce68ab1" class="outline-4">
<h4 id="orgce68ab1">What is the first part of the kernel binary that will be executed?</h4>
<div class="outline-text-4" id="text-orgce68ab1">
<p>
start_kernel() in init/main.c
</p>
</div>
</div>
</div>
<div id="outline-container-orgadff268" class="outline-3">
<h3 id="orgadff268">The root filesystem</h3>
<div class="outline-text-3" id="text-orgadff268">
<p>
The kernel will get a root filesystem, e.g. from the bootloader (as a pointer)
or by mounting a block device on the Kernel command line.
</p>

<p>
Once it has a root filesystem it will execute the first program, <i>init</i>.
For a usful system we need at least these compontents:
</p>
<ul class="org-ul">
<li>init</li>
<li>shell</li>
<li>daemons</li>
<li>shared libraries</li>
<li>configuration files</li>
<li>device nodes</li>
<li>/proc and /sys 
Two pseaudo filesystems for representing kernel data</li>
<li>kernel modules</li>
</ul>

<p>
All sorts of filesystems can be mounted in the global hierachy.
Applications don't need to know where something is really stored. 
</p>

<p>
The device file in <code>/dev</code> is actually the 0s and 1s. 
</p>

<p>
Mount command:
</p>
<pre class="example">
sudo mount -t vfat /dev/sda1 /mnt/usbkey
</pre>


<p>
Show all mounted filesystems:
</p>
<pre class="example">
mount
</pre>


<p>
Show all supported filesystems: 
</p>
<pre class="example">
cat /proc/filesystems
</pre>


<p>
<code>/</code> is the root filesystem
</p>
<ul class="org-ul">
<li>its mounted by the kernel (cannot be unmounted) according to the root= argument</li>
</ul>

<p>
Partitions on HD or USB key:
</p>
<ul class="org-ul">
<li><code>/dev/sdXY</code> : X is a letter for the device, Y is the number of the partition</li>
</ul>

<p>
Partitions on SD cards
</p>
<ul class="org-ul">
<li><code>/dev/mmcblkXpY</code> : X - device, Y - partition</li>
</ul>

<p>
Partitions on flash storage
</p>
<ul class="org-ul">
<li><code>/dev/mtdblockX</code> : X - partition</li>
</ul>

<p>
<code>root=/dev/sdb2</code> is just a naming convention (it's not mounted yet!)
</p>
</div>

<div id="outline-container-orgb450e63" class="outline-4">
<h4 id="orgb450e63">Mounting rootfs over the network</h4>
<div class="outline-text-4" id="text-orgb450e63">
<p>
NFS (Network File System)
</p>

<p>
Install server
</p>
<pre class="example">
sudo apt install nfs-kernel-server
</pre>

<p>
Add exported directory to 
</p>
<pre class="example">
/etc/exports
/home/tux/rootfs 192.168.1.*(rw,no_root_squash,no_subtree_check)
</pre>


<ul class="org-ul">
<li>192.168.1.* authorized client IP address</li>
<li><code>no_root_squash</code></li>
<li><code>no_subtree_check</code></li>
</ul>

<p>
Restart server
</p>
<pre class="example">
sudo /etc/init.d/nfs-kernel-server restart
</pre>


<p>
Client:
</p>
<ul class="org-ul">
<li>CONFIG_NFS_FS=y</li>
<li>CONFIG_IP_PNP=y (static ip address)</li>
<li>CONFIG_ROOT_NFS=y</li>
</ul>

<p>
Boot parameters:
<code>root=/dev/nfs</code>
</p>
</div>
</div>

<div id="outline-container-org1e2b01a" class="outline-4">
<h4 id="org1e2b01a">initramfs</h4>
<div class="outline-text-4" id="text-org1e2b01a">
<p>
<code>rootfs</code> in memory
</p>
<ul class="org-ul">
<li>no drivers needed</li>
</ul>
</div>
</div>

<div id="outline-container-orgfad657a" class="outline-4">
<h4 id="orgfad657a">Root FS organization</h4>
<div class="outline-text-4" id="text-orgfad657a">
<p>
<code>/bin</code> : basic programs (bash, ls, cp, etc.)
<code>/boot</code> : Kernel images, configurations and initramfs
<code>/dev</code> : devices
<code>/lib</code> : Basic libraries, C library
<code>/media</code> : removable media
<code>/sys</code> : sysfs virtual filesystem
<code>/usr/bin</code> : non-basic programms
<code>/usr/lib</code> : non-basic libs
<code>/usr/sbin</code> : non-basic
<code>/var</code> : logging, variable data files
</p>
</div>

<div id="outline-container-org6e973cb" class="outline-5">
<h5 id="org6e973cb">Device Files <code>/dev</code></h5>
<div class="outline-text-5" id="text-org6e973cb">
<p>
Everything is a file, except network devices (not in /dev)
</p>
<ul class="org-ul">
<li>file API: <code>open</code>, <code>read</code>, <code>write</code>, <code>close</code></li>

<li>Character device : stream of bytes (serial port, sound card,
frame buffer, video, etc.)</li>
<li>Block device : fixed size blocks (HD, USB, SD card)</li>
</ul>

<p>
Internally the kernel uses:
</p>
<ul class="org-ul">
<li>Type (character or block)</li>
<li>Major Nr. (category)</li>
<li>Minor Nr. (identifier)</li>
</ul>

<p>
Examples:
</p>

<p>
Block device:
</p>
<pre class="example">
ls -l sda
brw-rw---- 1 root disk 8, 0 Oct  1 03:26 sda
</pre>

<p>
(notice the "b", 8-major nr., 0-minor nr.)
</p>

<p>
Character device:
</p>
<pre class="example">
ls -l tty1
crw--w---- 1 root tty 4, 1 Oct  1 03:26 tty1
</pre>
</div>
</div>

<div id="outline-container-org3889b3a" class="outline-5">
<h5 id="org3889b3a"><code>/proc</code> virtual filesystem</h5>
<div class="outline-text-5" id="text-org3889b3a">
<ul class="org-ul">
<li>system information: statistics processes (ps, top)</li>
<li><code>Documentation/filesystems/proc.txt</code></li>
</ul>

<p>
General device information:
</p>
<ul class="org-ul">
<li><code>/proc/interrupts</code>, <code>proc/iomem</code>, <code>/proc/iports</code></li>
</ul>

<p>
for each running process
</p>
<ul class="org-ul">
<li><code>/proc/&lt;pid&gt;</code></li>
<li><code>/proc/3840/cmdline</code></li>
</ul>

<p>
Check with sudo:
</p>
<pre class="example">
sudo cat /proc/iomem
sudo cat /proc/cmdline
</pre>
</div>
</div>

<div id="outline-container-org77f4da3" class="outline-5">
<h5 id="org77f4da3">sysfs filesystem <code>/sys</code></h5>
<div class="outline-text-5" id="text-org77f4da3">
<p>
see by groups:
</p>
<pre class="example">
cd /sys/class
</pre>


<p>
Plenty of information about devices. 
</p>
</div>
</div>
</div>
<div id="outline-container-org598dbeb" class="outline-4">
<h4 id="org598dbeb">Basic applications</h4>
<div class="outline-text-4" id="text-org598dbeb">
<p>
Linux needs at least a few applications:
</p>
<ul class="org-ul">
<li><code>init</code> : starts all other user space applications</li>
<li>shell</li>
<li>basic commands: <code>mv</code>, <code>cp</code>, <code>mkdir</code>, <code>cat</code>, <code>modprobe</code>, <code>mount</code>, <code>ip</code>, etc.</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orga89b16f" class="outline-3">
<h3 id="orga89b16f">Object Oriented Programming in C</h3>
<div class="outline-text-3" id="text-orga89b16f">
</div>
<div id="outline-container-org3725c8f" class="outline-4">
<h4 id="org3725c8f">Objects and method Dispatch</h4>
<div class="outline-text-4" id="text-org3725c8f">
<p>
At least it seems to be clear what an object is. It is simply an abstraction
comprising both state and behavior. An object is like a struct, except that
some of the members refer to functions which act on the other fields in the 
object. These function members are sometimes referred to as <i>methods</i>.
</p>

<p>
The most obvious way to implement objects in C is to declare a struct where some
fields are function pointers to functions which take a pointer to the struct
(this-pointer) as their first argument.
</p>

<p>
Methods (unlike state) are normally not changed from object to object, so another
approach is to collect all the methods for a particular class of objects into a separate
structure, sometimes known as <i>virtual function table</i>. The object then has a single
pointer to this table rather than a separate pointer for each method, and consequently uses less memory.
</p>
</div>
<div id="outline-container-org6276760" class="outline-5">
<h5 id="org6276760">vtable - structures</h5>
<div class="outline-text-5" id="text-org6276760">
<p>
A <i>pure vtable</i> is a struct which contains only function pointers. The first argument of 
these functions is a pointer to some other structure (an object) which itself contains
a pointer to this vtable.
</p>
</div>
</div>
</div>
<div id="outline-container-orgc9eaf6b" class="outline-4">
<h4 id="orgc9eaf6b">Abstract Data Types</h4>
<div class="outline-text-4" id="text-orgc9eaf6b">
<p>
The idea behind ADTs is:
Hide implementation and provide a well defined interface for data structures.
The implementer and the user of this definition have, that way, a clear idea
of what is required and what is to be expected.
</p>

<p>
In the Linux Kernel however implementation details are preformace relevant
and should not be hidden away.
</p>
</div>
<div id="outline-container-orgd883ea8" class="outline-5">
<h5 id="orgd883ea8">Doubly Linked Lists</h5>
<div class="outline-text-5" id="text-orgd883ea8">
<pre class="example">
include/linux/list.h (no .c file)
</pre>

<p>
struct list_head not only serves as the head of a list, but also as the anchor in 
items that are on a list. 
</p>

<p>
The list_head structure can be embedded anywhere in a data structure, and the
list_heads from a number of instances of that structure can be linked together.
The containing structure can be found from a -&gt;next or -&gt;prev pointer using
the list_entry() macro.
</p>

<p>
This practice of embedding one structure inside another and using container_of()
to get the parent from the child structure is quite common in the Linux Kernel
and is somewhat reminiscent of object programming.
</p>
</div>
</div>

<div id="outline-container-org9993e68" class="outline-5">
<h5 id="org9993e68">RB-Trees</h5>
</div>
</div>
</div>

<div id="outline-container-org17749dd" class="outline-3">
<h3 id="org17749dd">Kernel Modules, Device Drivers</h3>
<div class="outline-text-3" id="text-org17749dd">
<p>
On the lowest software layer we find <i>bus drivers</i>. These directly control the physical buses
used to communicate with other hardware devices. A <i>device driver</i> sits on top of this layer.
So a device driver has an interface below (to the bus driver) and an interface above (to the OS).
In Linux the above interface separates <i>User Space</i> from <i>Kernel Space</i> (<i>Hardware Space</i> is the
lowest layer). 
</p>

<p>
In the Kernel Space we find things like: Process Management, Memory Management, Network Stack, 
Virtual File System, etc. More abstract we have 5 management tasks for the OS:
</p>
<ol class="org-ol">
<li>processes</li>
<li>memory</li>
<li>network</li>
<li>storage</li>
<li>I/O</li>
</ol>

<p>
A driver offers several functions to a user program. 
</p>

<p>
A device driver presents itself to the system as a device file.
Device drivers have a class name and a device name.
</p>
</div>

<div id="outline-container-orge553a03" class="outline-4">
<h4 id="orge553a03">Skeleton of a device driver</h4>
<div class="outline-text-4" id="text-orge553a03">
<p>
The most simple driver contains an entry point and an exit point:
</p>
<ul class="org-ul">
<li>module_init(&lt;name_init_fun)</li>
<li>module_exit(&lt;name_exit_fun&gt;)</li>
</ul>

<p>
This is the most simple example:
</p>
<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string">&lt;linux/init.h&gt;</span>
<span class="org-preprocessor">#include</span> <span class="org-string">&lt;linux/module.h&gt;</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">static: there can only be one instance of this functions</span>
<span class="org-keyword">static</span> <span class="org-type">int</span> <span class="org-function-name">hello_init</span>(<span class="org-type">void</span>)
{
  printk(KERN_ALERT <span class="org-string">"Hello Joe"</span>); <span class="org-comment-delimiter">// </span><span class="org-comment">can be read with dmsg</span>
  <span class="org-keyword">return</span> 0;
}

<span class="org-keyword">static</span> <span class="org-type">void</span> <span class="org-function-name">hello_exit</span>(<span class="org-type">void</span>)
{
  printk(KERN_ALERT <span class="org-string">"Good bye"</span>);
}

module_init(hello_init);    <span class="org-comment-delimiter">// </span><span class="org-comment">tell kernel to start here</span>
module_exit(hello_exit);    <span class="org-comment-delimiter">// </span><span class="org-comment">tell kernel to exit here</span>
</pre>
</div>

<p>
The next thing is to get a device number:
</p>
<div class="org-src-container">
<pre class="src src-cpp"><span class="org-comment-delimiter">// </span><span class="org-comment">called when the module is loaded</span>
<span class="org-keyword">static</span> <span class="org-type">int</span> <span class="org-function-name">__init</span> ModInit(<span class="org-type">void</span>)
{
   <span class="org-keyword">if</span>( register_chrdev(240, <span class="org-string">"Char driver test device"</span>, &amp;Fops)==0 )
   {
      printk(KERN_ALERT <span class="org-string">"Char driver registerd"</span>);
      <span class="org-keyword">return</span> 0;
   }
   printk(KERN_ALERT <span class="org-string">"Char driver major number already taken"</span>);
   <span class="org-keyword">return</span> -EIO;
}

<span class="org-keyword">static</span> <span class="org-type">void</span> <span class="org-function-name">__exit</span> ModExit(<span class="org-type">void</span>)
{
    unregister_chrdev(240, <span class="org-string">"Char driver test device"</span>);
    printk(KERN_ALERT <span class="org-string">"Char driver unregistered"</span>);
    <span class="org-keyword">return</span>;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org152608c" class="outline-4">
<h4 id="org152608c">Major and Minor Numbers</h4>
<div class="outline-text-4" id="text-org152608c">
<p>
One of the first things the driver has to do is to obtain one or more
device numbers using <code>register_chrdev</code> and <code>unregister_chrdev</code>.
</p>

<p>
The major number is used by the Kernel to identify a device driver.
The minor number is used internally by the driver itself.
</p>
</div>
</div>
<div id="outline-container-orgfc35d12" class="outline-4">
<h4 id="orgfc35d12">Communication between user space and kernel modules</h4>
<div class="outline-text-4" id="text-orgfc35d12">
<p>
The <i>file_operations</i> data structure (defined in linux/fs.h) contains
function pointers for various file operations, e.g. open(), close(), 
write(), read(), release(), etc.
</p>
</div>
</div>

<div id="outline-container-orga4b7cb8" class="outline-4">
<h4 id="orga4b7cb8">Character Devices</h4>
<div class="outline-text-4" id="text-orga4b7cb8">
<p>
Hardware is accessed via device files, i.e. it's accessed via ordinary
file operations like: open, read, write, lseek, mmap, close, etc.
There are character devices and block devices (slow vs. fast, also packet oriented).
<a href="https://linux-kernel-labs.github.io/master/labs/device_drivers.html">https://linux-kernel-labs.github.io/master/labs/device_drivers.html</a>
</p>

<p>
Character Devices are directly connected to the processor via the internal parallel 
system bus. 
</p>
</div>
</div>
</div>

<div id="outline-container-org5149c17" class="outline-3">
<h3 id="org5149c17">Debugging the Kernel</h3>
<div class="outline-text-3" id="text-org5149c17">
<p>
Build kernel with debug enabled (CONFIG_DEBUG_INFO=y).
Use <i>kgdb</i> for example.
</p>
</div>
</div>


<div id="outline-container-org215200e" class="outline-3">
<h3 id="org215200e"><span class="todo TODO">TODO</span> Device Tree</h3>
<div class="outline-text-3" id="text-org215200e">
<p>
A device tree is a tree data structure with nodes that describe
the physical devices in a system. It tells the kernel which driver
is responsible for the devices on a board and holds information for
that drivers.
</p>

<p>
Hardware description is no longer contained in the kernel but in a 
separate binary, the <code>device tree blob</code> (DTB).
</p>
</div>
</div>
<div id="outline-container-org7cef1e9" class="outline-3">
<h3 id="org7cef1e9"><span class="todo TODO">TODO</span> Signals</h3>
<div class="outline-text-3" id="text-org7cef1e9">
<p>
A signal allows the kernel to communicate asynchronously with a process.
</p>

<p>
Type <code>kill -l</code> to see which signals are available.
</p>
<pre class="example">
$ kill -l
 1) SIGHUP	 2) SIGINT	 3) SIGQUIT	 4) SIGILL
 5) SIGTRAP	 6) SIGABRT	 7) SIGBUS	 8) SIGFPE
 9) SIGKILL	10) SIGUSR1	11) SIGSEGV	12) SIGUSR2
13) SIGPIPE	14) SIGALRM	15) SIGTERM	16) SIGSTKFLT
17) SIGCHLD	18) SIGCONT	19) SIGSTOP	20) SIGTSTP
21) SIGTTIN	22) SIGTTOU	23) SIGURG	24) SIGXCPU
25) SIGXFSZ	26) SIGVTALRM	27) SIGPROF	28) SIGWINCH
29) SIGIO	30) SIGPWR	31) SIGSYS	34) SIGRTMIN
35) SIGRTMIN+1	36) SIGRTMIN+2	37) SIGRTMIN+3	38) SIGRTMIN+4
39) SIGRTMIN+5	40) SIGRTMIN+6	41) SIGRTMIN+7	42) SIGRTMIN+8
43) SIGRTMIN+9	44) SIGRTMIN+10	45) SIGRTMIN+11	46) SIGRTMIN+12
47) SIGRTMIN+13	48) SIGRTMIN+14	49) SIGRTMIN+15	50) SIGRTMAX-14
51) SIGRTMAX-13	52) SIGRTMAX-12	53) SIGRTMAX-11	54) SIGRTMAX-10
55) SIGRTMAX-9	56) SIGRTMAX-8	57) SIGRTMAX-7	58) SIGRTMAX-6
59) SIGRTMAX-5	60) SIGRTMAX-4	61) SIGRTMAX-3	62) SIGRTMAX-2
63) SIGRTMAX-1	64) SIGRTMAX	
</pre>
</div>
</div>
</div>


<div id="outline-container-orga944418" class="outline-2">
<h2 id="orga944418">GUI</h2>
<div class="outline-text-2" id="text-orga944418">
</div>
<div id="outline-container-org0d0573a" class="outline-3">
<h3 id="org0d0573a">General</h3>
<div class="outline-text-3" id="text-org0d0573a">
<ul class="org-ul">
<li><b>display server</b> :</li>
<li><b>compositor</b> : merges pixel buffers from various applications into one final buffer.</li>
<li><b>window manager</b> : takes care of stacking, focus, decoration etc.</li>
</ul>
</div>
</div>
<div id="outline-container-org9aa1946" class="outline-3">
<h3 id="org9aa1946">Wayland</h3>
<div class="outline-text-3" id="text-org9aa1946">
<p>
Wayland is a display server protocol for rendering windows on a bitmap.
</p>

<p>
It defines the communication between the display server (Wayland Compositor)
and the application windows (clients). 
</p>

<p>
The Wayland Compositor is both display server and window manager. 
</p>
</div>
</div>


<div id="outline-container-orgaea7f1f" class="outline-3">
<h3 id="orgaea7f1f">KDE Plasma</h3>
</div>
</div>

<div id="outline-container-orgdd2d567" class="outline-2">
<h2 id="orgdd2d567">Embedded Linux</h2>
<div class="outline-text-2" id="text-orgdd2d567">
</div>
<div id="outline-container-org9c74df3" class="outline-3">
<h3 id="org9c74df3">Linux System</h3>
<div class="outline-text-3" id="text-org9c74df3">
<p>
Using a build system (e.g. Yocto) we can build a Linux system from source code
with the following components:
</p>

<ul class="org-ul">
<li>bootloader (e.g. U-Boot)</li>
<li>kernel</li>
<li>user-space libraries: command line tools, graphics, network, etc.</li>
<li>user-space applications implementing business logic</li>
</ul>

<p>
Building a system image:
</p>
<ul class="org-ul">
<li>download, extract, patch, configure, build source code</li>
</ul>

<p>
Configure the kernel
</p>
<pre class="example">
make menuconfig
</pre>


<p>
Images:
</p>
<ul class="org-ul">
<li><code>u-boot.img</code></li>
<li><code>zImage</code> and Device Tree Blob <code>stm32mp157c-dk2.dtb</code></li>
</ul>

<p>
Root Filesystem:
</p>
<ul class="org-ul">
<li><code>ROOT_DEV</code> (byte 508)</li>
<li>minimal: <code>/dev/console</code> and <code>/bin/sh</code></li>
</ul>

<p>
Boot Process:
</p>
<ul class="org-ul">
<li>First stage bootloader is loaded by the SOC-Firmware. It then loads the</li>
<li>Second stage bootloader (<code>u-boot.img</code>) which loads the</li>
<li>Kernel image <code>zImage</code> and the Device Tree file <code>stm32mp157c-dk2.dtb</code>.</li>
<li>After that the kernel starts.</li>
<li>The root filesystem will be mounted.</li>
</ul>
</div>
</div>

<div id="outline-container-org23e0f8f" class="outline-3">
<h3 id="org23e0f8f">Yocto Project</h3>
<div class="outline-text-3" id="text-org23e0f8f">
<p>
Goal: Creation of tailored embedded Linux distributions. 
</p>

<ul class="org-ul">
<li>Separate Hardware dependent parts from higher level system.</li>
<li>Only change the Board Support Package (BSP).</li>
<li>Generate tailored toolchains for cross compilation and software development kits (SDKs).</li>

<li>Build system: OpenEmbedded</li>
<li>Reference Yocto Project: Poky</li>
</ul>
</div>

<div id="outline-container-org3d03759" class="outline-4">
<h4 id="org3d03759">Yocto Workflow</h4>
<div class="outline-text-4" id="text-org3d03759">
<ul class="org-ul">
<li>Build system: Bit Bake Engine</li>
</ul>

<p>
Bit Bake has to be feed with 
</p>
<ul class="org-ul">
<li>Metadata</li>
<li>Machine configuration (BSP)</li>
<li>Plicy Configuration</li>
</ul>

<p>
It will then fetch source code, compile and package the resulsts.
More detailed:
</p>
<ul class="org-ul">
<li>fetch</li>
<li>patch</li>
<li>configure and compile</li>
</ul>

<p>
At the end you'll get an image with the whole distribution. 
</p>
</div>
</div>

<div id="outline-container-org24cc24a" class="outline-4">
<h4 id="org24cc24a">Metadata</h4>
<div class="outline-text-4" id="text-org24cc24a">
<p>
You can find metadata folders on github. They don't contain any source. 
</p>

<ul class="org-ul">
<li>hardware (architecture)</li>
<li>Software Recipes (packages)</li>
<li>kernel version</li>
<li>source location (where to fetch it - typically from github)</li>
<li>how to build packages</li>
<li>how to put together the rootfs</li>
<li>how to boot the image</li>
</ul>
</div>
</div>

<div id="outline-container-orgeddd3ea" class="outline-4">
<h4 id="orgeddd3ea">Bitbake</h4>
<div class="outline-text-4" id="text-orgeddd3ea">
<p>
according to a recipe:
</p>
<ul class="org-ul">
<li>fetch</li>
<li>configure</li>
<li>compile</li>
<li>package</li>
<li>deploy</li>
</ul>
</div>
</div>

<div id="outline-container-org76292ef" class="outline-4">
<h4 id="org76292ef">Target Linux Boot Components</h4>
<div class="outline-text-4" id="text-org76292ef">
<ul class="org-ul">
<li>primary ROM Bootloader (on chip)</li>
<li>secondary bootloader SPL (SD Card - first 8k)</li>
<li>U-Boot (can boot the kernel)</li>
<li>Kernel</li>
<li>Device Tree</li>
<li>rootfs</li>
</ul>
</div>
</div>

<div id="outline-container-orge278121" class="outline-4">
<h4 id="orge278121">History</h4>
<div class="outline-text-4" id="text-orge278121">
<p>
<span class="timestamp-wrapper"><span class="timestamp">&lt;2020-11-05 Thu&gt; </span></span> <br />
<span class="timestamp-wrapper"><span class="timestamp">&lt;2020-09-16 Wed&gt; </span></span> <br />
<span class="timestamp-wrapper"><span class="timestamp">&lt;2016-07-15 Fri&gt;</span></span>
</p>
</div>
</div>
</div>

<div id="outline-container-orgbc8f4b4" class="outline-3">
<h3 id="orgbc8f4b4">U-Boot</h3>
</div>

<div id="outline-container-orgd4208c1" class="outline-3">
<h3 id="orgd4208c1">Embedded Linux Training (Bootlin)</h3>
<div class="outline-text-3" id="text-orgd4208c1">
</div>
<div id="outline-container-orgc5fa109" class="outline-4">
<h4 id="orgc5fa109">General Stuff</h4>
<div class="outline-text-4" id="text-orgc5fa109">
<p>
Free Software: it's free
</p>
<ul class="org-ul">
<li>for any purpose</li>
<li>to be changed</li>
<li>to redistribution</li>
<li>to redistribution of modified versions</li>
</ul>

<p>
Community support
</p>
<ul class="org-ul">
<li><code>blame</code></li>
</ul>

<p>
RiscV
</p>
<ul class="org-ul">
<li>free CPUs for FPGA</li>
</ul>

<p>
Linux might work on
</p>
<ul class="org-ul">
<li>4MB RAM (when using xip Flash)</li>
<li>4MB Flash</li>
</ul>

<p>
PocketBeagle
</p>
<ul class="org-ul">
<li>System on Module (CPU/RAM/flash)</li>
</ul>
</div>
<div id="outline-container-org00f0e05" class="outline-5">
<h5 id="org00f0e05">Free Software</h5>
<div class="outline-text-5" id="text-org00f0e05">
<ul class="org-ul">
<li>Freedom to run the software for any purpose</li>
<li>Freedom to study the software and to change it</li>
<li>Freedom to redistribute copies</li>
<li>Freedom to distribute copies of modified versions</li>
</ul>
</div>
</div>


<div id="outline-container-orge52e46a" class="outline-5">
<h5 id="orge52e46a">Links</h5>
<div class="outline-text-5" id="text-orge52e46a">
<ul class="org-ul">
<li>Embedded Linux Wiki: <a href="https://elinux.org/Main_Page">https://elinux.org/Main_Page</a></li>
<li><a href="https://github.com/bootlin/training-materials/">https://github.com/bootlin/training-materials/</a></li>
<li><a href="https://www.kernel.org/doc/">https://www.kernel.org/doc/</a></li>
<li>Browse Source: <a href="https://elixir.bootlin.com/linux/latest/source">https://elixir.bootlin.com/linux/latest/source</a></li>
<li>Blog: <a href="https://bootlin.com/">https://bootlin.com/</a></li>
<li><a href="https://linuxgizmos.com/">https://linuxgizmos.com/</a></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org11149b1" class="outline-4">
<h4 id="org11149b1">Embedded systems development</h4>
<div class="outline-text-4" id="text-org11149b1">
</div>
<div id="outline-container-org379d2c2" class="outline-5">
<h5 id="org379d2c2">Serial line communication</h5>
<div class="outline-text-5" id="text-org379d2c2">
<ul class="org-ul">
<li><code>picocom</code></li>
<li><code>ttyUSBx</code> : USB to serial converter</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgb5879fb" class="outline-4">
<h4 id="orgb5879fb">1. Cross compiling toolchains</h4>
<div class="outline-text-4" id="text-orgb5879fb">
<p>
Host System:
</p>
<ul class="org-ul">
<li>Cross compilation toolchain</li>
</ul>

<p>
Target System:
</p>
<ul class="org-ul">
<li>Interface: C library &lt;-&gt; Linux kernel</li>
<li>min. you need is: bootloader, kernel, C-library</li>
</ul>

<p>
Board Support Package develoment (BSP)
</p>
<ul class="org-ul">
<li>bootloader, kernel, drivers</li>
</ul>

<p>
Embedded System might be:
</p>
<ul class="org-ul">
<li>BSP</li>
<li>System (BSP + libraries + applications)</li>
<li>Applications (end user works here)</li>
</ul>

<p>
3 types of machine are used
</p>
<ul class="org-ul">
<li>(b)uild : here the toolchain is compiled</li>
<li>(h)ost</li>
<li>(t)arget</li>
</ul>

<p>
Canadian cross build: b, h, t are different
</p>
</div>

<div id="outline-container-org7f9abcd" class="outline-5">
<h5 id="org7f9abcd">Toolchain Components</h5>
<div class="outline-text-5" id="text-org7f9abcd">
<ul class="org-ul">
<li><code>binutils</code>
<ul class="org-ul">
<li><code>as</code> assambler</li>
<li><code>ld</code> linker</li>
<li><code>ar</code>, <code>ranlib</code> generate .a archives</li>
<li><code>objdump</code>, <code>readelf</code>, <code>size</code>, <code>nm</code>, <code>strings</code> - inspect binaries
<ul class="org-ul">
<li><code>size</code> show the size of sections</li>
<li><code>strings</code> show strings</li>
</ul></li>
<li><code>objcopy</code></li>
<li><code>strip</code> strip debugging parts from a binary</li>
</ul></li>
<li>Kernel Headers (<a href="https://elixir.bootlin.com/linux/latest/source/include">https://elixir.bootlin.com/linux/latest/source/include</a>)
<ul class="org-ul">
<li>system calls</li>
<li>Constant definitions</li>
<li>data structures</li>
<li>ABI (Application Binary Interface) is backward compatible</li>
</ul></li>
<li>Compiler 
<ul class="org-ul">
<li>GCC - GNU Compiler Collection</li>
<li>Clang (Backend: LLVM - Low Level Virtual Machine)</li>
</ul></li>
<li>C-Library
<ul class="org-ul">
<li>glibc, uClibs, newlib, etc. (<a href="https://www.etalabs.net/compare_libcs.html">https://www.etalabs.net/compare_libcs.html</a>)
<ul class="org-ul">
<li><code>glibc</code> : 2.23 MB</li>
<li><code>uClibc-ng</code> : 652 KB</li>
<li><code>musl</code> : static executables</li>
</ul></li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-orgfd510ff" class="outline-5">
<h5 id="orgfd510ff">Toolchain Options</h5>
<div class="outline-text-5" id="text-orgfd510ff">
<ul class="org-ul">
<li>ABI: choose the right <code>ABI</code> (<a href="https://en.wikipedia.org/wiki/Application_binary_interface">https://en.wikipedia.org/wiki/Application_binary_interface</a>), it defines
<ul class="org-ul">
<li>calling conventions</li>
<li>alignment</li>
<li>2 options for ARM: <code>OABI</code>, <code>EABI</code></li>
</ul></li>

<li>Floating point support
<ul class="org-ul">
<li><code>hard float</code> code: use hardware support</li>
<li><code>soft float code</code>: no hardware support, use a library</li>
</ul></li>

<li>CPU optimization flags
<ul class="org-ul">
<li>architecture (ARM, x86, MIPS, PowerPC)</li>
<li>gcc options (<a href="https://gcc.gnu.org/onlinedocs/gcc/ARM-Options.html">https://gcc.gnu.org/onlinedocs/gcc/ARM-Options.html</a>):
<ul class="org-ul">
<li><code>-march</code> : instruction set (<code>-march=armv7</code></li>
<li><code>-mtune</code> : optimize code for specific CPU (<code>-mtune=cortex-a8</code>)</li>
</ul></li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-org3c5ec6a" class="outline-5">
<h5 id="org3c5ec6a">How to get a Toolchain?</h5>
<div class="outline-text-5" id="text-org3c5ec6a">
</div>
<div id="outline-container-orgf148b6a" class="outline-6">
<h6 id="orgf148b6a">Build a toolchain manually</h6>
<div class="outline-text-6" id="text-orgf148b6a">
<p>
difficult
</p>
</div>
</div>
<div id="outline-container-org9a66cdd" class="outline-6">
<h6 id="org9a66cdd">Get precompiled toolchain</h6>
<div class="outline-text-6" id="text-org9a66cdd">
<ul class="org-ul">
<li><p>
easy but you can't fine-tune
Example:
</p>
<pre class="example">
sudo apt install gcc-arm-linux-gnueabihf
</pre></li>
</ul>
</div>
</div>
<div id="outline-container-org58e54ce" class="outline-6">
<h6 id="org58e54ce">Toolchain building tools (toolchain generator)</h6>
<div class="outline-text-6" id="text-org58e54ce">
<ul class="org-ul">
<li>Crosstool-ng</li>
</ul>

<p>
root filesystem build systems:
</p>
<ul class="org-ul">
<li>buildroot (glibc, uClibc, musl)</li>
<li>PTXdist (uClibc glibc)</li>
<li>OpemEmbedded /Yocto Project</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgf5e0675" class="outline-5">
<h5 id="orgf5e0675">Cross-compile applications and libraries</h5>
</div>
<div id="outline-container-org04305af" class="outline-5">
<h5 id="org04305af">auto-tools</h5>
</div>
</div>

<div id="outline-container-orge7a548b" class="outline-4">
<h4 id="orge7a548b">2. Bootloaders</h4>
<div class="outline-text-4" id="text-orge7a548b">
<ul class="org-ul">
<li>basic hardware init</li>
<li>load kernel</li>
<li>provide shell with basic commands</li>
</ul>
</div>

<div id="outline-container-org70d37c7" class="outline-5">
<h5 id="org70d37c7">Boot Sequence</h5>
<div class="outline-text-5" id="text-org70d37c7">
<p>
x86
</p>
<ul class="org-ul">
<li>typically there is a BIOS
<ul class="org-ul">
<li>1st Stage: 512 bytes at a fixed location on the first disk</li>
<li>2nd Stage:</li>
</ul></li>
</ul>

<p>
GRUB
</p>

<p>
embedded Booting case 2
</p>
<ul class="org-ul">
<li>boot code in ROM</li>
</ul>

<p>
Falcon mode: skip U-Boot and directly boot Linux Kernel from U-Boot SPL.
</p>

<p>
Generic bootloaders for embedded CPUs:
</p>
<ul class="org-ul">
<li>U-Boot</li>
<li>Barebox</li>
<li>LK (Little Kernel), used on Android</li>
</ul>
</div>
</div>

<div id="outline-container-org41875c7" class="outline-5">
<h5 id="org41875c7">U-Boot</h5>
<div class="outline-text-5" id="text-org41875c7">
<ul class="org-ul">
<li>Source: <a href="https://elixir.bootlin.com/u-boot/latest/source">https://elixir.bootlin.com/u-boot/latest/source</a></li>
<li>Tutorial: <a href="https://www.youtube.com/watch?v=INWghYZH3hI&amp;t=1313s">https://www.youtube.com/watch?v=INWghYZH3hI&amp;t=1313s</a></li>
</ul>

<p>
Comments:
</p>
<ul class="org-ul">
<li>Make environment derived from Linux Kernel.</li>
<li><code>configs/</code> directory : contains configuration files for each board</li>
</ul>
</div>

<div id="outline-container-org7821e1e" class="outline-6">
<h6 id="org7821e1e">Making U-Boot</h6>
<div class="outline-text-6" id="text-org7821e1e">
<p>
Result:
</p>
<ul class="org-ul">
<li><code>spl/u-boot-spl.bin</code> U-Boot SPL image. Goes e.g. to the first partition.</li>
<li><code>u-boot.bin</code> U-Boot image.</li>
</ul>

<p>
Same procedure as always:
(Configuration stored in <code>.config</code>)
</p>
<pre class="example">
make menuconfig
make DEVICE_TREE=stm32mp157c-dk2
</pre>

<p>
(requires the device tree compiler to be installed)
</p>

<p>
Usually there are 3 partitions: 
</p>
<ol class="org-ol">
<li>U-Boot SPL</li>
<li>U-Boot</li>
<li>U-Boot Environment</li>
</ol>
</div>
</div>

<div id="outline-container-org4ecda37" class="outline-6">
<h6 id="org4ecda37">Commands</h6>
<div class="outline-text-6" id="text-org4ecda37">
<p>
good command: <code>bdinfo</code>, RAM addresses
</p>

<p>
<b>Environment Variables</b>
</p>
<ul class="org-ul">
<li><code>setenv</code>   : set environment variables</li>
<li><code>printenv &lt;VARIABLE&gt;</code> : print environment variables</li>
<li><code>saveenv</code>  : save environment variables to persistent storage</li>
</ul>
<p>
Comment:
</p>
<ul class="org-ul">
<li><p>
You can store scripts in variables.
</p>
<pre class="example">
setenv myVar 'nand read 0x22000000 0x180000 0x20000;nand read 0x21000000 0x1a0000 0x500000;bootz 0x21000000 - 0x22000000;'
</pre>

<ul class="org-ul">
<li>Be careful, there might be hidden characters when copying.</li>
</ul></li>
</ul>

<p>
<b>Memory Commands</b>
</p>
<ul class="org-ul">
<li><code>cmp</code> : memory compare</li>
<li><code>cp</code>  : memory copy</li>
<li><code>md</code>  : memory display</li>
<li><code>mm</code>  : memory modify (auto-incrementing)</li>
</ul>

<p>
<b>File System Access</b>
</p>
<ul class="org-ul">
<li><code>ls mmc 0:4</code> - list all files on partition 4 of sd card</li>
</ul>

<p>
<b>Transfer files</b>
</p>
<ul class="org-ul">
<li><code>serial</code></li>
<li><code>tftp 0x21000000 zImage</code> :  transfer file to ram address</li>
</ul>
</div>
</div>
</div>
</div>

<div id="outline-container-orgfabd382" class="outline-4">
<h4 id="orgfabd382">3. Linux Kernel</h4>
<div class="outline-text-4" id="text-orgfabd382">
<p>
Kernel header files are typically not used be user code but only
indirectly via C-Library headers.
</p>

<p>
Why create Kernel drivers? (instead of user space ones)
</p>
<ul class="org-ul">
<li>applications dont have to change when hardware changes</li>
<li>but: you have to recompile the kernel</li>
<li>Elixir Cross Referencer: <a href="https://github.com/bootlin/elixir">https://github.com/bootlin/elixir</a></li>
<li>~400 system calls: <a href="https://de.wikipedia.org/wiki/Liste_der_Linux-Systemaufrufe">https://de.wikipedia.org/wiki/Liste_der_Linux-Systemaufrufe</a></li>
</ul>

<p>
Virtual Filesystems
</p>
<ul class="org-ul">
<li>created by the kernel (e.g. <code>cat /proc/uptime</code>)</li>
</ul>

<p>
important VFSs:
</p>
<ul class="org-ul">
<li><code>proc</code> : OS related info</li>
<li><code>sysfs</code> : representation of system as devices and buses</li>
</ul>

<p>
Parts of the Kernel:
</p>
<ul class="org-ul">
<li>Memory Management</li>
<li>Scheduler</li>
<li>Filesystem</li>
<li>Device drivers</li>
<li>Network stack</li>
<li>Low level code</li>
</ul>

<p>
One monolithic C-program (not micro kernel).
</p>
</div>

<div id="outline-container-org7229b27" class="outline-5">
<h5 id="org7229b27">Versioning scheme</h5>
<div class="outline-text-5" id="text-org7229b27">
<p>
5.1.12 (Version.Patchlevel.Sublevel see Makefile in the source)
</p>

<ul class="org-ul">
<li>New stable release every ~10 weeks.</li>
<li>5.0, 5.1, etc.</li>
<li>Bugfixes and security updates: 5.0.1, 5.0.2, etc.</li>
<li>longterm releases are supported for a longer time (~6 years).</li>
<li>Civil Infrastructure Platform project (very long time support).</li>
<li>CVE (Common Vulnerabilities and Exposures): <a href="https://cve.mitre.org/cgi-bin/cvekey.cgi?keyword=linux">https://cve.mitre.org/cgi-bin/cvekey.cgi?keyword=linux</a></li>
<li>Changes: <a href="https://kernelnewbies.org/LinuxChanges">https://kernelnewbies.org/LinuxChanges</a></li>
</ul>

<p>
Comments:
</p>
<ul class="org-ul">
<li>You can update a version until a LTS version is reached and then stop.</li>
<li>Some security fixes will be fixed without CVE.</li>
<li>Test: Linux Test Project</li>
</ul>
</div>
</div>

<div id="outline-container-org1da8443" class="outline-5">
<h5 id="org1da8443">Sources</h5>
<div class="outline-text-5" id="text-org1da8443">
<ul class="org-ul">
<li>Git Online: <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?h=master">https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?h=master</a></li>
<li>Source: <a href="https://elixir.bootlin.com/linux/latest/source">https://elixir.bootlin.com/linux/latest/source</a></li>
<li>Fun: <a href="https://www.youtube.com/watch?v=MkJxlKD2bjk&amp;ab_channel=DarrickWong">https://www.youtube.com/watch?v=MkJxlKD2bjk&amp;ab_channel=DarrickWong</a></li>
</ul>

<p>
Free GIT-Book
</p>
<ul class="org-ul">
<li><a href="https://git-scm.com/">https://git-scm.com/</a></li>
</ul>

<p>
Patching:
</p>
<ul class="org-ul">
<li>generated by <code>diff</code> tool, <code>git</code></li>
<li><p>
run patch on top level directory:
patch-5.8.xz and linux-5.7 are on the same level
</p>
<pre class="example">
cd linux-5.7
xzcat ../patch-5.8.xz | patch -p1
</pre></li>
</ul>
</div>
</div>

<div id="outline-container-orga783aed" class="outline-5">
<h5 id="orga783aed">Build Kernel</h5>
<div class="outline-text-5" id="text-orga783aed">
<p>
Overall Procedure:
</p>
<ol class="org-ol">
<li>ARCH=arm</li>
<li>export CROSS_COMPILE=arm-linux-</li>
<li>make stm32mp1_defconfig</li>
<li>make menuconfig</li>
<li>make -j 16</li>
</ol>
</div>

<div id="outline-container-org31f1539" class="outline-6">
<h6 id="org31f1539">Configuration</h6>
<div class="outline-text-6" id="text-org31f1539">
<p>
<a href="https://www.linuxjournal.com/article/6568">https://www.linuxjournal.com/article/6568</a>
</p>

<ul class="org-ul">
<li>Target <code>/arch</code></li>
<li><code>/arch/arm/Kconfig</code> : export ARCH=arm (otherwise it will be built for x86)</li>
<li>stored in  <code>.config</code></li>
<li>see current config: <code>view /boot/config-5.4.0-48-generic</code></li>
</ul>

<p>
Comments:
</p>
<ul class="org-ul">
<li>Changing <code>.config</code> by hand might break dependencies. 
<ul class="org-ul">
<li>better: menuconfig, or graphical tools</li>
</ul></li>
<li><p>
Copy current config
</p>
<pre class="example">
cp /boot/config-`uname -r` .config
</pre></li>
</ul>

<p>
Set $ARCH - variable:
</p>
<pre class="example">
export ARCH= arm
</pre>


<p>
List available conifg files for arm (ARCH needs to be arm)
</p>
<pre class="example">
make help | grep defconfig
</pre>

<p>
or
</p>
<pre class="example">
make ARCH=arm help
</pre>


<p>
See <code>linux-4.18/Documentation/Changes</code> for the required gcc version. 
</p>
</div>
<ul class="org-ul">
<li><a id="orgcdc3654"></a>Kernel Makefiles<br />
<div class="outline-text-7" id="text-orgcdc3654">
<p>
The makefiles build only those files that are required by the configuration
options. 
</p>

<p>
Driver Options in the Makefile:
</p>
<pre class="example">
bj-$(CONFIG_USB_NET_CH9200)    += ch9200.o
</pre>


<p>
If CONFIG_USB_NET_CH9200 is set to m, a module will be build, otherwise
it's built into the kernel directly (if set to y).
</p>
</div>
</li>
</ul>
</div>

<div id="outline-container-orgce5dd07" class="outline-6">
<h6 id="orgce5dd07">Compiling and installing the kernel</h6>
<div class="outline-text-6" id="text-orgce5dd07">
<p>
compiler used be make: <code>$(CROSS_COMPILE)gcc</code>
<code>CROSS_COMPILE</code> is the prefix for all cross compiling tools: gcc, ld, as, objcopy, strip, &#x2026;
</p>

<pre class="example">
export ARCH=arm
export CROSS_COMPILE=arm-linux-
</pre>


<p>
make with multiple jobs
</p>
<pre class="example">
make -j 8
</pre>


<p>
This generates:
</p>
<ul class="org-ul">
<li><code>arch/arm/boot/zImage</code> bootable image</li>
<li><code>arch/arm/boot/dts/*.dtb</code> compiled device tree</li>
<li><code>.ko</code> files for modules, all over the tree (will be installed later)</li>
<li><code>vmlinux</code> (for debugging, cannot be booted)</li>
</ul>

<p>
Installation (PC)
</p>
<pre class="example">
make install
</pre>

<p>
deploy kernel to <code>/boot/vmlinuz-5.4.0-48-generic</code>
</p>

<p>
Embedded
</p>
<ul class="org-ul">
<li>deploy by hand</li>
</ul>

<pre class="example">
make module_install
</pre>

<p>
installs modules to <code>/lib/modules/&lt;version&gt;/</code>
</p>

<p>
Embedded
</p>
<ul class="org-ul">
<li>dont execute <code>make module_install</code>, it will install modules on the host</li>
</ul>
<pre class="example">
make INSTALL_MOD_PATH=&lt;dir&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfe4922b" class="outline-5">
<h5 id="orgfe4922b">Booting the Kernel</h5>
<div class="outline-text-5" id="text-orgfe4922b">
</div>
<div id="outline-container-org331c31d" class="outline-6">
<h6 id="org331c31d">Device Tree</h6>
<div class="outline-text-6" id="text-org331c31d">
<p>
Tells the kernel about non-detectable devices (leds, adc, i2c devices, &#x2026;)
on a specific board.
</p>

<p>
Instead of a board.c file, so no recompiling of the kernel is needed. 
</p>

<p>
Device tree source are typically stored in the kernel sources.
They are compiled into a Device Tree Blob (<code>.dtb</code> file).
</p>

<p>
The kernel will bind a driver to each device listed in the device tree. 
</p>
<pre class="example">
compatible = "focaltech,ft6236";
</pre>


<p>
Bootloader passes argumnets and the device tree address to the kernel. 
</p>

<p>
On ARM the device tree is represented in the filesystem:
</p>
<ul class="org-ul">
<li><code>/sys/firmware/devicetree/base</code></li>

<li>Tool: <a href="http://linux.tanzilli.com/">http://linux.tanzilli.com/</a></li>
<li>STM32MP1: <a href="https://wiki.st.com/stm32mpu/wiki/Device_tree">https://wiki.st.com/stm32mpu/wiki/Device_tree</a></li>
<li>Reference: <a href="https://elinux.org/Device_Tree_Reference">https://elinux.org/Device_Tree_Reference</a></li>
<li>Usage: <a href="https://elinux.org/Device_Tree_Usage">https://elinux.org/Device_Tree_Usage</a></li>
</ul>
</div>
</div>

<div id="outline-container-org12bdcf6" class="outline-6">
<h6 id="org12bdcf6">Booting with U-Boot</h6>
<div class="outline-text-6" id="text-org12bdcf6">
<ul class="org-ul">
<li><code>zImage</code> directly booted (to be found in <code>acrch/arm/boot</code>).</li>
<li>U-Boot can pass a Device Tree Blob to the kernel (DTB address via register
r2)</li>
</ul>

<p>
Exemple:
</p>
<pre class="example">
ext2load mmc 0:4 0xc0000000 zImage
ext2load mmc 0:4 0xc4000000 stm32mp157a-dk1.dtb
bootz 0xc0000000 - 0xc4000000
</pre>

<p>
Load <code>zImage</code> at address X.
Load <code>&lt;board&gt;.dtb</code> at address &gt;
</p>

<p>
<b>kernel command line</b>
</p>
<ul class="org-ul">
<li><code>Documentation/admin-guide/kernel-parameters.txt</code></li>
<li>string defining various arguments</li>
</ul>
<pre class="example">
console=ttyS0, root=/dev/mmcblk0p2 rootwait, loglevel=5
</pre>


<p>
Ubuntu: <code>cat /proc/cmdline</code>
</p>

<p>
Docu: <a href="https://www.kernel.org/doc/html/latest/admin-guide/kernel-parameters.html">https://www.kernel.org/doc/html/latest/admin-guide/kernel-parameters.html</a>
</p>
</div>

<ul class="org-ul">
<li><a id="orgcc29d2b"></a>Flash Kernel and dtb to NAND flash<br />
<div class="outline-text-7" id="text-orgcc29d2b">
<ul class="org-ul">
<li>write with tftp to ram</li>
<li>erase NAND sectors : <code>nand erase 0x180000 0x20000</code></li>
<li>write from ram to flash : <code>nand write 0x22000000 0x180000 0x20000</code> (RAM-addr NAND-off set size)</li>
</ul>

<p>
Commands for reading back from nand to ram:
</p>
<pre class="example">
nand read 0x22000000 0x180000 0x20000 (RAM-addr off set size )
nand read 0x21000000 0x1a0000 0x500000
bootz 0x21000000 - 0x22000000
</pre>

<p>
This has to be put to the <code>bootcmd</code> variable. 
</p>
</div>
</li>
</ul>
</div>

<div id="outline-container-orgc081657" class="outline-6">
<h6 id="orgc081657">Modules</h6>
<div class="outline-text-6" id="text-orgc081657">
<p>
In embedded environments you can do without modules.
The are mostly used for faster booting.
</p>

<ul class="org-ul">
<li><code>/boot/initrd.img</code> initial temporary filesystem in ram (rd&#x2026;ramdisk)</li>

<li>modules can do everything</li>
<li>use signed modules for security or disable module loading (kernel lockdown mode)</li>
<li><code>modinfo &lt;module_name</code></li>
</ul>

<p>
Insert a module into the kernel
</p>
<pre class="example">
sudo insmod ./intr_monitor.ko
</pre>

<p>
Loads all modules &lt;module_name&gt; depends on:
</p>
<pre class="example">
sudo modprobe &lt;module_name&gt;
</pre>


<p>
List loaded modules:
</p>
<ul class="org-ul">
<li><code>lsmod</code> or <code>/proc/modules</code></li>
</ul>

<p>
Remove modele
</p>
<pre class="example">
sudo rmmod &lt;module_name&gt;
sudo modprobe -r &lt;module_name&gt;
</pre>


<p>
Passing parameters to modules:
set in  <code>/etc/modprobe.conf</code>
or <code>/etc/modprobe.d/</code>
</p>

<p>
Even when the module is built statically, parameters can be passed
through the kernel command line.
</p>

<p>
Dependencies can be viewed in the file:
</p>
<ul class="org-ul">
<li><code>/lib/modules/&lt;kernel-version&gt;/modules.dep</code></li>
</ul>

<p>
Kernel Log
</p>
<ul class="org-ul">
<li><code>dmesg</code> (diagnostic message) - write with <code>printk()</code></li>
<li>can also write from user space <code>echo "&lt;n&gt;Debug info" &gt; /dev/kmsg</code></li>
<li><code>loglevel</code> kernel command line parameter (max = 8)</li>
</ul>
</div>
</div>
</div>
</div>

<div id="outline-container-org7f7d5c1" class="outline-4">
<h4 id="org7f7d5c1">4. Root Filesystem</h4>
<div class="outline-text-4" id="text-org7f7d5c1">
<p>
All sorts of filesystems can be mounted in the global hierachy.
Applications don't need to know where something is really stored. 
</p>

<p>
The device file in <code>/dev</code> is actually the 0s and 1s. 
</p>

<p>
Mount command:
</p>
<pre class="example">
sudo mount -t vfat /dev/sda1 /mnt/usbkey
</pre>


<p>
Show all mounted filesystems:
</p>
<pre class="example">
mount
</pre>


<p>
Show all supported filesystems: 
</p>
<pre class="example">
cat /proc/filesystems
</pre>


<p>
<code>/</code> is the root filesystem
</p>
<ul class="org-ul">
<li>its mounted by the kernel (cannot be unmounted) according to the root= argument</li>
</ul>

<p>
Partitions on HD or USB key:
</p>
<ul class="org-ul">
<li><code>/dev/sdXY</code> : X is a letter for the device, Y is the number of the partition</li>
</ul>

<p>
Partitions on SD cards
</p>
<ul class="org-ul">
<li><code>/dev/mmcblkXpY</code> : X - device, Y - partition</li>
</ul>

<p>
Partitions on flash storage
</p>
<ul class="org-ul">
<li><code>/dev/mtdblockX</code> : X - partition</li>
</ul>

<p>
<code>root=/dev/sdb2</code> is just a naming convention (it's not mounted yet!)
</p>
</div>

<div id="outline-container-org8c82bdb" class="outline-5">
<h5 id="org8c82bdb">Mounting rootfs over the network</h5>
<div class="outline-text-5" id="text-org8c82bdb">
<p>
NFS (Network File System)
</p>

<p>
Install server
</p>
<pre class="example">
sudo apt install nfs-kernel-server
</pre>

<p>
Add exported directory to 
</p>
<pre class="example">
/etc/exports
/home/tux/rootfs 192.168.1.*(rw,no_root_squash,no_subtree_check)
</pre>


<ul class="org-ul">
<li>192.168.1.* authorized client IP address</li>
<li><code>no_root_squash</code></li>
<li><code>no_subtree_check</code></li>
</ul>

<p>
Restart server
</p>
<pre class="example">
sudo /etc/init.d/nfs-kernel-server restart
</pre>


<p>
Client:
</p>
<ul class="org-ul">
<li>CONFIG_NFS_FS=y</li>
<li>CONFIG_IP_PNP=y (static ip address)</li>
<li>CONFIG_ROOT_NFS=y</li>
</ul>

<p>
Boot parameters:
<code>root=/dev/nfs</code>
</p>
</div>
</div>

<div id="outline-container-org8e3bcf9" class="outline-5">
<h5 id="org8e3bcf9">initramfs</h5>
<div class="outline-text-5" id="text-org8e3bcf9">
<p>
<code>rootfs</code> in memory
</p>
<ul class="org-ul">
<li>no drivers needed</li>
</ul>
</div>
</div>

<div id="outline-container-org8a64d1b" class="outline-5">
<h5 id="org8a64d1b">Root FS organization</h5>
<div class="outline-text-5" id="text-org8a64d1b">
<p>
<code>/bin</code> : basic programs (bash, ls, cp, etc.)
<code>/boot</code> : Kernel images, configurations and initramfs
<code>/dev</code> : devices
<code>/lib</code> : Basic libraries, C library
<code>/media</code> : removable media
<code>/sys</code> : sysfs virtual filesystem
<code>/usr/bin</code> : non-basic programms
<code>/usr/lib</code> : non-basic libs
<code>/usr/sbin</code> : non-basic
<code>/var</code> : logging, variable data files
</p>
</div>

<div id="outline-container-org9d735e2" class="outline-6">
<h6 id="org9d735e2">Device Files <code>/dev</code></h6>
<div class="outline-text-6" id="text-org9d735e2">
<p>
Everything is a file, except network devices (not in /dev)
</p>
<ul class="org-ul">
<li>file API: <code>open</code>, <code>read</code>, <code>write</code>, <code>close</code></li>

<li>Character device : stream of bytes (serial port, sound card,
frame buffer, video, etc.)</li>
<li>Block device : fixed size blocks (HD, USB, SD card)</li>
</ul>

<p>
Internally the kernel uses:
</p>
<ul class="org-ul">
<li>Type (character or block)</li>
<li>Major Nr. (category)</li>
<li>Minor Nr. (identifier)</li>
</ul>

<p>
Examples:
</p>

<p>
Block device:
</p>
<pre class="example">
ls -l sda
brw-rw---- 1 root disk 8, 0 Oct  1 03:26 sda
</pre>

<p>
(notice the "b", 8-major nr., 0-minor nr.)
</p>

<p>
Character device:
</p>
<pre class="example">
ls -l tty1
crw--w---- 1 root tty 4, 1 Oct  1 03:26 tty1
</pre>
</div>
</div>

<div id="outline-container-org357cb84" class="outline-6">
<h6 id="org357cb84"><code>/proc</code> virtual filesystem</h6>
<div class="outline-text-6" id="text-org357cb84">
<ul class="org-ul">
<li>system information: statistics processes (ps, top)</li>
<li><code>Documentation/filesystems/proc.txt</code></li>
</ul>

<p>
General device information:
</p>
<ul class="org-ul">
<li><code>/proc/interrupts</code>, <code>proc/iomem</code>, <code>/proc/iports</code></li>
</ul>

<p>
for each running process
</p>
<ul class="org-ul">
<li><code>/proc/&lt;pid&gt;</code></li>
<li><code>/proc/3840/cmdline</code></li>
</ul>

<p>
Check with sudo:
</p>
<pre class="example">
sudo cat /proc/iomem
sudo cat /proc/cmdline
</pre>
</div>
</div>

<div id="outline-container-org7041081" class="outline-6">
<h6 id="org7041081">sysfs filesystem <code>/sys</code></h6>
<div class="outline-text-6" id="text-org7041081">
<p>
see by groups:
</p>
<pre class="example">
cd /sys/class
</pre>


<p>
Plenty of information about devices. 
</p>
</div>
</div>
</div>
<div id="outline-container-org7972a17" class="outline-5">
<h5 id="org7972a17">Basic applications</h5>
<div class="outline-text-5" id="text-org7972a17">
<p>
Linux needs at least a few applications:
</p>
<ul class="org-ul">
<li><code>init</code> : starts all other user space applications</li>
<li>shell</li>
<li>basic commands: <code>mv</code>, <code>cp</code>, <code>mkdir</code>, <code>cat</code>, <code>modprobe</code>, <code>mount</code>, <code>ip</code>, etc.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orga973654" class="outline-4">
<h4 id="orga973654">5. Busybox</h4>
<div class="outline-text-4" id="text-orga973654">
<p>
Executable file providing Unix utilities of about 300 common
commands. 
</p>

<ul class="org-ul">
<li>One single binary in <code>/bin/busybox</code> (build it statically!).</li>
<li>Highly configurable (can be as small as ~300KB).</li>
<li>architecture independent</li>
</ul>

<p>
Configuration:
</p>
<pre class="example">
make defconfig
make allnoconfig
make menuconfig
</pre>

<p>
Build:
</p>
<pre class="example">
make
</pre>

<p>
Install:
</p>
<pre class="example">
make install
</pre>


<p>
Configuration file:
</p>
<pre class="example">
/etc/inittab
</pre>
</div>

<div id="outline-container-orgc947f1b" class="outline-5">
<h5 id="orgc947f1b">Minimal filesystem</h5>
<div class="outline-text-5" id="text-orgc947f1b">
<ul class="org-ul">
<li><code>init</code> <a href="https://en.wikipedia.org/wiki/Init">https://en.wikipedia.org/wiki/Init</a>
also takes care of zombie-processes</li>
<li>shell <code>tty</code> (stands for TeleTYpewriter)</li>
</ul>

<p>
From <code>initramfs</code> we can switch to another root fs with the commmand =switch_
</p>
</div>
</div>
</div>
<div id="outline-container-org1956e3f" class="outline-4">
<h4 id="org1956e3f">6. Block Filesystems</h4>
<div class="outline-text-4" id="text-org1956e3f">
<p>
Block devices vs. flash devices.
</p>

<p>
Block Devices
</p>
<ul class="org-ul">
<li>per-block read/write</li>
<li>HD, RAM disk</li>
<li>USB Stick, SSD, SD Card, eMMC 
<ul class="org-ul">
<li>Those are actually based on flash, but the controller
abstracts that away.</li>
</ul></li>
</ul>

<p>
Partition device is stored in the Master Boot Record (MBR).
Newer format: GPT (&gt; 2TB)
</p>

<p>
Tools: <code>fdisk</code>, <code>cfdisk</code>, <code>sfdisk</code>, <code>parted</code>, etc. 
</p>
<ul class="org-ul">
<li><code>cfdisk</code> interactive</li>
<li><code>sfdisk</code> good for scripting</li>
</ul>

<p>
Transfer data
</p>
<ul class="org-ul">
<li>bypass filesystem layer</li>
<li>block devices in <code>/dev</code> allow raw access</li>
<li><p>
<code>dd</code> (Disk Duplicate)
</p>
<pre class="example">
dd if=/dev/mmcblk0p1 of=testfile bs=1M count=16
</pre>

<p>
(transfer 16 blocks of 1 MB to file)
</p>
<pre class="example">
dd if=testfile of=/dev/sda2 bs=1M seek=4
</pre>

<p>
(start at 4 blocks)
Typical ERROR: don't copy files like that:
</p>
<pre class="example">
dd if=zImage of=/dev/sda1
</pre>

<p>
Do it like this:
</p>
<pre class="example">
sudo mount /dev/sda1 /boot
cp zImage /boot/
</pre></li>
</ul>

<p>
Journaled filesystems:
</p>
<ul class="org-ul">
<li>sudden power out</li>
<li>writes go to a journal first</li>
<li><code>btrfs</code> (to be the next standard in linux), <code>reiserFS</code></li>
</ul>

<p>
F2FS: FS for flash-based storage
</p>
<ul class="org-ul">
<li>take into account internal details</li>
</ul>

<p>
SquashFS: read-only FS
</p>
<ul class="org-ul">
<li>compressed</li>
<li>used in live CDs and USB distributions</li>
<li>alternative: EROFS (Enhanced Read Only Filesystem)</li>
</ul>

<p>
tmpfs: filesystem in RAM
</p>
<pre class="example">
mount -t tmpfs run /var/run
</pre>

<ul class="org-ul">
<li>for files you don't need to keep</li>
</ul>
</div>

<div id="outline-container-orgf156296" class="outline-5">
<h5 id="orgf156296">Wear Leveling</h5>
<div class="outline-text-5" id="text-orgf156296">
<ul class="org-ul">
<li>Dynamisches Wear Leveling fasst gelöschte Blöcke zusammen und 
selektiert den Block mit der niedrigsten Löschungsrate für den 
nächsten Schreibprozess.</li>
<li>Statisches Wear Leveling wählt den Zielblock mit der allgemeinen 
niedrigsten Löschungsrate aus und löscht den Block bei Bedarf.</li>
</ul>
</div>
</div>
<div id="outline-container-org6cf4d4d" class="outline-5">
<h5 id="org6cf4d4d">Using block filesystems</h5>
<div class="outline-text-5" id="text-org6cf4d4d">
<p>
Create extX filesystems
</p>
<pre class="example">
mkfs.ext2 /dev/hda3
</pre>


<p>
<code>genext2fs</code> tool
</p>
<ul class="org-ul">
<li>Create a fs image from a directory</li>
</ul>
<pre class="example">
genext2fs -d rootfs/ rootfs.img
</pre>


<p>
loop mechanism
</p>
<ul class="org-ul">
<li>mount a rootfs on the development desktop</li>
<li>on desktop not needed anymore, can mount directly</li>
</ul>

<p>
<code>squashfs-tools</code>
</p>
<pre class="example">
mksquashfs rootfs/ rootfs.sqfs -noappend
</pre>
</div>
</div>
</div>

<div id="outline-container-org94ad821" class="outline-4">
<h4 id="org94ad821">7. Flash Filesystems</h4>
<div class="outline-text-4" id="text-org94ad821">
<p>
Flash devices
</p>
<ul class="org-ul">
<li>erase before writing</li>
</ul>
</div>

<div id="outline-container-org550a2e7" class="outline-5">
<h5 id="org550a2e7">NAND flash chips</h5>
<div class="outline-text-5" id="text-org550a2e7">
<ul class="org-ul">
<li>Single Level Cell (1 bit / cell)</li>
<li>Multi Level Cell (n bits / cell)</li>
<li>init: all bits 1</li>
<li>write means changing from 1 to 0</li>
<li>restoring to 1 is ERASE</li>
<li>page / block (e.g. 4k / 64k)</li>
<li>less reliable than NOR flash</li>
<li>ECC (Error Correcting Code)
<ul class="org-ul">
<li>stored in out band area</li>
</ul></li>
<li>in band / out band data</li>
</ul>
</div>
</div>

<div id="outline-container-org9ed48c9" class="outline-5">
<h5 id="org9ed48c9">MTD (Memory Technology Devices)</h5>
<div class="outline-text-5" id="text-org9ed48c9">
<p>
<a href="http://www.linux-mtd.infradead.org/">http://www.linux-mtd.infradead.org/</a>
</p>

<ul class="org-ul">
<li>Abstraction for RAM, ROM, NOR/NAND flash, etc.</li>
<li>devices not in the block subsystem.</li>
</ul>

<p>
Levels:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">MTD User modules (UBI, Block, char, etc. devices)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">MTD Chip drivers</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">Hardware</td>
</tr>
</tbody>
</table>
</div>

<div id="outline-container-org9c4de6c" class="outline-6">
<h6 id="org9c4de6c">MTD partitioning</h6>
<div class="outline-text-6" id="text-org9c4de6c">
<ul class="org-ul">
<li>Unlike block device, partition table is stored externally.
So, it needs to be stored in:
<ul class="org-ul">
<li>device tree</li>
<li>kernel</li>
<li>kernel command line</li>
</ul></li>

<li>Each partition becomes a separate device.</li>
</ul>
</div>
</div>

<div id="outline-container-org35bf694" class="outline-6">
<h6 id="org35bf694">U-Boot</h6>
<div class="outline-text-6" id="text-org35bf694">
</div>
<ul class="org-ul">
<li><a id="orgd694875"></a>Partitioning<br />
<div class="outline-text-7" id="text-orgd694875">
<ul class="org-ul">
<li>U-Boot: &lt;devid&gt;</li>
<li>Linux: &lt;mtdid&gt;</li>
</ul>
<pre class="example">
setenv mtdids &lt;devid&gt;=&lt;mtdid&gt;
</pre>


<ul class="org-ul">
<li><code>mtdparts</code> command : defines partitions</li>
</ul>
</div>
</li>
<li><a id="orgdbaced7"></a>NAND commands<br />
<div class="outline-text-7" id="text-orgdbaced7">
<ul class="org-ul">
<li><code>nand erase</code></li>
<li><code>nand write</code></li>
<li><code>nand bad</code></li>
</ul>
</div>
</li>
</ul>
</div>
<div id="outline-container-org039553e" class="outline-6">
<h6 id="org039553e">Linux (through MTD interface)</h6>
<div class="outline-text-6" id="text-org039553e">
<ul class="org-ul">
<li>user space only sees the MTD partitions</li>
<li>mtdchar driver creates character devices
<ul class="org-ul">
<li><code>/dev/mtdX</code> and <code>/dev/mtdXro</code></li>
</ul></li>
<li><code>mtd-utils</code></li>
<li><code>flashcp</code> : write NOR</li>
<li><code>nandwrite</code> : write NAND</li>
</ul>
</div>

<ul class="org-ul">
<li><a id="org13b6969"></a>wear leveling<br />
<div class="outline-text-7" id="text-org13b6969">
<ul class="org-ul">
<li>distribute erases over the whole flash
<ul class="org-ul">
<li>filesystem layer</li>
<li>UBI</li>
</ul></li>
<li>don't use flash for swap</li>
<li>mount as read only</li>
<li>volatile files in RAM</li>
<li>don't use <code>sync</code> mount option (use <code>fsync()</code> system call)</li>
</ul>
</div>
</li>

<li><a id="org7eb4001"></a>Flash file-systems<br />
<div class="outline-text-7" id="text-org7eb4001">
<p>
legacy filesystems
</p>
<ul class="org-ul">
<li><code>JFFS2</code> : wear leveling (only partitions), slow</li>
<li><code>YAFFS2</code>:
<ul class="org-ul">
<li>fast boot time</li>
<li>not part of the official Linux kernel (patches)</li>
</ul></li>
</ul>

<p>
<code>UBI</code> / <code>UBIFS</code> is the standard
</p>
<ul class="org-ul">
<li><a href="http://www.linux-mtd.infradead.org/doc/ubi.html">http://www.linux-mtd.infradead.org/doc/ubi.html</a></li>
<li>space overhead (~25% of storage)
<ul class="org-ul">
<li>needs to store metadata</li>
</ul></li>
<li>like LVM (Logical Volume Manager) for block devices</li>
<li>wear leveling on the whole storage (device level), not only partitions</li>
<li>Mapping: LEB (Logical Erase Block) to PEB (Physical Erase Block)</li>
</ul>
<p>
Tools:
</p>
<ul class="org-ul">
<li><code>ubinize</code>  (host tool)</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgbc8f320" class="outline-4">
<h4 id="orgbc8f320">8. System Development</h4>
<div class="outline-text-4" id="text-orgbc8f320">
<ul class="org-ul">
<li><a href="https://directory.fsf.org/wiki/Main_Page">https://directory.fsf.org/wiki/Main_Page</a></li>
<li><a href="http://linuxgizmos.com/">http://linuxgizmos.com/</a></li>
</ul>
</div>
<div id="outline-container-orga80cce9" class="outline-5">
<h5 id="orga80cce9">Licenses</h5>
<div class="outline-text-5" id="text-orga80cce9">
<p>
Free software:
</p>
<ul class="org-ul">
<li>Freedom to use</li>
<li>Freedom to study</li>
<li>Freedom to copy</li>
<li>Freedom to modify and distribute modified copies</li>
</ul>

<p>
Free Software licenses
</p>
<ul class="org-ul">
<li>copyleft: user has use the same license. You need to contribute your changes back.</li>
<li>non-copyleft: modified versions can be made proprietary.</li>
</ul>

<p>
GNU General Public License (GPL)
</p>
<ul class="org-ul">
<li>copyleft, Requires derivatives to be released under the same license.</li>
<li>if you link with GPL library you need to be GPL.</li>
<li>you have to be ready to distribute the source code to the customer.</li>
</ul>

<p>
GNU LGPL (Lesser GPL)
</p>
<ul class="org-ul">
<li>used for C libraries to avoid transititvity</li>
<li>you can link against a library and make it proprietary.</li>
<li>there might be issues with statically linked uClibc etc.</li>
</ul>
</div>
</div>

<div id="outline-container-org8d92ed7" class="outline-5">
<h5 id="org8d92ed7">Networking</h5>
<div class="outline-text-5" id="text-org8d92ed7">
</div>
<div id="outline-container-orgb6ca464" class="outline-6">
<h6 id="orgb6ca464">ssh</h6>
<div class="outline-text-6" id="text-orgb6ca464">
<ul class="org-ul">
<li>ssh server and client : Dropbear</li>
<li>you can use <code>rsync</code> as soon as you have a ssh connection</li>
</ul>
</div>
</div>

<div id="outline-container-org45b5915" class="outline-6">
<h6 id="org45b5915">Web Servers</h6>
<div class="outline-text-6" id="text-org45b5915">
<ul class="org-ul">
<li>BusyBox hhtp server</li>
<li>Boa, thttpd, lightttpd, nginx</li>
<li>Node.js, low.js (<a href="https://www.neonious.com/lowjs/">https://www.neonious.com/lowjs/</a>)</li>
<li>python</li>
</ul>
</div>
</div>

<div id="outline-container-org8ce9d06" class="outline-6">
<h6 id="org8ce9d06">Network utilities</h6>
<div class="outline-text-6" id="text-org8ce9d06">
<ul class="org-ul">
<li><code>avahi</code> : Multicast DNS Service Discovery, allows programs to publish and
discover services on a local network</li>
<li><code>bind</code> : a DNS server</li>
<li><code>iptables</code> : firewall, netfilter</li>
<li><code>chrony</code> : clock synchronization</li>
<li><code>oppenssl</code> : SSL, TLS conncetions</li>
<li><code>pppd</code> : Point to Point Protocol implementation</li>
<li><code>samba</code> : windows access to shared files</li>
<li><code>vsftpd</code> : FTP servers</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgcc77de1" class="outline-5">
<h5 id="orgcc77de1">System utilities</h5>
<div class="outline-text-5" id="text-orgcc77de1">
<ul class="org-ul">
<li><code>dbus</code> : object-oriented communication bus between applications</li>
<li><code>libusb</code> :</li>
<li><code>i2c-tools</code></li>
<li><code>mtd-tools</code></li>
</ul>
</div>
</div>

<div id="outline-container-org73c7e35" class="outline-5">
<h5 id="org73c7e35">Language interpreters</h5>
<div class="outline-text-5" id="text-org73c7e35">
<ul class="org-ul">
<li>Lua</li>
<li>Python</li>
<li>Perl</li>
<li>Ruby</li>
<li>PHP</li>
</ul>
</div>
</div>

<div id="outline-container-org6efc71b" class="outline-5">
<h5 id="org6efc71b">Audio, Video, Multimedia</h5>
<div class="outline-text-5" id="text-org6efc71b">
<ul class="org-ul">
<li><code>GStreamer</code> : multimedia framework</li>
<li><code>alsa-lib</code> : ALSA sound subsystem</li>
</ul>
<p>
i not using <code>GStreamer</code>
</p>
<ul class="org-ul">
<li><code>libavcodec</code> : ffmpeg project, video</li>
<li><code>libvpx</code> : video</li>
<li><code>libflac</code> : audio</li>
<li><code>libvorbis</code>, <code>libopus</code>, <code>libmad</code> (mp3), <code>libspeex</code> (speech) : audio</li>
</ul>
</div>
</div>

<div id="outline-container-org8e0dfcd" class="outline-5">
<h5 id="org8e0dfcd">Graphics</h5>
<div class="outline-text-5" id="text-org8e0dfcd">
<ul class="org-ul">
<li><a href="https://en.wikipedia.org/wiki/List_of_widget_toolkits">https://en.wikipedia.org/wiki/List_of_widget_toolkits</a></li>
<li><a href="https://bootlin.com/training/graphics/">https://bootlin.com/training/graphics/</a></li>
</ul>
</div>

<div id="outline-container-org026a8dc" class="outline-6">
<h6 id="org026a8dc">directly into the Framebuffer</h6>
<div class="outline-text-6" id="text-org026a8dc">
<p>
Basically you open /dev/fb0, do some ioctls on it, then mmap it
</p>
<pre class="example">
  //open file descriptor and get info
inf fdScreen = open( "devicename", O_RDWR );
fb_var_screeninfo varInfo;
ioctl( fdScreen, FBIOGET_VSCREENINFO, &amp;varInfo );

  //set resolution/dpi/color depth/.. in varInfo, then write it back
ioctl( fdScreen, FBIOPUT_VSCREENINFO, &amp;varInfo );

  //get writable screen memory; unsigned short here for 16bit color
unsigned short* display = mmap( 0, nScreenSize,
                                PROT_READ | PROT_WRITE, MAP_SHARED, fdScreen, 0 );
</pre>
</div>
</div>



<div id="outline-container-org08f6585" class="outline-6">
<h6 id="org08f6585">KDrive Server (X.org)</h6>
<div class="outline-text-6" id="text-org08f6585">
<ul class="org-ul">
<li>stand alone version of X server (KDrive was formally called Tiny-X)</li>
<li>on top of the Linux frame buffer (thanks to Xfbdev)</li>
<li>Xlib / XCB - low level libraries</li>
<li>High level: Gtk, Qt, Enlightenment Foundation Libraries, Fltk, WxEmbedded</li>
</ul>
</div>
</div>

<div id="outline-container-org06aaf4c" class="outline-6">
<h6 id="org06aaf4c">Wayland</h6>
<div class="outline-text-6" id="text-org06aaf4c">
<p>
Protocol for a compositor as well as an implementation in C. 
</p>
<ul class="org-ul">
<li>Weston is the compositor implementation</li>
</ul>
</div>
</div>

<div id="outline-container-org68a4f95" class="outline-6">
<h6 id="org68a4f95">Gtk</h6>
<div class="outline-text-6" id="text-org68a4f95">
<p>
(implemented for GIMP)
</p>
<ul class="org-ul">
<li>no windowing system (Matchbox can be used)</li>
<li><code>Glib</code> core library
<ul class="org-ul">
<li>many object-oriented code in C</li>
</ul></li>
<li><code>Pango</code> : text handling</li>

<li><code>Cairo</code> : vector graphics</li>
<li><code>Gtk+</code> : widget library</li>
</ul>
</div>
</div>

<div id="outline-container-org2b4f6f0" class="outline-6">
<h6 id="org2b4f6f0">Qt</h6>
<div class="outline-text-6" id="text-org2b4f6f0">
<ul class="org-ul">
<li>C++</li>
<li>works directly on Framebuffer</li>
<li>Qt is a complete framework (<a href="https://bootlin.com/pub/conferences/2011/elce/qt-for-non-graphical-apps/qt-for-non-graphical-apps.pdf">https://bootlin.com/pub/conferences/2011/elce/qt-for-non-graphical-apps/qt-for-non-graphical-apps.pdf</a>)
<ul class="org-ul">
<li>threads, network, databases, xml, etc.</li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-orgaeaeacc" class="outline-6">
<h6 id="orgaeaeacc">EFL (Enlightenment Foundation Libraries)</h6>
</div>
<div id="outline-container-org609bd0c" class="outline-6">
<h6 id="org609bd0c">FLTK (Fast Light Toolkit)</h6>
</div>
</div>

<div id="outline-container-org9a2e89e" class="outline-5">
<h5 id="org9a2e89e">Databases</h5>
<div class="outline-text-5" id="text-org9a2e89e">
<p>
SQLite
</p>
</div>
</div>
<div id="outline-container-org04d0480" class="outline-5">
<h5 id="org04d0480">Web Browsers</h5>
<div class="outline-text-5" id="text-org04d0480">
<ul class="org-ul">
<li>WebKit</li>
</ul>
</div>
</div>

<div id="outline-container-org457a50f" class="outline-5">
<h5 id="org457a50f">System building</h5>
<div class="outline-text-5" id="text-org457a50f">
</div>
<div id="outline-container-org38bbc72" class="outline-6">
<h6 id="org38bbc72">Manually</h6>
<div class="outline-text-6" id="text-org38bbc72">
<ul class="org-ul">
<li>configure, compile, install
<ul class="org-ul">
<li>all libraries and dependencies</li>
</ul></li>
<li>some libraries might not be cross-compile friendly</li>
</ul>

<p>
What the root file system needs
</p>
<ul class="org-ul">
<li>directory hierarchy</li>
<li>init</li>
<li>libraries (C, thread,</li>
<li>inittab, init.d/</li>
</ul>

<p>
<b>Sources</b> -&gt; [make instal] -&gt; <b>Build Space</b> -&gt; [copy + strip] -&gt; <b>Target Space</b>
</p>
</div>

<ul class="org-ul">
<li><a id="orged2a26b"></a>Build systems<br />
<div class="outline-text-7" id="text-orged2a26b">
<p>
Open source components should have a mechanism to 
</p>
<ul class="org-ul">
<li>configure</li>
<li>compile</li>
<li>install</li>
</ul>

<p>
So you have to fiddle with:
</p>
<ul class="org-ul">
<li>Makefile - basic</li>
<li>Autotools - most common</li>
<li>CMake - newer and simpler than Autotools</li>
</ul>
</div>

<ul class="org-ul">
<li><a id="org5c7e612"></a>Autotools<br />
<div class="outline-text-8" id="text-org5c7e612">
<p>
collection of tools
</p>
<ul class="org-ul">
<li><code>autoconf</code></li>
<li><code>automake</code> : generate Makefiles</li>
<li><code>pkgconfig</code></li>
<li><code>libtool</code></li>
</ul>

<p>
Files written manually
</p>
<ul class="org-ul">
<li><code>configure.in</code></li>
<li><code>Makefile.am</code></li>
</ul>

<p>
Cross Compiling
</p>
<ul class="org-ul">
<li>tweak environment variables</li>
<li><code>configure</code> script arguments
<ul class="org-ul">
<li>&#x2013;host : actually the target (arm)</li>
</ul></li>
<li>use &#x2013;prefix, <code>make DESTDIR=$HOME/rootfs</code>
otherwise installation goes to =/usr/</li>
</ul>
</div>
</li>
</ul>
</li>
</ul>
</div>
<div id="outline-container-org8f2cbfe" class="outline-6">
<h6 id="org8f2cbfe">System building tools</h6>
<div class="outline-text-6" id="text-org8f2cbfe">
<ul class="org-ul">
<li>Buildroot : easy to use</li>
<li>OpenEmbedded/Yocto : flexible but complicated</li>
<li>official distribution (Debian, Fedora)</li>
</ul>
</div>

<ul class="org-ul">
<li><a id="org1118a40"></a>Buildroot<br />
<div class="outline-text-7" id="text-org1118a40">
<ul class="org-ul">
<li>toolchain</li>
<li>root filesystem</li>
<li>supports uClibc, glibc, musl</li>
<li>applications and libraries (2000+)</li>
<li>no package support</li>
<li>need to recompile for most changes</li>
<li>make menuconfig</li>
<li>good for small systems</li>
</ul>

<p>
Add a package:
</p>
<ul class="org-ul">
<li>each package in <code>package/gqview</code></li>
<li><code>Config.in</code> file</li>
<li><code>gqview.mk</code> makefile, describe how the package is built</li>
</ul>
</div>
</li>

<li><a id="orge374455"></a>OpenEmbedded / Yocto Project<br />
<div class="outline-text-7" id="text-orge374455">
<ul class="org-ul">
<li>collection of recipes (<code>.bb</code> files)</li>
<li><code>bitbake</code> : toll processing recipes</li>
<li>don't have to rebuild when config is changed</li>
<li>good for big projects (families of projects)</li>
<li>long build time</li>
<li>big system</li>
</ul>
</div>
</li>

<li><a id="org2ec80f7"></a>Debian<br />
<div class="outline-text-7" id="text-org2ec80f7">
<ul class="org-ul">
<li>make quick prototype</li>
<li>arm, MIPS, PowerPC, RiscV</li>
<li><code>debootstrap</code> command to build a rootfs</li>
<li>ELBE : generate custom rootfs (more advanced)</li>
</ul>
</div>
</li>
<li><a id="orgbb355e4"></a>Fedora<br />
<div class="outline-text-7" id="text-orgbb355e4">
<ul class="org-ul">
<li>support for various ARM boards (Beaglebone Black, Raspberry Pi)</li>
<li>same version as for desktop</li>
</ul>
</div>
</li>
<li><a id="org12e0dcb"></a>Alpine Linux<br />
<div class="outline-text-7" id="text-org12e0dcb">
<p>
Musl &amp; Busybox
</p>
</div>
</li>
<li><a id="orgc0a4fce"></a>Application frameworks<br />
<div class="outline-text-7" id="text-orgc0a4fce">
<p>
Middleware on top of Linux kernel. 
</p>

<ul class="org-ul">
<li>Android
<ul class="org-ul">
<li>rootfs hierarchy different</li>
</ul></li>
<li>Tizen
<ul class="org-ul">
<li>HTML5 based application framework</li>
</ul></li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgf291767" class="outline-4">
<h4 id="orgf291767">9. Application development and debugging</h4>
<div class="outline-text-4" id="text-orgf291767">
</div>
<div id="outline-container-org3675bca" class="outline-5">
<h5 id="org3675bca">Programming Languages</h5>
<div class="outline-text-5" id="text-org3675bca">
<p>
C, C++, Rust
</p>

<p>
Scripting
</p>
<ul class="org-ul">
<li>Lua, Python, shell</li>
</ul>
</div>
</div>

<div id="outline-container-org56fa591" class="outline-5">
<h5 id="org56fa591">C library or higher level?</h5>
<div class="outline-text-5" id="text-org56fa591">
<ul class="org-ul">
<li>Michael Kerrisk - The Linux Programming Interface</li>

<li>Qt, Gtk/Glib stack might be an idea</li>
</ul>
</div>
</div>

<div id="outline-container-org968e50d" class="outline-5">
<h5 id="org968e50d">Build</h5>
<div class="outline-text-5" id="text-org968e50d">
<ul class="org-ul">
<li>CMake</li>
<li>for Qt: qmake</li>
</ul>

<p>
Makefile example:
</p>
<pre class="example">
CROSS_COMPILE?=arm-linux-
CC=$(CROSS_COMPILE)gcc
OBJS=foo.o bar.o
 
all: foobar
 
foobar: $(OBJS)
&lt;TAB&gt;     $(CC) -o $@ $^
 
clean:
&lt;TAB&gt;     $(RM) -f foobar $(OBJS)
</pre>

<ul class="org-ul">
<li><code>$@ $^</code> : target file / dependencies</li>
<li>make knows certain dependencies (.c .o files)</li>
<li>TABs required</li>
</ul>
</div>
</div>

<div id="outline-container-org7056ecd" class="outline-5">
<h5 id="org7056ecd">Debuggers</h5>
<div class="outline-text-5" id="text-org7056ecd">
</div>
<div id="outline-container-org7a9982a" class="outline-6">
<h6 id="org7a9982a">GNU - GDB</h6>
</div>
<div id="outline-container-orgf0b9aac" class="outline-6">
<h6 id="orgf0b9aac">llvm - LLDB</h6>
<div class="outline-text-6" id="text-orgf0b9aac">
<p>
to be explored
</p>
</div>
</div>

<div id="outline-container-org763b210" class="outline-6">
<h6 id="org763b210">Remote Debugging (gdbserver)</h6>
<div class="outline-text-6" id="text-org763b210">
<p>
On a desktop pc gdb has direct access to the binary. 
</p>

<p>
On embedded systems gdb might be too big (~2.4 MB)
Instead use <code>ARCH-linux-gdb</code> + <code>gdbserver</code> (~100 KB)
</p>
<ul class="org-ul">
<li>Can run with stripped libraries, everything needed is on the host.</li>
</ul>
</div>

<ul class="org-ul">
<li><a id="org4c7d5a4"></a>Usage<br />
<div class="outline-text-7" id="text-org4c7d5a4">
<p>
<b>On the Target</b>
</p>
<pre class="example">
gdbserver localhost:&lt;port&gt; &lt;executable&gt; &lt;args&gt;
gdbserver /dev/ttyS0 &lt;executable&gt; &lt;args&gt;
</pre>


<p>
Attach to a running program
</p>
<pre class="example">
gdbserver --attach localhost:&lt;port&gt; &lt;pid&gt;
</pre>


<p>
<b>On the Host</b>
</p>
<pre class="example">
ARCH-linux-gdb &lt;executable&gt;
gdb&gt; target remote &lt;ip-addr&gt;:&lt;port&gt; 
gdb&gt; target remote /dev/ttyS0 
</pre>

<p>
Tell <code>gdb</code> where the libraries are (without <code>lib/</code>)
</p>
<pre class="example">
gdb&gt; set sysroot &lt;library-path&gt;
</pre>
</div>
</li>

<li><a id="orgdd49c8b"></a>Crash due to segmentation fault<br />
<div class="outline-text-7" id="text-orgdd49c8b">
<p>
Configure Linux to generate a core file to figure out where the application
crashed.
</p>

<p>
In the shell (or shell script).
</p>
<pre class="example">
ulimit -c unlimited
</pre>


<p>
On the host (post mortem analysis)
Transfer the core file. 
</p>
<pre class="example">
ARCH-linux-gdb -c core-file application-binary
</pre>
</div>
</li>
</ul>
</div>

<div id="outline-container-orge280c8a" class="outline-6">
<h6 id="orge280c8a">Memory Checkers</h6>
<div class="outline-text-6" id="text-orge280c8a">
</div>
<ul class="org-ul">
<li><a id="orgfd2bc0f"></a>Valgrind<br />
<div class="outline-text-7" id="text-orgfd2bc0f">
<p>
Can detect memory management and threading bugs. 
It's also a profiler (tells you how much time is spent where).
</p>

<p>
Check for leakage example:
</p>
<pre class="example">
valgrind --leak-check=yes ls -la
</pre>


<ul class="org-ul">
<li>Runs in its own virtual cpu core.</li>
</ul>
</div>
</li>
</ul>
</div>

<div id="outline-container-org4b5f341" class="outline-6">
<h6 id="org4b5f341">System analysis</h6>
<div class="outline-text-6" id="text-org4b5f341">
<p>
How does it work?
</p>
<ul class="org-ul">
<li>ovverride library functions</li>
</ul>
</div>

<ul class="org-ul">
<li><a id="orgf941569"></a>tracealyzer<br />
<div class="outline-text-7" id="text-orgf941569">
<p>
<a href="https://percepio.com/tz/tracealyzer-for-linux/">https://percepio.com/tz/tracealyzer-for-linux/</a>
</p>
</div>
</li>
<li><a id="org5788334"></a>strace<br />
<div class="outline-text-7" id="text-org5788334">
<p>
Trace system calls. 
</p>

<p>
new process
</p>
<pre class="example">
strace &lt;command&gt;
</pre>

<p>
existing process
</p>
<pre class="example">
strace -p &lt;pid&gt;
</pre>

<p>
statistic of system calls 
</p>
<pre class="example">
strace -c &lt;command&gt;
</pre>
</div>
</li>
<li><a id="org6cc30c1"></a>ltrace<br />
<div class="outline-text-7" id="text-org6cc30c1">
<p>
Trace library calls used by a program.
</p>
</div>
</li>
<li><a id="org973d027"></a>OProfile<br />
<div class="outline-text-7" id="text-org973d027">
<p>
system-wide profiling tool.
</p>
<ul class="org-ul">
<li>requires kernel patch</li>
</ul>
</div>
</li>
</ul>
</div>
<div id="outline-container-org32f6f32" class="outline-6">
<h6 id="org32f6f32">J-Tag</h6>
<div class="outline-text-6" id="text-org32f6f32">
<ul class="org-ul">
<li>Black Magic Probe</li>
<li>OpenOCD</li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-org9cd53c0" class="outline-4">
<h4 id="org9cd53c0">10. Linux and real-time</h4>
<div class="outline-text-4" id="text-org9cd53c0">
<p>
Best possible sharing of resources is contradictory to time determinism. 
</p>
</div>

<div id="outline-container-org348b3c7" class="outline-5">
<h5 id="org348b3c7">Approaches</h5>
<div class="outline-text-5" id="text-org348b3c7">
<ul class="org-ul">
<li>1. Improve kernel, real-time API, PREEMPT_RT project.</li>
<li>2. Add a layer below (micro kernel) the kernel. RTLinux, Xenomai.</li>
<li>3. Use specific hardware for real-time work.
<ul class="org-ul">
<li>Have one core for real-time.</li>
<li>Run real time work on a FPGA.</li>
<li>Use a dedicated microcontroller.</li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-orgaf58715" class="outline-5">
<h5 id="orgaf58715">Understanding latency</h5>
<div class="outline-text-5" id="text-orgaf58715">
<p>
Time from the occurrence of an event (interrupt) till the execution of the corresponding
task. 
</p>

<ul class="org-ul">
<li>We want: Guarantee worst case latency until the task is started.</li>
</ul>
</div>

<div id="outline-container-org060a6a0" class="outline-6">
<h6 id="org060a6a0">Interrupt latency</h6>
<div class="outline-text-6" id="text-org060a6a0">
<ul class="org-ul">
<li>Drivers may delay the execution of the interrupt handler because they 
turn off interrupt handling.</li>
<li>Already running interrupt handler. In Linux, there are no nested interrupts.
Only one interrupt handler can run.</li>
<li>Interrupt waiting on a spinlock that code aquired the interrupt interrupted. 
So it will wait forever. 
<ul class="org-ul">
<li>Because of this interrupts are disabled when spinlocks are held. This can 
also lead to latency.</li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-org28a30b5" class="outline-6">
<h6 id="org28a30b5">Interrupt handler implementation</h6>
<div class="outline-text-6" id="text-org28a30b5">
<p>
Two types of interrupt handlers. 
</p>

<ul class="org-ul">
<li>top-half : started as soon as interrupts are enabled.</li>
<li>bottom-half : scheduled by the top-half</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org1cd58c3" class="outline-5">
<h5 id="org1cd58c3">Understanding preemption</h5>
<div class="outline-text-5" id="text-org1cd58c3">
<p>
Tasks can be interrupted without their cooperation (context switches). This is done
by a privileged task, the scheduler. 
</p>

<ul class="org-ul">
<li>The Linux kernel is a preemptive OS.</li>
</ul>

<p>
flag - need_resched 
</p>
</div>
</div>

<div id="outline-container-org3f72ce0" class="outline-5">
<h5 id="org3f72ce0">Other non-deterministic mechanisms</h5>
<div class="outline-text-5" id="text-org3f72ce0">
<ul class="org-ul">
<li>Code might be loaded on demand, taking a lot of time at first load.</li>
<li>To avoid that, all resources should be allocated ahead of time.</li>
<li>There can be a non-deterministic startup phase, after which the system 
behaves deterministically.</li>
</ul>
</div>
</div>
<div id="outline-container-orgb8d5f8b" class="outline-5">
<h5 id="orgb8d5f8b">Priority inversion</h5>
<div class="outline-text-5" id="text-orgb8d5f8b">
<p>
A low priority process might hold a lock needed by a higher priority process.
Even worst when a third process interrupts the low priority process. 
</p>

<p>
see: Mars Rover Problem
</p>
</div>
</div>

<div id="outline-container-org0e1d9db" class="outline-5">
<h5 id="org0e1d9db">Priority inheritance</h5>
<div class="outline-text-5" id="text-org0e1d9db">
<p>
Avoid priority inversion. The low priority process inherits the priority of 
the interrupting high priority process and will not be interrupted by an 
in between priority process. 
</p>
</div>
</div>
<div id="outline-container-org5d51fd5" class="outline-5">
<h5 id="org5d51fd5">Mainline kernel</h5>
<div class="outline-text-5" id="text-org5d51fd5">
</div>
<div id="outline-container-orgf8270c4" class="outline-6">
<h6 id="orgf8270c4">Options</h6>
<div class="outline-text-6" id="text-orgf8270c4">
<ul class="org-ul">
<li>Preemption models
<ul class="org-ul">
<li><code>CONFIG_PREEMPT_NONE</code> : kernel code is never preempted (default)</li>
<li><code>CONFIG_PREEMPT_VOLUNTARY</code> : kernel can preempt itself</li>
<li><code>CONFIG_PREEMPT</code> :</li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-org9bb5157" class="outline-6">
<h6 id="org9bb5157">High resolution timers</h6>
<div class="outline-text-6" id="text-org9bb5157">
<p>
SysTick is about 10ms. Timers are bound to this resolution. 
</p>

<p>
HRT-infrastrucure allows to use hardware timers. 
</p>
</div>
</div>

<div id="outline-container-org46971a0" class="outline-6">
<h6 id="org46971a0">Threaded interrupts</h6>
<div class="outline-text-6" id="text-org46971a0">
<p>
Interrupt handlers run in kernel threads with different priorities. 
The real interrupt handlers only set flags. 
</p>

<p>
No busy waiting anymore, interrupt handler can sleep. 
</p>
</div>
</div>
</div>
<div id="outline-container-orgb10f06f" class="outline-5">
<h5 id="orgb10f06f">PREEMPT_RT</h5>
<div class="outline-text-5" id="text-orgb10f06f">
</div>
<div id="outline-container-orgabaa81b" class="outline-6">
<h6 id="orgabaa81b">Patchset specifics</h6>
<div class="outline-text-6" id="text-orgabaa81b">
<p>
PREEMPT_RT is delivered as a patch against the mainline kernel.
</p>
<ul class="org-ul">
<li>use LTS kernel</li>
</ul>
</div>
</div>

<div id="outline-container-orgf05d413" class="outline-6">
<h6 id="orgf05d413">Setting up PREEMPT_RT</h6>
<div class="outline-text-6" id="text-orgf05d413">
<ul class="org-ul">
<li>Download patch.</li>
<li>Download corresponding mainline kernel.</li>
<li>Apply patch.</li>
<li>CONFIG_PREEMPT_RT has to be enabled</li>
<li>high resolution timers has to be enabled</li>
<li>compile</li>
<li>boot and set interrupt thread priorities</li>
</ul>
</div>
</div>

<div id="outline-container-orga17fabb" class="outline-6">
<h6 id="orga17fabb">Development</h6>
<div class="outline-text-6" id="text-orga17fabb">
<ul class="org-ul">
<li>use <code>glibc</code></li>
<li>compile with <code>-lrt</code></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orge0d668d" class="outline-5">
<h5 id="orge0d668d">Scheduling classes</h5>
<div class="outline-text-5" id="text-orge0d668d">
<ul class="org-ul">
<li>default class <code>SCHED_OTHER</code>
<ul class="org-ul">
<li>time-sharing class, everyone gets some time</li>
<li>nice value: -20 (highest) to 19 (lowest)</li>
</ul></li>

<li>real time class <code>SCHED_FIFO</code>, <code>SCHED_RR</code>, <code>SCHED_DEADLINE</code>
<ul class="org-ul">
<li>RT 0 to 99 (highest)</li>
<li>highest RT gets all CPU time</li>
<li><code>SCHED_RR</code> : round robin</li>
<li><code>SCHED_DEADLINE</code> : fixed amount of time</li>
</ul></li>
</ul>
</div>

<div id="outline-container-orgbb244a8" class="outline-6">
<h6 id="orgbb244a8">Using scheduling classes</h6>
<div class="outline-text-6" id="text-orgbb244a8">
<pre class="example">
chrt -f 99 ./myprog
</pre>

<ul class="org-ul">
<li>-f <code>SCHED_FIFO</code></li>
<li>-r <code>SCHED_RR</code></li>
<li>-d <code>SCHED_DEADLINE</code></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org64c8488" class="outline-5">
<h5 id="org64c8488">Memory locking</h5>
<div class="outline-text-5" id="text-org64c8488">
<p>
Solve virtual memory on demand problem (long load time).
</p>
</div>
</div>

<div id="outline-container-orgfd8621e" class="outline-5">
<h5 id="orgfd8621e">Mutexes</h5>
</div>
<div id="outline-container-org3ecc8a4" class="outline-5">
<h5 id="org3ecc8a4">Timers</h5>
</div>
<div id="outline-container-org4ba7ca2" class="outline-5">
<h5 id="org4ba7ca2">Signals</h5>
</div>
<div id="outline-container-orga8bd103" class="outline-5">
<h5 id="orga8bd103">Debugging</h5>
<div class="outline-text-5" id="text-orga8bd103">
</div>
<div id="outline-container-org35d5fdc" class="outline-6">
<h6 id="org35d5fdc">ftrace</h6>
<div class="outline-text-6" id="text-org35d5fdc">
<ul class="org-ul">
<li>Compile kernel with tracefs filesystem.</li>
</ul>
</div>
</div>
<div id="outline-container-orgc184b15" class="outline-6">
<h6 id="orgc184b15">Scheduling latency tracer</h6>
<div class="outline-text-6" id="text-orgc184b15">
<p>
<code>CONFIG_SCHED_TRACER</code>
</p>
</div>
</div>
</div>

<div id="outline-container-org8a8bc54" class="outline-5">
<h5 id="org8a8bc54">Real-time extensions to the kernel</h5>
<div class="outline-text-5" id="text-org8a8bc54">
<p>
Micro kernel layer between hardware and Linux kernel.
Manage real time tasks separately. 
</p>
</div>

<div id="outline-container-org50bade8" class="outline-6">
<h6 id="org50bade8">Xenomai project</h6>
<div class="outline-text-6" id="text-org50bade8">
<ul class="org-ul">
<li>has it's own scheduler</li>
<li>can only use Xenomai device drivers</li>
<li>no access to linux services</li>
</ul>
</div>
</div>
</div>
</div>

<div id="outline-container-org4b82302" class="outline-4">
<h4 id="org4b82302">Packages</h4>
<div class="outline-text-4" id="text-org4b82302">
<p>
package meta-information:
</p>
<ul class="org-ul">
<li><code>.deb</code></li>
<li><code>.rpm</code></li>
<li><code>/etc/apt/sources.list</code> lists repositories</li>
</ul>

<p>
Find packages
</p>
<ul class="org-ul">
<li><a href="https://www.debian.org/distrib/packages">https://www.debian.org/distrib/packages</a></li>
</ul>
<pre class="example">
apt-cache search &lt;keyword&gt;
</pre>


<pre class="example">
sudo apt remove &lt;package&gt;
</pre>

<p>
or
</p>
<pre class="example">
sudo apt purge &lt;package&gt;
sudo apt-cache show &lt;package&gt;
</pre>


<p>
GUI-Tool: KPackageKit (KDE)
</p>

<p>
find package for command: <br />
which shows where a program was found
</p>
<pre class="example">
which makeinfo
dpkg -S /usr/bin/makeinfo
</pre>

<p>
-&gt; texinfo
</p>

<p>
Snap (Ubuntu) &amp; Flatpak
</p>
<ul class="org-ul">
<li>containerized applications</li>
</ul>
</div>
</div>

<div id="outline-container-org9a4d293" class="outline-4">
<h4 id="org9a4d293">Qemu</h4>
<div class="outline-text-4" id="text-org9a4d293">
<pre class="example">
sudo apt-get install qemu
</pre>

<p>
(virtualization using the KVM kernel module in Linux)
</p>
<pre class="example">
sudo apt-get install qemu-kvm 
</pre>


<p>
Create a virtual machine:
</p>
<pre class="example">
qemu-img create Puppy.vdi 10G
</pre>


<p>
Boot an ISO image
</p>
<pre class="example">
qemu-system-x86_64 -boot d -cdrom Desktop/puppy.iso -m 512
</pre>


<p>
QEMU emulated ARM Vexpress A9 board
</p>

<p>
Load C-library dynamically:
</p>
<pre class="example">
qemu-arm -L /.../sysroot ./hello
</pre>
</div>
</div>

<div id="outline-container-org253a10c" class="outline-4">
<h4 id="org253a10c">Labs</h4>
<div class="outline-text-4" id="text-org253a10c">
<p>
enter in <code>.bashrc</code>
Install ccache first: 
</p>
<pre class="example">
sudo apt install ccache
</pre>


<pre class="example">
# Joe
export PATH=/home/jh/STM32MP1_Toolchain/arm-training-linux-uclibcgnueabihf/bin:$PATH
export CROSS_COMPILE='ccache arm-linux-'
</pre>
</div>
<div id="outline-container-org075f973" class="outline-5">
<h5 id="org075f973">Connecting to the Board with picocom</h5>
<div class="outline-text-5" id="text-org075f973">
<pre class="example">
sudo apt install picocom
sudo adduser jh dialout
</pre>


<p>
Connect via the micro USB connector: you'll get <code>/dev/ttyACM0</code>
</p>
<pre class="example">
picocom -b 115200 /dev/ttyACM0
</pre>
</div>
</div>

<div id="outline-container-orgaec045a" class="outline-5">
<h5 id="orgaec045a">Additional Tools</h5>
<div class="outline-text-5" id="text-orgaec045a">
<p>
Required Packages
</p>
<pre class="example">
sudo apt install build-essential git autoconf bison flex texinfo help2man gawk libtool-bin libncurses5-dev
</pre>


<p>
Device Tree Compiler
</p>
<pre class="example">
sudo apt install device-tree-compiler
</pre>
</div>
</div>

<div id="outline-container-orgcf2e3c1" class="outline-5">
<h5 id="orgcf2e3c1">Building a cross-compiling toolchain</h5>
<div class="outline-text-5" id="text-orgcf2e3c1">
</div>
<div id="outline-container-org28d21a6" class="outline-6">
<h6 id="org28d21a6">Build Crosstool-ng</h6>
<div class="outline-text-6" id="text-org28d21a6">
<ul class="org-ul">
<li>get <code>Crosstool-ng</code> from GIT, build and install it</li>
</ul>
<pre class="example">
git clone https://github.com/crosstool-ng/crosstool-ng.git
./bootstrap
</pre>


<p>
Install it locally in the current directory
</p>
<pre class="example">
./configure --enable-local
make
</pre>
</div>
</div>
<div id="outline-container-orgd995637" class="outline-6">
<h6 id="orgd995637">Configure desired toolchain</h6>
<div class="outline-text-6" id="text-orgd995637">
<pre class="example">
./ct-ng list-samples
</pre>


<p>
We use the Cortex A4 sample:
</p>
<pre class="example">
./ct-ng arm--cortexa5-linux-uclibcgnueabihf
</pre>


<p>
Configure options
</p>
<pre class="example">
./ct-ng menuconfig
</pre>


<ol class="org-ol">
<li>"Maximum log level to see": (DEBUG)</li>
</ol>

<p>
Safe the .config file.
</p>

<p>
Generate the toolchain
</p>
<pre class="example">
./ct-ng build
</pre>
</div>
</div>
</div>



<div id="outline-container-org36b3d74" class="outline-5">
<h5 id="org36b3d74">1. Toolchain</h5>
<div class="outline-text-5" id="text-org36b3d74">
<ul class="org-ul">
<li><code>libncurses5-dev</code> : for text based interfaces (needed for menuconfig)</li>
</ul>

<p>
Build application with toolchain:
</p>

<p>
(C-library dynamically linked)
</p>
<pre class="example">
toolchain/bin/arm-linux-cc -o hello hello.c 
</pre>


<p>
(with C-library)
</p>
<pre class="example">
arm-linux-cc -o hello hello.c -static
</pre>


<p>
Check the result:
</p>
<pre class="example">
file hello
</pre>
</div>

<div id="outline-container-org0feacd6" class="outline-6">
<h6 id="org0feacd6">BeagleBoneBlack</h6>
<div class="outline-text-6" id="text-org0feacd6">
<p>
<a href="http://tgarc.github.io/2015/03/08/building-a-linaro-cross-compiler-toolchain-with-cross-ng/">http://tgarc.github.io/2015/03/08/building-a-linaro-cross-compiler-toolchain-with-cross-ng/</a>
</p>
</div>
</div>

<div id="outline-container-orge6c640d" class="outline-6">
<h6 id="orge6c640d">Questions</h6>
<div class="outline-text-6" id="text-orge6c640d">
<ul class="org-ul">
<li><p>
How to get the C-library on the target? (e.g. uClibc)
</p>
<pre class="example">
file helloworld.o
</pre>

<p>
I had to copy <code>ld-uClibc.so.0</code> and <code>libc.so.0</code> from 
<code>/home/jh/STM32MP1_Toolchain/arm-training-linux-uclibcgnueabihf/arm-training-linux-uclibcgnueabihf/sysroot/lib</code> to <code>/lib</code>
</p>

<pre class="example">
arm-linux-ldd --root /.../sysroot/ hello
</pre>


<p>
With qemo: <br />
Load C-library dynamically:
</p>
<pre class="example">
qemu-arm -L /.../sysroot ./hello
</pre></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org307b5d1" class="outline-5">
<h5 id="org307b5d1">2. Bootloaders</h5>
<div class="outline-text-5" id="text-org307b5d1">
<p>
Connect
</p>
<pre class="example">
picocom -b 115200 /dev/ttyACM0
</pre>


<p>
Comment:
</p>
<ul class="org-ul">
<li><p>
goto <code>/dev/serial/by-id</code> and to <code>ls -la</code>, you'll see the symlink to <code>ttyACM0</code>
</p>
<pre class="example">
lrwxrwxrwx 1 root root 13 Oct  7 04:18 usb-STMicroelectronics_STM32_STLink_066BFF303739465043113857-if01 -&gt; ../../ttyACM0
</pre></li>
</ul>
</div>

<div id="outline-container-org70599b6" class="outline-6">
<h6 id="org70599b6">Make U-Boot</h6>
<div class="outline-text-6" id="text-org70599b6">
<pre class="example">
git clone https://github.com/STMicroelectronics/u-boot.git
cd u-boot
git checkout v2018.11-stm32mp-r2.1
</pre>


<pre class="example">
make DEVICE_TREE=stm32mp157c-dk2
</pre>
</div>
</div>
<div id="outline-container-org169e0d7" class="outline-6">
<h6 id="org169e0d7">Create SD Card</h6>
<div class="outline-text-6" id="text-org169e0d7">
<p>
The ROM monitor will look for the first stage bootloader (U-Boot SPL)
in a partition named fsbl1. U-Boot SPL will load U-Boot from the partition
named ssbl.
</p>

<p>
Partitions:
</p>
<ol class="org-ol">
<li><code>fsbl1</code>  : U-Boot SPL</li>
<li><code>fsbl2</code>  : U-Boot SPL if first partition fails</li>
<li><code>ssbl</code>   : U-Boot</li>
<li><code>bootfs</code> : U-Boot environment</li>
</ol>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-right">Number</td>
<td class="org-left">Start</td>
<td class="org-left">End</td>
<td class="org-left">Size</td>
<td class="org-left">File  system Name Flags</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-left">2048s</td>
<td class="org-left">4095s</td>
<td class="org-left">2048s</td>
<td class="org-left">fsbl1</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-left">4096s</td>
<td class="org-left">6143s</td>
<td class="org-left">2048s</td>
<td class="org-left">fsbl2</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-left">6144s</td>
<td class="org-left">10239s</td>
<td class="org-left">4096s</td>
<td class="org-left">ssbl</td>
</tr>

<tr>
<td class="org-right">4</td>
<td class="org-left">10240s</td>
<td class="org-left">131071s</td>
<td class="org-left">120832s</td>
<td class="org-left">bootfs</td>
</tr>
</tbody>
</table>

<p>
Assume we are in the <code>u-boot</code> folder.
</p>

<p>
SD-Card has to be partitioned:
</p>
<ol class="org-ol">
<li><p>
unmount (eject) SD Card
</p>
<pre class="example">
sudo umount /dev/sdb*
</pre></li>

<li><p>
Create partitions: (see also <a href="#org1956e3f">Block Filesystems</a>)
</p>
<pre class="example">
sudo dd if=/dev/zero of=/dev/sdb bs=4k count=200
sudo parted /dev/sdb
(parted) mklabel gpt
(parted) mkpart fsbl1 0% 4095s
(parted) mkpart fsbl2 4096s 6143s
(parted) mkpart ssbl 6144s 10239s
(parted) mkpart bootfs 10240s 131071s
</pre>

<p>
Verify:
</p>
<pre class="example">
(parted) unit s
(parted) print
(parted) quit
lsblk
</pre></li>
<li><p>
Format boot partition (#4) as ext2
</p>
<pre class="example">
sudo mkfs.ext2 -L boot /dev/sdb4
</pre></li>
<li><p>
Copy U-Boot SPL to first 2 partitions:
</p>
<pre class="example">
sudo dd if=spl/u-boot-spl.stm32 of=/dev/sdb1 bs=1M conv=fdatasync
sudo dd if=spl/u-boot-spl.stm32 of=/dev/sdb2 bs=1M conv=fdatasync
</pre></li>
<li><p>
Copy U-Boot to 3rd partition:
</p>
<pre class="example">
sudo dd if=u-boot.img of=/dev/sdb3 bs=1M conv=fdatasync
</pre></li>
</ol>

<p>
Test that it works:
</p>
<ol class="org-ol">
<li>Boot with new SD-Card.</li>
<li>Make Serial Connection: <a href="#org075f973">Connecting to the Board with picocom</a></li>
</ol>
</div>
</div>

<div id="outline-container-org2bf7d45" class="outline-6">
<h6 id="org2bf7d45">Set up Ethernet</h6>
<div class="outline-text-6" id="text-org2bf7d45">
<ul class="org-ul">
<li>Install TFTP on host.</li>
</ul>
<pre class="example">
sudo apt install tftpd-hpa
</pre>

<ul class="org-ul">
<li>Run VM in bridged mode. You need an extra IP address for the VM.</li>
</ul>

<p>
In U-Boot:
</p>
<ul class="org-ul">
<li><p>
Set a static ip address: 
</p>
<pre class="example">
setenv ipaddr 192.168.10.211
</pre></li>
<li><p>
Set ip address of host 
</p>
<pre class="example">
setenv serverip 192.168.10.204
</pre></li>
<li><p>
Transfer a file to a RAM address
</p>
<pre class="example">
tftp 0xC4000000 textfile.txt
</pre>

<p>
This file has to be in the folder <code>/srv/stftp</code>.
</p></li>
<li><p>
Verify RAM content
</p>
<pre class="example">
md 0xC4000000
</pre></li>
</ul>

<pre class="example">
printenv
</pre>

<pre class="example">
altbootcmd=run bootcmd
arch=arm
autoload=no
autostart=no
baudrate=115200
board=stm32mp1
board_name=stm32mp157c-dk2
boot_a_script=load ${devtype} ${devnum}:${distro_bootpart} ${scriptaddr} ${prefix}${script}; source ${scriptaddr}
boot_device=mmc
boot_extlinux=sysboot ${devtype} ${devnum}:${distro_bootpart} any ${scriptaddr} ${prefix}extlinux/extlinux.conf
boot_instance=0
boot_net_usb_start=true
boot_prefixes=/ /boot/
boot_script_dhcp=boot.scr.uimg
boot_scripts=boot.scr.uimg boot.scr
boot_targets=mmc0
bootcmd=echo "Boot over ${boot_device}${boot_instance}!";run bootcmd_stm32mp
bootcmd_mmc0=setenv devnum 0; run mmc_boot
bootcmd_mmc1=setenv devnum 1; run mmc_boot
bootcmd_mmc2=setenv devnum 2; run mmc_boot
bootcmd_pxe=run boot_net_usb_start; dhcp; if pxe get; then pxe boot; fi
bootcmd_stm32mp=if test ${boot_device} = serial || test ${boot_device} = usb; then stm32prog ${boot_device} ${boot_instance}; else if test ${boot_device} = mmc; then env set boot_targets "mmc${boot_instance}"; fi;if test ${boot_device} = nand; then env set boot_targets ubifs0; fi;run distro_bootcmd;fi;
bootcmd_ubifs0=setenv devnum 0; run ubifs_boot
bootcount=14
bootdelay=1
bootlimit=0
cpu=armv7
devnum=0
devplist=1
devtype=mmc
distro_bootcmd=for target in ${boot_targets}; do run bootcmd_${target}; done
ethact=ethernet@5800a000
ethaddr=00:80:e1:42:76:06
fdt_addr_r=0xc4000000
fdt_high=0xffffffff
fdtcontroladdr=ddc3aed8
fileaddr=c4000000
filesize=1c8c
initrd_high=0xffffffff
ipaddr=192.168.10.233
kernel_addr_r=0xc2000000
mmc_boot=if mmc dev ${devnum}; then setenv devtype mmc; run scan_dev_for_boot_part; fi
mtdparts_nand0=2m(fsbl),2m(ssbl1),2m(ssbl2),-(UBI)
mtdparts_nor0=256k(fsbl1),256k(fsbl2),2m(ssbl),256k(logo),-(nor_user)
pxefile_addr_r=0xc4200000
ramdisk_addr_r=0xc4400000
scan_dev_for_boot=echo Scanning ${devtype} ${devnum}:${distro_bootpart}...; for prefix in ${boot_prefixes}; do run scan_dev_for_extlinux; run scan_dev_for_scripts; done;
scan_dev_for_boot_part=part list ${devtype} ${devnum} -bootable devplist; env exists devplist || setenv devplist 1; for distro_bootpart in ${devplist}; do if fstype ${devtype} ${devnum}:${distro_bootpart} bootfstype; then run scan_dev_for_boot; fi; done
scan_dev_for_extlinux=if test -e ${devtype} ${devnum}:${distro_bootpart} ${prefix}extlinux/extlinux.conf; then echo Found ${prefix}extlinux/extlinux.conf; run boot_extlinux; echo SCRIPT FAILED: continuing...; fi
scan_dev_for_scripts=for script in ${boot_scripts}; do if test -e ${devtype} ${devnum}:${distro_bootpart} ${prefix}${script}; then echo Found U-Boot script ${prefix}${script}; run boot_a_script; echo SCRIPT FAILED: continuing...; fi; done
scriptaddr=0xc4100000
serial#=004000353438510538333630
serverio=192
serverip=192.168.10.126
soc=stm32mp
splashimage=0xc4300000
stderr=serial
stdin=serial
stdout=serial
ubifs_boot=env exists bootubipart || env set bootubipart UBI; env exists bootubivol || env set bootubivol boot; if ubi part ${bootubipart} &amp;&amp; ubifsmount ubi${devnum}:${bootubivol}; then setenv devtype ubi; run scan_dev_for_boot; fi
usb_boot=usb start; if usb dev ${devnum}; then setenv devtype usb; run scan_dev_for_boot_part; fi
usb_pgood_delay=2000
vendor=st

Environment size: 3173/4092 bytes
</pre>
</div>
</div>

<div id="outline-container-org4d5865f" class="outline-6">
<h6 id="org4d5865f">Questions</h6>
<div class="outline-text-6" id="text-org4d5865f">
<p>
Where to find the device tree file? 
<code>u-boot/arch/arm/dts/stm32mp157c-dk2.dts</code>
</p>
<pre class="example">
// SPDX-License-Identifier: (GPL-2.0+ OR BSD-3-Clause)
/*
 * Copyright (C) STMicroelectronics 2018 - All Rights Reserved
 * Author: Alexandre Torgue &lt;alexandre.torgue@st.com&gt;.
 */

/dts-v1/;

#include "stm32mp157a-dk1.dts"
#include &lt;dt-bindings/rtc/rtc-stm32.h&gt;

/ {
        model = "STMicroelectronics STM32MP157C-DK2 Discovery Board";
        compatible = "st,stm32mp157c-dk2", "st,stm32mp157";

        aliases {
                serial3 = &amp;usart2;
        };

        wifi_pwrseq: wifi-pwrseq {
                compatible = "mmc-pwrseq-simple";
                reset-gpios = &lt;&amp;gpioh 4 GPIO_ACTIVE_LOW&gt;;
        };
};

&amp;dsi {
        #address-cells = &lt;1&gt;;
        #size-cells = &lt;0&gt;;
        status = "okay";

        ports {
                #address-cells = &lt;1&gt;;
                #size-cells = &lt;0&gt;;

                port@0 {
                        reg = &lt;0&gt;;
                        dsi_in: endpoint {
                                remote-endpoint = &lt;&amp;ltdc_ep1_out&gt;;
                        };
                                                              30,0-1        Top

</pre>
</div>
</div>
</div>
<div id="outline-container-org8d2b280" class="outline-5">
<h5 id="org8d2b280">3. Kernel</h5>
<div class="outline-text-5" id="text-org8d2b280">
<ol class="org-ol">
<li>set ARCH, CROSS_COMPILE</li>
<li>make</li>
</ol>

<p>
Check Kernel version on host:
</p>
<pre class="example">
uname -r
</pre>


<p>
Download Linux Kernel 4.18:
</p>
<pre class="example">
wget https://mirrors.edge.kernel.org/pub/linux/kernel/v4.x/linux-4.18.tar.xz
tart xvf linux-4.18.tar.xz
</pre>
</div>

<div id="outline-container-org6d4f4e5" class="outline-6">
<h6 id="org6d4f4e5">Apply Patches</h6>
<div class="outline-text-6" id="text-org6d4f4e5">
<p>
Download Patch Files:
</p>
<pre class="example">
wget https://mirrors.edge.kernel.org/pub/linux/kernel/v4.x/patch-4.18.gz
wget https://mirrors.edge.kernel.org/pub/linux/kernel/v4.x/patch-4.19.9.xz
</pre>


<p>
Patch the kernel from 4.18 to 4.19 and then to 4.19.9
</p>
<pre class="example">
cd linux-4.18
xzcat ../patch-4.19.xz | patch -p1
xzcat ../patch-4.19.9.xz | patch -p1
</pre>


<p>
Apply STM32MP1 - patch
</p>
<pre class="example">
patch -p1 &lt; ../../embedded-linux-4d-labs/linux-stm32/stm31mp157_support.patch 
</pre>

<p>
or 
</p>
<pre class="example">
cat ../../embedded-linux-4d-labs/linux-stm32/stm31mp157_support.patch | patch -p1
</pre>
</div>
</div>

<div id="outline-container-org8f34462" class="outline-6">
<h6 id="org8f34462">Linux kernel configuration</h6>
<div class="outline-text-6" id="text-org8f34462">
<p>
Copy Configuration file to <code>arch/arm/configs</code>
</p>
<pre class="example">
cp ../../embedded-linux-4d-labs/linux-stm32/stm31mp157_defconfig arch/arm/configs
make stm31mp157_defconfig
</pre>


<ul class="org-ul">
<li>See STM32 Wiki: <a href="https://wiki.st.com/stm32mpu/wiki/Menuconfig_or_how_to_configure_kernel">https://wiki.st.com/stm32mpu/wiki/Menuconfig_or_how_to_configure_kernel</a></li>
</ul>
</div>
</div>

<div id="outline-container-org767df9a" class="outline-6">
<h6 id="org767df9a">Cross compiling the kernel</h6>
<div class="outline-text-6" id="text-org767df9a">
<p>
Compile the kernel
</p>
<pre class="example">
make -j8
</pre>


<p>
Results in:
</p>
<pre class="example">
arch/arm/boot/zImage
arch/arm/boot/dts/stm32mp157c-dk2.dtb
</pre>
</div>
</div>

<div id="outline-container-org9d82094" class="outline-6">
<h6 id="org9d82094">Load and boot the kernel in U-Boot</h6>
<div class="outline-text-6" id="text-org9d82094">
<p>
Load both files form <code>/srv/tftp</code> to ram with U-Boot:
</p>
<pre class="example">
tftp 0xc0000000 zImage 
tftp 0xc4000000 stm32mp157c-dk2.dtb
</pre>


<p>
Now boot the kernel
</p>
<pre class="example">
bootz 0xc0000000 - 0xc4000000
</pre>
</div>

<ul class="org-ul">
<li><a id="orge44be89"></a>Boot directly from the host tftp-directory<br />
<div class="outline-text-7" id="text-orge44be89">
<p>
Instead of repeatedly moving the SD card around we can put a freshly compiled kernel
into the tpft directory of the host and boot from there.
</p>

<pre class="example">
setenv bootcmd 'tftp 0xc0000000 zImage; tftp 0xc4000000 stm32mp157c-dk2.dtb; bootz 0xc0000000 - 0xc4000000'
</pre>

<p>
Save this boot option into a variable
</p>
<pre class="example">
setenv bootcmdtftp ${bootcmd}
saveenv
</pre>
</div>
</li>
</ul>
</div>

<div id="outline-container-orgaac9a74" class="outline-6">
<h6 id="orgaac9a74">Write kernel and device tree to the SD card</h6>
<div class="outline-text-6" id="text-orgaac9a74">
<p>
Move the kernel and the device tree to the SDCard:
</p>
<ul class="org-ul">
<li>just copy <code>zImage</code> and <code>stm32mp157c-dk2.dtb</code> to 
the automatically mounted folder: <code>media/jh/boot</code>.</li>
</ul>

<p>
In U-Boot, set the <code>bootcmd</code> <br />
individual commands:
</p>
<pre class="example">
ext2load mmc 0:4 0xc0000000 zImage
ext2load mmc 0:4 0xc4000000 stm32mp157c-dk2.dtb
bootz 0xc0000000 - 0xc4000000
</pre>


<p>
Store to variable:
</p>
<pre class="example">
setenv bootcmd 'ext2load mmc 0:4 0xc0000000 zImage; ext2load mmc 0:4 0xc4000000 stm32mp157c-dk2.dtb; bootz 0xc0000000 - 0xc4000000'
</pre>
</div>
</div>

<div id="outline-container-orgb07c095" class="outline-6">
<h6 id="orgb07c095">Compile Kernel on Ubuntu</h6>
<div class="outline-text-6" id="text-orgb07c095">
<p>
Get the kernel sources
</p>
<pre class="example">
wget https://cdn.kernel.org/pub/linux/kernel/v5.x/linux-5.8.12.tar.xz
</pre>

<p>
Unzip the source
</p>
<pre class="example">
tar xf linux-5.8.12.tar.xz 
</pre>

<p>
Copy the existing config file
</p>
<pre class="example">
cd linux-5.8.12
cp /boot/config-5.4.0-48-generic .config
</pre>

<p>
Set Architecture
</p>
<pre class="example">
export ARCH=x86_64
make menuconfig
</pre>

<p>
Build the kernel binary (using 8 cores)
</p>
<pre class="example">
make -j8
</pre>

<p>
Install kernel
</p>
<pre class="example">
sudo make modules_install
</pre>

<p>
(this installs the .ko files to <code>lib/modules</code>)
</p>
<pre class="example">
sudo make install
</pre>

<p>
   (this copies <code>vmlinuzXXX</code>, <code>initrd.imgXXX</code>, <code>System.mapXXX</code> to <code>/boot</code>)
Update grub 
</p>
<pre class="example">
sudo grub2-mkconfig -o /boot/grub2/grub.cfg
sudo grubby --set-default /boot/vmlinuz-5.6.9
</pre>
</div>
</div>
</div>

<div id="outline-container-org66394e1" class="outline-5">
<h5 id="org66394e1">4. BusyBox</h5>
<div class="outline-text-5" id="text-org66394e1">
</div>
<div id="outline-container-orgd2ef920" class="outline-6">
<h6 id="orgd2ef920">Install NFS server</h6>
<div class="outline-text-6" id="text-orgd2ef920">
<p>
Install nfs-kernel-server
</p>
<pre class="example">
sudo apt install nfs-kernel-server
</pre>

<p>
Add the following line in <code>sudo vim /etc/exports</code>
</p>
<pre class="example">
/home/jh/embedded-linux-4d-labs/tinysystem/nfsroot 192.168.10.211(rw,no_root_squash,no_subtree_check)
</pre>

<p>
Restart NFS-server
</p>
<pre class="example">
sudo service nfs-kernel-server restart
</pre>

<p>
In U-Boot 
</p>
<pre class="example">
setenv bootargs ${bootargs} root=/dev/nfs ip=192.168.10.211:::::eth0 nfsroot=192.168.10.204:/home/jh/embedded-linux-4d-labs/tinysystem/nfsroot,nfsvers=3,tcp rw
saveenv
</pre>

<p>
Download configure and build BusyBox
</p>
<pre class="example">
wget https://www.busybox.net/downloads/busybox-1.31.1.tar.bz2
tar xf busybox-1.31.1.tar.bz2 
cp ../../embedded-linux-4d-labs/tinysystem/data/busybox-1.32.config .config
make
make menuconfig
</pre>

<p>
(set Settings Install Options to <code>../nfsroot</code>)
</p>
<pre class="example">
make install
</pre>
</div>
</div>

<div id="outline-container-org8f93f4c" class="outline-6">
<h6 id="org8f93f4c">Configure Busybox</h6>
<div class="outline-text-6" id="text-org8f93f4c">
<p>
Running <code>bin/busybox</code> gives:
</p>
<pre class="example">
Currently defined functions:
	ash, cat, chmod, cp, df, dmesg, echo, find, flash_eraseall, grep, halt,
	httpd, ifconfig, init, insmod, kill, ln, ls, lsmod, lsusb, mkdir,
	mknod, modinfo, modprobe, more, mount, mv, nanddump, nandwrite, ping,
	poweroff, ps, pwd, reboot, rm, rmdir, rmmod, sh, sleep, swapoff, sync,
	top, touch, ubiattach, ubidetach, ubimkvol, ubirename, ubirmvol,
	ubirsvol, ubiupdatevol, umount, uname, uptime, vi, which
</pre>

<p>
System configuration
</p>
<pre class="example">
mkdir nfsroot/dev
mkdir nfsroot/proc
mkdir nfsroot/etc
</pre>


<p>
<code>init</code> configuration
</p>
<pre class="example">
vim /etc/inittab
</pre>

<p>
The content should be:
</p>
<pre class="example">
::sysinit:/etc/init.d/rcS
ttySTM0::askfirst:/bin/sh
::ctrlaltdel:/sbin/reboot
::shutdown:/bin/umount -a -r
::restart:/sbin/init
#tty2::askfirst:/bin/sh
#tty3::askfirst:/bin/sh
#tty4::askfirst:/bin/sh
</pre>

<p>
Mount <code>/proc</code> and <code>/sys</code> on system startup
</p>
<pre class="example">
vim /etc/init.d/rcS
</pre>

<p>
Make sure <code>rcS</code> is executable!
</p>
<ul class="org-ul">
<li>The content should be:</li>
</ul>
<pre class="example">
#!/bin/sh
mount -t proc nodev /proc
mount -t sysfs nodev /sys
</pre>
</div>
</div>

<div id="outline-container-org326e025" class="outline-6">
<h6 id="org326e025">Switch to shared libraries</h6>
<div class="outline-text-6" id="text-org326e025">
<p>
Compile <code>hello.c</code>
</p>
<pre class="example">
arm-linux-cc -o hello hello.c
</pre>

<p>
Transfer to target
</p>
<pre class="example">
cp hello nfsroot/usr/bin
</pre>

<p>
(executing doesn't work yet)
</p>

<p>
Copy the dynamic linker (for loading shared libraries)
</p>
<ul class="org-ul">
<li>Find it in the toolchain:</li>
</ul>
<pre class="example">
find -name ld-uClibc.so.0
</pre>

<ul class="org-ul">
<li>Copy it to the <code>/lib</code> folder</li>
</ul>
<pre class="example">
cd ~/embedded-linux-4d-labs/tinysystem/nfsroot/
cp ~/STM32MP1_Toolchain/arm-training-linux-uclibcgnueabihf/arm-training-linux-uclibcgnueabihf/sysroot/lib/ld-uClibc.so.0 lib/
</pre>

<ul class="org-ul">
<li>Copy C-Library</li>
</ul>
<pre class="example">
cp ~/STM32MP1_Toolchain/arm-training-linux-uclibcgnueabihf/arm-training-linux-uclibcgnueabihf/sysroot/lib/libc.so.0 lib/
</pre>


<p>
Now we can execute <code>hello</code>. 
</p>

<p>
Comments:
</p>
<ul class="org-ul">
<li><code>ld-uClibc.so.0</code> is a program, the loader (not a library).</li>
<li><code>libc.so.0</code> usually has the same name for all C-Libraries.</li>
</ul>
<pre class="example">
sudo view /var/log/syslog
</pre>
</div>
</div>

<div id="outline-container-org5dff0c4" class="outline-6">
<h6 id="org5dff0c4">Web Interface</h6>
<div class="outline-text-6" id="text-org5dff0c4">
<p>
Busybox is compiled with a webserver. 
</p>

<p>
Build <code>busybox</code> again with shared libraries:
</p>
<ul class="org-ul">
<li>Size: 206824 vs. 349712</li>
</ul>

<p>
Copy <code>data/www</code> to <code>nfsroot</code>
</p>

<p>
Run the http-server on the target
</p>
<pre class="example">
/usr/sbin/httpd -h /www/
</pre>

<p>
Put this to <code>/etc/init.d/rcS</code>
</p>

<p>
Check in Browser <code>http://192.168.10.211/</code>
</p>

<p>
Comments:
</p>
<ul class="org-ul">
<li><p>
<code>http://192.168.10.211/cgi-bin/uptime</code> reads directly from <code>/proc</code>
Content of <code>www/cgi-bin/cpuinfo</code>
</p>
<pre class="example">
echo "Content-type: text/html"
echo
echo "&lt;html&gt;&lt;header&gt;&lt;/header&gt;&lt;body&gt;"
echo "&lt;h1&gt;CPU information&lt;/h1&gt;"
echo "Your embedded device uses the below processor:&lt;pre&gt;&lt;font color=Blue&gt;"
echo `cat /proc/cpuinfo | grep Processor`
echo "&lt;/font&gt;&lt;/pre&gt;"
echo "&lt;p&gt;&lt;a href=\"/\"&gt;&lt;img src=\"/gohome.png\" border=\"0\"&gt;&lt;/a&gt;&lt;/p&gt;"
echo "&lt;/body&gt;&lt;/html&gt;"
</pre></li>
<li>Busybox might not be suitable for secure devices.</li>
<li>see <code>upload.c</code> in <code>cgi-bin</code> for the file upload capability.</li>
</ul>
</div>
</div>

<div id="outline-container-org47e874e" class="outline-6">
<h6 id="org47e874e">Boot with initramfs</h6>
<div class="outline-text-6" id="text-org47e874e">
<p>
Create a symbolic link <code>init -&gt; /sbin/init</code>
</p>
<pre class="example">
ln -s sbin/init .
</pre>

<p>
(the kernel will try to execute <code>/init</code>)
</p>

<p>
Recompile the kernel with the option 
</p>
<ul class="org-ul">
<li><code>General setup -&gt; Initial RAM filesystem and RAM disk</code></li>
<li>Set <code>Initramfs source file</code> to <code>../../tinysystem/nfsroot</code></li>
<li><code>make -j8</code></li>
</ul>

<p>
Mount =devtmpfs/ manually
</p>
<pre class="example">
vim nfsroot/init.d/rfS
</pre>

<ul class="org-ul">
<li>add the line</li>
</ul>
<pre class="example">
mount -t devtmpfs /nodev /dev
</pre>


<p>
Deploy new kernel 
</p>
<pre class="example">
sudo mount /dev/sdb4 /media/jh/boot
mount: /media/jh/boot: cannot mount; probably corrupted filesystem on /dev/sdb4.
</pre>


<p>
Coudn't mount boot - partition, so reformat partition
</p>
<pre class="example">
save U-Boot.cnf before !
sudo mkfs.ext2 -L boot /dev/sdb4
</pre>


<p>
Comments:
</p>
<ul class="org-ul">
<li>EVERY time you change something in the rootfs, the kernel has to be recompiled when using
initramfs (easy to forget).</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org9f77dd3" class="outline-5">
<h5 id="org9f77dd3">5. Block Filesystems</h5>
<div class="outline-text-5" id="text-org9f77dd3">
<ul class="org-ul">
<li>Video: <a href="file://SERVER/team/Development/STM32MP1/Linux/Bootlin Training/Embedded Linux/Day 6/bootlin-embedded-linux-sep2020 on 2020-10-05 16-09.mp4">bootlin-embedded-linux-sep2020 on 2020-10-05 16-09.mp4</a></li>
</ul>

<p>
Comments:
</p>
<ul class="org-ul">
<li>MCU-ROM will always boot from MMC first.</li>
<li><a href="https://bootlin.com/blog/find-root-device/">https://bootlin.com/blog/find-root-device/</a></li>
</ul>

<p>
We have so far:
</p>
<ul class="org-ul">
<li>2 U-Boot SPL partitions</li>
<li>1 U-Boot partition</li>
<li>1 boot partition (kernel + device tree blob)</li>
</ul>

<p>
We'll add a data partition (#6) and a rootfs partition (#5) from which we'll 
also boot. 
</p>
</div>

<div id="outline-container-orgef534fd" class="outline-6">
<h6 id="orgef534fd">Recompile your kernel with support for SquashFS and ext4</h6>
<div class="outline-text-6" id="text-orgef534fd">
<ul class="org-ul">
<li>disable initramfs in the kernel if enables</li>
</ul>
<pre class="example">
make menuconfig
-&gt; General setup -&gt; Initramfs
-&gt; File Systems -&gt; ext4
-&gt; File Systems -&gt; Miscellaneous filesystems
</pre>


<p>
Check filesystem support with 
</p>
<pre class="example">
cat /proc/filesystems
</pre>
</div>
</div>

<div id="outline-container-orged918ac" class="outline-6">
<h6 id="orged918ac">Create additional partitions: partition 5: 2MB, partition 6: rest of SD card</h6>
<div class="outline-text-6" id="text-orged918ac">
<pre class="example">
sudo umount /dev/sdb*
sudo cfdisk /dev/sdb 
</pre>

<p>
or 
</p>
<pre class="example">
sudo parted /dev/sdb
</pre>
</div>
</div>

<div id="outline-container-org43acf89" class="outline-6">
<h6 id="org43acf89">Create a journaled file system on partition 6</h6>
<div class="outline-text-6" id="text-org43acf89">
<pre class="example">
sudo mkfs.ext4 -L data -E nodiscard /dev/sdb6
</pre>

<p>
(<code>-L</code> - volumen name, <code>-E nodiscard</code> - disables bad block discarding, faster)
</p>

<p>
Mount partition 6 on <code>/www/upload/files</code>.
</p>
<pre class="example">
mount /dev/mmcblk0p6 /www/upload/files/
</pre>


<p>
Comment:
</p>
<ul class="org-ul">
<li>kernel needs to support ext4, check with <code>cat /proc/filesystems</code>.</li>
</ul>
</div>
</div>

<div id="outline-container-orge1754a2" class="outline-6">
<h6 id="orge1754a2">Add a tmpfs partition</h6>
<div class="outline-text-6" id="text-orge1754a2">
<p>
Mount a <code>tmpfs</code> filesystem for <code>upload.log</code>
</p>
<pre class="example">
mount -t tmpfs log /var/log
</pre>
</div>
</div>
<div id="outline-container-org2b7aa0f" class="outline-6">
<h6 id="org2b7aa0f">Booting from a SquashFS partition</h6>
<div class="outline-text-6" id="text-org2b7aa0f">
<p>
Store the rootfs on the 5th partition.
</p>
</div>

<ul class="org-ul">
<li><a id="org84535c0"></a>Install the squashfs-tools<br />
<div class="outline-text-7" id="text-org84535c0">
<p>
On the host
</p>
<pre class="example">
sudo apt install squashfs-tools
</pre>

<p>
Create a SquashFS image of the nfsroot directory (see Using block filesystems).
(creating an empty fs would be useless, since it's read only).
</p>
<pre class="example">
sudo mksquashfs nfsroot/ rootfs.sqfs -noappend
</pre>

<p>
(<code>-noappend</code> is not really needed the first time, but when repeating this step)
Copy the fs image to the 5th partition on the sd-card
</p>
<pre class="example">
sudo dd if=rootfs.sqfs of=/dev/sdb5 bs=4M
</pre>

<p>
(when you don't specify bs it will be 4k - slow)
</p>
</div>
</li>

<li><a id="orgfeeadd0"></a>Boot from the SquashFS partition<br />
<div class="outline-text-7" id="text-orgfeeadd0">
<p>
Try mounting the 5th partition
</p>
<pre class="example">
mkdir /tmp
mount -t squashfs /dev/mmcblk0p5 /tmp
</pre>


<p>
Save nfsroot - bootargs
</p>
<pre class="example">
setenv nfsbootargs ${bootargs}
</pre>

<p>
check with 
</p>
<pre class="example">
printenv nfsbootargs
nfsbootargs=root=/dev/nfs ip=192.168.10.211:::::eth0 nfsroot=192.168.10.204:/home/jh/embedded-linux-4d-labs/tinysystem/nfsroot,nfsvers=3,tcp rw
</pre>


<p>
Configure the kernel command line to use the 5th partition as rootfs. 
Just change the original bootargs.
Also add <code>rootwait</code> to wait for proper SD card initialization.
</p>
<pre class="example">
setenv bootargs root=/dev/mmcblk0p5 ip=192.168.10.211:::::eth0 rootwait
saveenv 
</pre>

<p>
Reboot and check with <code>mount</code>. 
</p>

<ul class="org-ul">
<li>See "Find the root device" : <a href="https://bootlin.com/blog/find-root-device/">https://bootlin.com/blog/find-root-device/</a></li>
</ul>
</div>
</li>
</ul>
</div>
</div>

<div id="outline-container-org83bae35" class="outline-5">
<h5 id="org83bae35">6. Flash Filesystems</h5>
<div class="outline-text-5" id="text-org83bae35">
<ul class="org-ul">
<li>Video: see Day 6</li>
</ul>

<p>
Install <code>mtd-utils</code>
</p>

<p>
In kernel config we need:
<code>CONFIG_MTD_CMDLINE_PARTS=y</code>
</p>

<p>
Set MTD partitions
In U-Boot:
</p>
<pre class="example">
nand info  gives -&gt; nand0
setenv mtdids nand0=atmel_nand
setenv mtdparts mtdparts=atmel_nand:256k(bootstrap)ro,768k(u-boot)ro,256k(u-boot-env2)ro,256k(u-boot-env1)ro,-(UBI) 
</pre>


<pre class="example">
setenv bootargs_base console=ttyS0,115200 rootfstype=ubifs %root=ubi0:root ip=192.168.0.100:::::eth0 ubi.mtd=UBI ro
setenv bootcmd 'ubi part UBI; ubi readvol 0x21000000 kernel;
</pre>


<pre class="example">
nand info
</pre>

<p>
Erase block size
Page size
</p>

<pre class="example">
ubi info
</pre>
</div>
</div>
<div id="outline-container-orgd246335" class="outline-5">
<h5 id="orgd246335">7. Third party libraries and applications</h5>
<div class="outline-text-5" id="text-orgd246335">
<ul class="org-ul">
<li>Video: <a href="file://SERVER/team/Development/STM32MP1/Linux/Bootlin Training/Embedded Linux/Day 7/bootlin-embedded-linux-sep2020 on 2020-10-06 17-04.mp4">bootlin-embedded-linux-sep2020 on 2020-10-06 17-04.mp4</a> (29 min)</li>
</ul>

<p>
Build a mediaplayer. For that we cross compile various libraries.
</p>
<ul class="org-ul">
<li><a href="https://xiph.org/">https://xiph.org/</a></li>
</ul>

<p>
Switch back to the nfsroot booting
</p>
<pre class="example">
setenv bootargs ${nfsbootargs}
saveenv
</pre>
</div>

<div id="outline-container-orgaf000e6" class="outline-6">
<h6 id="orgaf000e6">Add Audio support to the kernel</h6>
<div class="outline-text-6" id="text-orgaf000e6">
<p>
Required options are:
<code>CONFIG_SOUND</code>, <code>CONFIG_SND</code>, <code>CONFIG_SND_USB</code>, <code>CONIFG_SND_USB_AUDIO</code> 
</p>

<pre class="example">
make -j8
</pre>


<p>
Deploy new kernel:
</p>
<pre class="example">
sudo cp arch/arm/boot/zImage /media/jh/boot/
</pre>
</div>
</div>

<div id="outline-container-org19af20e" class="outline-6">
<h6 id="org19af20e">Figure out library dependencies</h6>
<div class="outline-text-6" id="text-org19af20e">
<ul class="org-ul">
<li>Try to compile - run into errors.</li>
<li>or: Read the documentation.</li>
</ul>
</div>
</div>

<div id="outline-container-org470d367" class="outline-6">
<h6 id="org470d367">Preparation</h6>
<div class="outline-text-6" id="text-org470d367">
<p>
We need 2 spaces (staging &amp; target) in <code>thirdparty</code>.
</p>
<ul class="org-ul">
<li>staging space : install packages, non-stripped libraries, headers, docu, etc. needed for compilation.</li>
<li>target space : binaries and libraries stripped, configuration files, etc. needed to run the system.</li>
</ul>

<pre class="example">
mkdir ~/embedded-linux-4d-labs/thirdparty
cd ~/embedded-linux-4d-labs/thirdparty
mkdir staging target
</pre>


<p>
Copy BusyBox nfsroot to target space
</p>
<pre class="example">
cp -a ../tinysystem/nfsroot/* target/
</pre>


<p>
Export the new directory for NFS
</p>
<pre class="example">
sudo vim /etc/exports
home/jh/embedded-linux-4d-labs/thirdparty/target 192.168.10.211(rw,no_root_squash,no_subtree_check)
</pre>

<p>
Restart NFS server
</p>
<pre class="example">
sudo service nfs-kernel-server restart
</pre>


<p>
Boot from this new rootfs
</p>
<pre class="example">
setenv bootargs 'root=/dev/nfs ip=192.168.10.211:::::eth0 nfsroot=192.168.10.204:/home/jh/embedded-linux-4d-labs/thirdparty/target,nfsvers=3,tcp rw'
saveenv
</pre>
</div>
</div>

<div id="outline-container-org9f5983c" class="outline-6">
<h6 id="org9f5983c">Cross compile libraries</h6>
<div class="outline-text-6" id="text-org9f5983c">
<ul class="org-ul">
<li>download</li>
<li>conifgure</li>
<li>make</li>
<li>make install</li>
</ul>
</div>
<ul class="org-ul">
<li><a id="org770d371"></a>alsa-lib<br /></li>
<li><a id="orge255622"></a>Alsa-utils<br /></li>
<li><a id="org62da15b"></a>libogg<br />
<div class="outline-text-7" id="text-org62da15b">
<p>
player
</p>
</div>
</li>
<li><a id="orgaa204f0"></a>libvorbis<br /></li>
<li><a id="org4930b87"></a>libao<br /></li>
<li><a id="orga2c6f2d"></a>vorbis-tools<br /></li>
</ul>
</div>
</div>
<div id="outline-container-org8c5c6df" class="outline-5">
<h5 id="org8c5c6df">8. Buildroot</h5>
<div class="outline-text-5" id="text-org8c5c6df">
<p>
Same system as before but with buildroot.
</p>
</div>

<div id="outline-container-orge796d0e" class="outline-6">
<h6 id="orge796d0e">Get Buildroot</h6>
</div>
<div id="outline-container-org868d0e4" class="outline-6">
<h6 id="org868d0e4">Configure</h6>
</div>
</div>
<div id="outline-container-org658cbaa" class="outline-5">
<h5 id="org658cbaa">9. Application development</h5>
<div class="outline-text-5" id="text-org658cbaa">
<p>
Buildroot helps to develop applications. 
</p>
</div>
</div>

<div id="outline-container-org09b3b99" class="outline-5">
<h5 id="org09b3b99">10. Remote debugging</h5>
<div class="outline-text-5" id="text-org09b3b99">
</div>
<div id="outline-container-org1432dd0" class="outline-6">
<h6 id="org1432dd0">strace</h6>
<div class="outline-text-6" id="text-org1432dd0">
<pre class="example">
strace vista-emulator
</pre>
</div>
</div>
<div id="outline-container-orga3560d7" class="outline-6">
<h6 id="orga3560d7">ltrace</h6>
<div class="outline-text-6" id="text-orga3560d7">
<pre class="example">
ltrace -c vista-emulator
</pre>
</div>
</div>

<div id="outline-container-orga606cfd" class="outline-6">
<h6 id="orga606cfd">gdbserver</h6>
<div class="outline-text-6" id="text-orga606cfd">
<p>
Start <code>gdbserver</code> on the target.
</p>
<pre class="example">
gdbserver localhost:2345 vista-emulator
</pre>

<p>
Start debugger on the host.
</p>
<pre class="example">
arm-linux-gdb vista-emulator
(gdb) set sysroot /home/&lt;user&gt;/embedded-linux-4d-labs/debugging/buildroot-2020.02.&lt;n&gt;/output/staging
(gdb) target remote &lt;target-ip-address&gt;:2345
</pre>


<pre class="example">
(gdb) backtrace
(gdb) frame 2
</pre>


<pre class="example">
(gdb) frame 0
(gdb) dissassemble
</pre>
</div>
</div>
<div id="outline-container-org63f9f45" class="outline-6">
<h6 id="org63f9f45">Post mortem analysis</h6>
<div class="outline-text-6" id="text-org63f9f45">
<p>
On the target
</p>
<pre class="example">
ulimit -c unlimited
/vista-emulator
</pre>


<p>
On the host
</p>
<pre class="example">
cd nfsroot/boot
sudo chown -R
sudo arm-linux-gdb -c core ../../data/vista-emulator
</pre>
</div>
</div>
</div>
<div id="outline-container-org39eea30" class="outline-5">
<h5 id="org39eea30">11. Real time Linux</h5>
</div>
</div>
</div>

<div id="outline-container-org20057fd" class="outline-3">
<h3 id="org20057fd">Yocto Project Training (Bootlin)</h3>
<div class="outline-text-3" id="text-org20057fd">
</div>
<div id="outline-container-org2ef927a" class="outline-4">
<h4 id="org2ef927a">Links</h4>
<div class="outline-text-4" id="text-org2ef927a">
<ul class="org-ul">
<li>Glossary: <a href="https://www.yoctoproject.org/docs/current/ref-manual/ref-manual.html#ref-variables-glossary">https://www.yoctoproject.org/docs/current/ref-manual/ref-manual.html#ref-variables-glossary</a></li>
<li>Mega Manual: <a href="https://www.yoctoproject.org/docs/current/mega-manual/mega-manual.html">https://www.yoctoproject.org/docs/current/mega-manual/mega-manual.html</a></li>
<li>Poky Layers: <a href="https://layers.openembedded.org/layerindex/branch/master/layers/">https://layers.openembedded.org/layerindex/branch/master/layers/</a></li>
<li>linux-yocto: <a href="https://www.yoctoproject.org/docs/2.5/kernel-dev/kernel-dev.html#kernel-dev-advanced">https://www.yoctoproject.org/docs/2.5/kernel-dev/kernel-dev.html#kernel-dev-advanced</a></li>
<li>BitBake User Manual: <a href="https://www.yoctoproject.org/docs/1.6/bitbake-user-manual/bitbake-user-manual.html">https://www.yoctoproject.org/docs/1.6/bitbake-user-manual/bitbake-user-manual.html</a></li>
<li>Available packages: <a href="http://recipes.yoctoproject.org/">http://recipes.yoctoproject.org/</a></li>
<li>Yocto Project Development Tasks Manual:  <a href="https://www.yoctoproject.org/docs/2.5/dev-manual/dev-manual.html">https://www.yoctoproject.org/docs/2.5/dev-manual/dev-manual.html</a></li>
<li><code>repo</code> Docu: <a href="https://source.android.com/source/using-repo.html">https://source.android.com/source/using-repo.html</a></li>
<li>Wiki: <a href="https://wiki.yoctoproject.org/wiki/Main_Page">https://wiki.yoctoproject.org/wiki/Main_Page</a></li>
</ul>
</div>
</div>

<div id="outline-container-org84802fd" class="outline-4">
<h4 id="org84802fd">Important Files and Variables</h4>
<div class="outline-text-4" id="text-org84802fd">
<ul class="org-ul">
<li><code>poky/oe-init-build.env</code> : script</li>
<li><code>build/conf/local.conf</code></li>
<li><code>build/conf/bblayers.conf</code></li>
</ul>

<p>
Variables
</p>
<ul class="org-ul">
<li><code>IMAGE_INSTALL</code> : lists the packages to be used.</li>
</ul>
</div>
</div>

<div id="outline-container-org9c9789e" class="outline-4">
<h4 id="org9c9789e">Linux System Basics</h4>
<div class="outline-text-4" id="text-org9c9789e">
<ul class="org-ul">
<li><b>Userspace</b>
<ul class="org-ul">
<li>C library (glibc, uclibc) 
<ul class="org-ul">
<li>syscalls: connection to kernel</li>
</ul></li>
<li>Applications and other libraries
<ul class="org-ul">
<li>in "/"</li>
</ul></li>
</ul></li>
<li><b>Kernel</b>
<ul class="org-ul">
<li>monolithic: one binary + modules</li>
<li>device drivers</li>
<li>filesystems</li>
<li>networking</li>
<li>task/memory management</li>
</ul></li>
<li><b>Bootloader</b>
<ul class="org-ul">
<li>maybe multistage bootloaders</li>
</ul></li>
<li><b>Hardware</b></li>
</ul>
</div>

<div id="outline-container-org48eabb7" class="outline-5">
<h5 id="org48eabb7">Boot sequence</h5>
<div class="outline-text-5" id="text-org48eabb7">
<pre class="example">
ROM code -&gt; Bootloader -&gt; Kernel -&gt; /sbin/init -&gt; shell, GUI, etc. 
</pre>


<ul class="org-ul">
<li>first stage bl: init RAM, load DTB and kernel to RAM</li>
</ul>
<p>
or
</p>
<ul class="org-ul">
<li>second stage bl: u-Boot, barebox loading DTB and kernel</li>

<li>load from Flash, emmc, etc.</li>
<li>bootloader passes parameters to kernel
<ul class="org-ul">
<li>location of root FS</li>
</ul></li>
<li><code>sbin/init</code> first binary that is started (e.g. <code>systemd</code>, <code>system5</code>, etc.)</li>
</ul>
</div>
</div>

<div id="outline-container-org4c89592" class="outline-5">
<h5 id="org4c89592">Device Tree</h5>
<div class="outline-text-5" id="text-org4c89592">
<p>
Description of hardware on SOC and board level. 
Same kernel can be used for different systems. 
</p>
</div>
</div>

<div id="outline-container-org92a5e0e" class="outline-5">
<h5 id="org92a5e0e">Linux development</h5>
<div class="outline-text-5" id="text-org92a5e0e">
<ul class="org-ul">
<li><b>BSP</b> (board support package): porting bootloaders and kernel</li>
<li><b>system integration</b>: putting the whole system together (distribution, Yocto)</li>
<li><b>application development</b></li>
</ul>

<p>
Yocto is about bundling everything together. 
User space integration is complex. Applications depend on libraries, databases, other 
applications, etc. This is where Yocto should help. 
</p>

<p>
System integration can be done
</p>
<ul class="org-ul">
<li>manually</li>
<li>using binary distributions (Ubuntu, Debian, etc.)</li>
<li>build systems</li>
</ul>
</div>
</div>

<div id="outline-container-orgbe7f637" class="outline-5">
<h5 id="orgbe7f637">Build systems</h5>
<div class="outline-text-5" id="text-orgbe7f637">
<p>
Yocto/OpenEmbedded, Buildroot, PTXdist, OpenWRT
</p>

<p>
<b>INPUT</b>
</p>
<ul class="org-ul">
<li>source code (kernel, bootloader, libraries, applications, etc.)</li>
<li>configuration for the build (makefiles, names, where to install, dependencies, etc.)</li>
</ul>

<p>
<b>OUTPUT</b>:
</p>
<ul class="org-ul">
<li>root FS image</li>
<li>kernel image</li>
<li>bootloader</li>
<li>toolchain (compiler, assembler, linker, debugger), cross compiling</li>
</ul>

<p>
Requirements:
</p>
<ul class="org-ul">
<li>8+ cores, 1TB disk space</li>
</ul>

<p>
Buildroot
</p>
<ul class="org-ul">
<li>based on makefiles</li>
<li>no binary packages, only builds a root FS</li>
</ul>

<p>
Yocto
</p>
<ul class="org-ul">
<li>you can use packages, to be installed (.deb, etc. )</li>
</ul>
</div>
</div>

<div id="outline-container-org073a3f2" class="outline-5">
<h5 id="org073a3f2">Linux Foundation</h5>
<div class="outline-text-5" id="text-org073a3f2">
<p>
employs
</p>
<ul class="org-ul">
<li>main kernel developers</li>
<li>core yocto developers</li>
</ul>
<p>
organizes
</p>
<ul class="org-ul">
<li>community work: conferences, etc. (embedded linux conferance)</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orge891d02" class="outline-4">
<h4 id="orge891d02">Yocto Basics</h4>
<div class="outline-text-4" id="text-orge891d02">
<p>
The Yocto Project is a collection of tools, templates and methods for building
an embedded Linux system.
</p>

<p>
Core components
</p>
<ul class="org-ul">
<li><code>BitBake</code> : build engine (like <code>make</code>), to be found in <code>poky/bitbake</code></li>
<li><code>OpenEmbedded-Core</code> : recipes, layers, classes for OpenEmbedded systems</li>
<li><code>Poky</code> : reference Linux system</li>
</ul>

<p>
Glossary
</p>
<ul class="org-ul">
<li><a href="https://www.yoctoproject.org/docs/current/ref-manual/ref-manual.html#ref-variables-glossary">https://www.yoctoproject.org/docs/current/ref-manual/ref-manual.html#ref-variables-glossary</a></li>
</ul>
</div>

<div id="outline-container-orge2e9e9b" class="outline-5">
<h5 id="orge2e9e9b">Layers and Recipes</h5>
<div class="outline-text-5" id="text-orge2e9e9b">
<p>
<b>Recipes</b> (<code>.bb</code> - files) describe how to 
</p>
<ul class="org-ul">
<li>fetch source</li>
<li>configure</li>
<li>compile</li>
<li>package</li>
</ul>
<p>
applications and images. 
</p>

<p>
<b>Layers</b> are sets or recipes for a common purpose (e.g. <code>meta-qt5</code>, <code>meta-poky</code>, <code>meta-st-stm32mp</code>)
</p>

<ul class="org-ul">
<li>Layers reside in folders named <i>meta-X</i> which in turn contain folders named <i>recipes-X</i>.</li>
</ul>

<p>
Both layers and recipes are folders. 
</p>

<p>
Example: STM32MP1 - development board
</p>
<ul class="org-ul">
<li><code>poky</code></li>
<li><code>meta-st-stm32mp</code></li>
<li><code>meta-openembedded</code></li>
</ul>
<p>
are used together. 
</p>

<p>
Download Poky
<a href="https://git.yoctoproject.org/cgit/">https://git.yoctoproject.org/cgit/</a>
</p>

<p>
<code>dunfell</code> LTS-branch (<a href="https://wiki.yoctoproject.org/wiki/Releases">https://wiki.yoctoproject.org/wiki/Releases</a>)
</p>
</div>
</div>

<div id="outline-container-org00c839d" class="outline-5">
<h5 id="org00c839d">Poky</h5>
<div class="outline-text-5" id="text-org00c839d">
<p>
<a href="https://www.yoctoproject.org/docs/current/mega-manual/mega-manual.html">https://www.yoctoproject.org/docs/current/mega-manual/mega-manual.html</a>
</p>

<p>
In the <code>poky</code> folder:
</p>
<ul class="org-ul">
<li>bitbake/</li>
<li>meta-skeleton</li>
<li>meta-yocto-bsp</li>
<li>meta-poky</li>
<li><code>/poky/oe-init-build-env</code> : shell - script to configure the build environment, needs to be sourced not executed.</li>
</ul>
</div>
</div>

<div id="outline-container-orge8f9bd6" class="outline-5">
<h5 id="orge8f9bd6">Environment Setup</h5>
<div class="outline-text-5" id="text-orge8f9bd6">
<p>
The script <code>oe-init-build-env</code> sets up the build environment and the corresponding environment
variables needed for the <b>bitbake</b> command. 
</p>
<ul class="org-ul">
<li>has to be sourced.</li>
<li>creates the build directory</li>
<li>can't use bitbake without sourcing this file</li>
<li><code>BUILDDIR</code> and <code>PATH</code>.</li>
</ul>

<p>
The build is done in the <code>build</code> directory. It can be safely removed. 
</p>
</div>

<div id="outline-container-org3b33525" class="outline-6">
<h6 id="org3b33525">The <code>build/</code> directory</h6>
<div class="outline-text-6" id="text-org3b33525">
<p>
Temporary directory. 
</p>

<ul class="org-ul">
<li><code>conf/</code> : Configuration files (<code>bblayers.conf</code>, <code>local.conf</code>)</li>
<li><code>dwonloads/</code> : Downloaded tarballs.</li>
<li><code>sstate-cache/</code> : Shared state cache, if you have a build already it can be shared with others.</li>
<li><code>tmp/</code> : build system outputs.
<ul class="org-ul">
<li><code>tmp/buildstats/</code> : build statistics (e.g. elapsed time)</li>
<li><code>tmp/deploy/</code> : Final output.</li>
<li><code>tmp/deploy/images/</code> : contains the final image to flash the target.</li>
<li><code>tmp/work</code> : unpack, configure, build etc. is done here.</li>
<li><code>tmp/sysroots/</code> : shared libraries and headers.</li>
</ul></li>
</ul>

<p>
<code>sysroot</code> contains the same stuff as a <b>Root FS</b>, however it's only used during compilation. Header files are here for 
cross compilation, but you don't want to have them on the target. In Yocto there is one sysroot per package to be able
to build packages in parallel. 
</p>

<p>
You might want to make a copy of the <code>downloads/</code> directory for long term support. 
</p>
</div>

<ul class="org-ul">
<li><a id="orgf11848f"></a>Configuration<br />
<div class="outline-text-7" id="text-orgf11848f">
<ul class="org-ul">
<li><code>bblayers.conf</code> : List all layers to be used in the build.</li>
<li><code>local.conf</code> : current user relative information.</li>
</ul>
</div>
</li>
</ul>
</div>
</div>

<div id="outline-container-org6be5068" class="outline-5">
<h5 id="org6be5068">Configuring the build system</h5>
<div class="outline-text-5" id="text-org6be5068">
<ul class="org-ul">
<li><code>conf/local.conf</code> : configuration variables for the current user.</li>
<li><code>conf/bblayers.conf</code> : list of available layers.</li>
</ul>

<p>
Important variables
</p>
<ul class="org-ul">
<li><code>BB_NUMBER_THREADS</code> : default is nr. of cpus</li>
<li><code>PARALLEL_MAKE</code> : parallel processes. default is nr. of cpus</li>
<li><code>MACHINE</code> : e.g. <code>beaglebone</code>, <code>stm32mp1</code>, etc.</li>
</ul>

<p>
All variables can be overridden in <code>conf/local.conf</code>. 
</p>
</div>


<div id="outline-container-orgd657e5d" class="outline-6">
<h6 id="orgd657e5d">Packages</h6>
</div>
<div id="outline-container-org7528dae" class="outline-6">
<h6 id="org7528dae">BitBake</h6>
</div>
</div>
</div>
<div id="outline-container-org417279f" class="outline-4">
<h4 id="org417279f">Packages</h4>
<div class="outline-text-4" id="text-org417279f">
<p>
Packages are contained in a layer.
</p>

<p>
List packages in the layers in <code>bblayers.conf</code>: <code>bitbake -s</code>.
</p>
</div>

<div id="outline-container-org28e5a0f" class="outline-5">
<h5 id="org28e5a0f">Selection</h5>
<div class="outline-text-5" id="text-org28e5a0f">
<ul class="org-ul">
<li><code>IMAGE_INSTALL</code> : includude a package</li>
<li><code>PACKAGE_EXLUDE</code> : exclude a package</li>
</ul>
</div>
</div>

<div id="outline-container-org10f7322" class="outline-5">
<h5 id="org10f7322">Common BitBake options</h5>
<div class="outline-text-5" id="text-org10f7322">
<pre class="example">
bitbake [target]
</pre>


<p>
BitBake takes care of the state of tasks using stamp files.
</p>

<ul class="org-ul">
<li><code>c &lt;task&gt;</code> : execute a given task</li>
<li><code>-s</code> : list all locally available packages with versions</li>
<li><code>-f</code> : force running a task</li>
</ul>

<p>
Examples:
</p>
<pre class="example">
bitbake -c .isttasks virtual/kernel
</pre>

<p>
List available tasks for the recipe for package <code>virtual/kernel</code>.
</p>
</div>
</div>

<div id="outline-container-org5aaec12" class="outline-5">
<h5 id="org5aaec12">Package Variants (Virtual Packages)</h5>
<div class="outline-text-5" id="text-org5aaec12">
<p>
Functionalities that should be used by multiple packages are handled with
<b>virtual packages</b> (naming <code>virtual/&lt;name&gt;</code>). A recipe that depends on such a package might use e.g.
<code>DEPENDS virtual/kernel</code> instead of specifying a specific package. The actual package will then be 
selected with <code>PREFERRED_PROVIDER_virtual/kernel</code>.
</p>

<p>
Only one of the packages will be integrated in the final image. 
</p>

<p>
Notes:
</p>
<ul class="org-ul">
<li>Recipe tasks can run independently.</li>
<li>Some packages might provide the same functionality (OpenSSH vs. Dropbear (small), gnulib vs. uclibc (small)).</li>
</ul>

<p>
The OpenEmbedded build system uses configuration variables.
All variables can be overridden in <code>$BUILDDIR/conf/local.conf</code>. 
</p>

<p>
Examples:
</p>
<ul class="org-ul">
<li><code>virtual/bootloader</code></li>
<li><code>virtual/kernel</code></li>
<li><code>virtual/libc</code></li>
<li><code>virtual/xserver</code></li>
</ul>

<p>
Select variants with the <code>PREFERRED_PROVIDER</code> configuration variable.
</p>

<p>
Examples:
</p>
<pre class="example">
PREFERRED_PROVIDER_virtual/libgl = "mesa"
PREFERRED_PROVIDER_virtual/kernel = "linux-stm32mp"
</pre>


<p>
Explicitly select a version:
</p>
<pre class="example">
PREFERRED_VERSION_linux-yocto = "3.10%"
PREFERRED_VERSION_python = "2.7.3"
</pre>


<pre class="example">
bitbake -vn virtual/kernel
</pre>
</div>
</div>

<div id="outline-container-org6af6074" class="outline-5">
<h5 id="org6af6074">Add and remove values from variables (conditionally)</h5>
<div class="outline-text-5" id="text-org6af6074">
<ul class="org-ul">
<li>append : add <code>_append</code> to a variable name to append values</li>
<li>prepend : add <code>_prepend</code> to a variable name to prepend values</li>
</ul>

<p>
Example:
</p>
<pre class="example">
IMAGE_INSTALL_append = " dropbear"
FILESEXTRAPATHS_prepend := "${THISDIR}/${PN}:"
</pre>


<p>
The <code>IMAGE_INSTALL</code> variable controls the packages included into the output image.
</p>

<p>
Example:
</p>
<pre class="example">
IMAGE_INSTALL = "busybox mtd-utils"
IMAGE_INSTALL_append = " dropbear"
IMAGE_INSTALL_append_beaglebone = " i2c-tools"
</pre>

<p>
or
</p>
<pre class="example">
IMAGE_INSTALL_beaglebone = "busybox dropbear mtd-utils i2c-tools"
IMAGE_INSTALL = "busybox dropbear mtd-utils"
</pre>


<p>
This will result in <code>"busybox mtd-utils dropbear i2c-tools"</code> if the machine is <code>beaglebone</code> or
<code>"busybox mtd-utils dropbear"</code> if not. 
</p>

<p>
Append the machine name to have a configuration only for a given machine. 
<code>MACHINEOVERRIDES</code>, include <code>MACHINE</code> and <code>SOC_FAMILY</code>
</p>

<p>
Example:
</p>
<pre class="example">
KERNEL_DEVICETREE_beaglebone = "am335x-bone.dtb"
</pre>

<p>
only added when machine is <code>beaglebone</code>. 
</p>

<p>
Operators that might be used to change values of variables.
</p>
<ul class="org-ul">
<li><code>=</code>  : expand value when used</li>
<li><code>:=</code> : expand value immediately</li>
</ul>

<pre class="example">
# configuration file file.conf
cd A
FOO = ${PWD}
BAR := ${PWD}

cd B
echo $FOO =&gt; B   - expanded here
echo $BAR =&gt; A   - expanded at the time of assignment
</pre>

<ul class="org-ul">
<li><code>+=</code> : append with space</li>
<li><code>=+</code> : prepend with space</li>
</ul>

<pre class="example">
# file1.conf
TEST ?= "default_value"

# file2.conf
TEST += "another_value"
TEST_append = " another_value"   - will always result in "default_value another_value"

the fineal value will be
- if file1.conf is parsed first =&gt; "default_value another_value"
- if file2.conf is paresd first =&gt; "another_value"
</pre>

<p>
In .conf files use "_append"!
</p>

<ul class="org-ul">
<li><code>.=</code> : append without space</li>
<li><code>=.</code> : prepend without space</li>
<li><code>?=</code> : assign if no other value was assigned</li>
<li><code>??=</code>: same as before with lower precedence (<code>?=</code> has higher precedence)</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org626dc95" class="outline-4">
<h4 id="org626dc95">Bitbake</h4>
<div class="outline-text-4" id="text-org626dc95">
<p>
The work is done in the <code>build/tmp/work</code> directory. 
There we have an 
</p>
<ul class="org-ul">
<li>architecture dependent folder (e.g. <code>cortexa7t2hf-neon-vfpv4-poky-linux-gnueabi</code>) and a</li>
<li>board specific folder (e.g. <code>stm32mp1-poky-linux-gnueabi</code>).</li>
</ul>

<p>
You'll find working directories for recipes in there. There are logfiles for tasks, e.g.
<code>dropbear/2019.78-r/temp/log.do_compile</code>. 
</p>

<p>
There is also a script to build e.g. dropbear: <code>dropbear/2019.78-r/temp/run.do_compile</code> to build applications individually. 
</p>
</div>

<div id="outline-container-orgcc0f888" class="outline-5">
<h5 id="orgcc0f888">BitBake tips</h5>
<div class="outline-text-5" id="text-orgcc0f888">
<ul class="org-ul">
<li>List all tasks for a recipe: <code>bitbake -c listtasks virtual/kernel</code></li>
<li>Call a specific task: <code>bitbake -c &lt;task&gt; virtual/kernel</code></li>
<li>Force rebuild of a package: <code>bitbake -f virtual/kernel</code></li>
<li>Download all packages: <code>bitbake --runall=fetch world</code></li>
<li>List locally available packages: <code>bitbake -s</code></li>
</ul>
</div>
</div>

<div id="outline-container-orgbb5e937" class="outline-5">
<h5 id="orgbb5e937">bitbake-layers</h5>
<div class="outline-text-5" id="text-orgbb5e937">
<ul class="org-ul">
<li><code>bitbake-layers show-layers</code></li>
<li><code>bitbake-layers show-recipes [RECIPE]</code> (e.g. <code>bitbake-layers show-recipes linux-yocto</code>)</li>
<li><code>bitbake-layers show-overlayed</code></li>
<li>Create a new empty layer: <code>bitbake-layers create-layer</code></li>
<li>Add a layer: <code>bitbake-layers add-layer ../meta-bootlinlabs</code></li>
<li>Show <code>bbappends</code> files: <code>bitbake-layers show-appends</code></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orge10d147" class="outline-4">
<h4 id="orge10d147">Writing Recipes</h4>
<div class="outline-text-4" id="text-orge10d147">
<p>
A recipe is a set of instructions to describe how to build a component
(retrieve, patch, compile, install) and generate binary packages for a given application.
</p>

<ul class="org-ul">
<li>Layers: <code>meta-X</code> - folders containing recipes folders</li>
<li>Recipes: <code>recipes-X</code> - folders containing folders containing recipes files</li>
<li><code>&lt;application-name&gt;_&lt;version&gt;.bb</code> - files</li>
</ul>

<p>
Notes:
</p>
<ul class="org-ul">
<li>"_" cannot be used inside &lt;application-name&gt;</li>
</ul>
</div>

<div id="outline-container-orgdb86b97" class="outline-5">
<h5 id="orgdb86b97">Recipe file content</h5>
<div class="outline-text-5" id="text-orgdb86b97">
<p>
Common variables
</p>
<ul class="org-ul">
<li>PN : package name, as in the name of the .bb file</li>
<li>PV : package version (the version number in the .bb file name)</li>
<li>PR : revision</li>
</ul>

<p>
include files: <code>.inc</code>, they should contain version agnostic metadata, the <code>.bb</code> file is version specific
</p>

<p>
3 main parts:
</p>
<ol class="org-ol">
<li>header - what, who</li>
<li>sources - where</li>
<li>tasks - how</li>
</ol>

<p>
They contain:
</p>
<ul class="org-ul">
<li>variables (name, license, dependencies, path to retrieve the source code&#x2026;)</li>
<li>tasks (functions, e.g. fetch, configure, compile, &#x2026;)
<ul class="org-ul">
<li><code>bitbake -c &lt;task&gt; &lt;target&gt;</code></li>
</ul></li>
</ul>
</div>

<div id="outline-container-org3d32370" class="outline-6">
<h6 id="org3d32370">Header</h6>
<div class="outline-text-6" id="text-org3d32370">
<ul class="org-ul">
<li><code>DESCRIPTION</code> : describes what the software is about</li>
<li><code>HOMEPAGE URL</code> : to the project’s homepage</li>
<li><code>PRIORITY</code> : defaults to optional</li>
<li><code>SECTION</code> : package category (e.g. console/utils)</li>
<li><code>LICENSE</code> : the application’s license (mandatory)</li>
</ul>
</div>
</div>
<div id="outline-container-orgc98296e" class="outline-6">
<h6 id="orgc98296e">Sources</h6>
<div class="outline-text-6" id="text-orgc98296e">
<p>
Variable <code>SRC_URI</code> tells where to find the source code. 
For <code>https, =http, =ftp</code> you have to specify checksums <code>SRC_URI[md5sum]</code> or <code>SRC_URI[sha256sum]</code>.
</p>

<ul class="org-ul">
<li>git</li>
<li>https, ftp</li>
</ul>

<p>
Local files (e.g. patches) located alongside (e.g. in a folder with the package name, e.g. dropbear)
<code>.bb</code> files. 
</p>
</div>
</div>

<div id="outline-container-org2a466af" class="outline-6">
<h6 id="org2a466af">Tasks</h6>
<div class="outline-text-6" id="text-org2a466af">
<p>
There are default implementations for default tasks like
</p>
<ul class="org-ul">
<li><code>do_fetch</code></li>
<li><code>do_unpack</code></li>
<li><code>do_patch</code></li>
<li><code>do_configure</code></li>
<li><code>do_compile</code></li>
<li><code>do_install</code></li>
<li><code>do_package</code></li>
<li><code>do_rootfs</code></li>
</ul>

<p>
These default tasks can be overridden in the <code>.bb</code> files. 
</p>
</div>

<ul class="org-ul">
<li><a id="org2d6e3af"></a>Writing tasks<br />
<div class="outline-text-7" id="text-org2d6e3af">
<p>
2 options:
</p>
<ul class="org-ul">
<li><code>sh</code> shell syntax is used (the usual way).</li>
<li>Can also be written in <i>Python</i>.</li>
</ul>

<p>
A task needs to start with <code>do_</code>. 
</p>
<div class="org-src-container">
<pre class="src src-bb">do_task()
{
	action0
	action1
}
</pre>
</div>
<p>
Important variables
</p>
<ul class="org-ul">
<li>D : destination directory, directory where the files are installed (in the root FS, e.g. <code>/usr/bin</code>)</li>
<li>bindir</li>
<li>WORKDIR</li>

<li>Tasks can be extended with <code>_prepend</code> and <code>_append</code>.</li>
<li>Tasks can be added with <code>addtask</code>.</li>
</ul>
<pre class="example">
addtask do_mytask after do_compile before do_install
</pre>
</div>
</li>
</ul>
</div>

<div id="outline-container-orgb191569" class="outline-6">
<h6 id="orgb191569">Applying patches</h6>
<div class="outline-text-6" id="text-orgb191569">
<p>
How to create a patch file with GIT. 
</p>

<ul class="org-ul">
<li>Edit a file (e.g. file.c).</li>
</ul>
<pre class="example">
git format-patch -1
</pre>


<p>
Will create a patch file <code>some-name.patch</code>.
</p>

<p>
Apply the patch file. 
</p>
<pre class="example">
git apply some-name.patch
</pre>


<p>
Where to use:
</p>
<ul class="org-ul">
<li>bug and security fixes</li>
<li>fixing cross-compiling issues</li>
</ul>

<p>
In the <code>do_patch</code> task <code>.patch</code> or <code>.diff</code> files will be applied. 
</p>
</div>
</div>
</div>

<div id="outline-container-orge6de90d" class="outline-5">
<h5 id="orge6de90d">Examples</h5>
<div class="outline-text-5" id="text-orge6de90d">
<div class="org-src-container">
<pre class="src src-bb">DESCRIPTION = "Hello world program"
HOMEPAGE = "http://example.net/hello/"
PRIORITY = "optional"
SECTION = "examples"
LICENSE = "GPLv2"
SRC_URI = "git://git.example.com/hello;protocol=https"
SRCREV = "2d47b4eb66e705458a17622c2e09367300a7b118"
S = "${WORKDIR}/git"                                          # this is important for git
LIC_FILES_CHKSUM = \
"file://hello.c;beginline=3;endline=21;md5=58e..."

do_compile() {
oe_runmake
}
do_install() {
install -d ${D}${bindir}                         
install -m 0755 hello ${D}${bindir}
}
</pre>
</div>

<p>
Version agnostic part
</p>

<p>
tar.inc
</p>
<div class="org-src-container">
<pre class="src src-bb">SUMMARY = "GNU file archiving program"
HOMEPAGE = "https://www.gnu.org/software/tar/"
SECTION = "base"
SRC_URI = "${GNU_MIRROR}/tar/tar-${PV}.tar.bz2"
do_configure() { ... }
do_compile() { ... }
do_install() { ... }
</pre>
</div>

<p>
tar_1.17.bb
</p>
<div class="org-src-container">
<pre class="src src-bb">require tar.inc
LICENSE = "GPLv2"                                      # put license in the version specific part
LIC_FILES_CHKSUM = \
"file://COPYING;md5=59530bdf33659b29e73d4adb9f9f6552"
SRC_URI += "file://avoid_heap_overflow.patch"
SRC_URI[md5sum] = "c6c4f1c075dbf0f75c29737faa58f290"
</pre>
</div>

<p>
tar_1.26.bb - License change
</p>
<div class="org-src-container">
<pre class="src src-bb">require tar.inc
LICENSE = "GPLv3"
LIC_FILES_CHKSUM = \
"file://COPYING;md5=d32239bcb673463ab874e80d47fae504"
SRC_URI[md5sum] = "2cee42a2ff4f1cd4f9298eeeb2264519"
</pre>
</div>
</div>
</div>

<div id="outline-container-org88c8f0d" class="outline-5">
<h5 id="org88c8f0d">Extending a recipe</h5>
<div class="outline-text-5" id="text-org88c8f0d">
<p>
Modify a recipe without changing the original. 
</p>

<p>
append, change
</p>

<p>
Append files:
</p>
<ul class="org-ul">
<li>Add <code>append</code> to the filename: <code>my_recipe.bb</code> <code>my_recipe.bbappend</code>.</li>
<li>Append files have to be updated when the recipe version changes.</li>
</ul>

<p>
Adding new files, override a file
</p>
<ul class="org-ul">
<li><code>FILESEXTRAPATHS</code></li>
</ul>

<div class="org-src-container">
<pre class="src src-bb">FILESEXTRAPATHS_prepend := "${THISDIR}/files:"      # very common in bbappend-files

SRC_URI += "file://custom-modification-0.patch \
				file://custom-modification-1.patch \
			  "
</pre>
</div>
</div>
</div>
<div id="outline-container-org9aa9405" class="outline-5">
<h5 id="org9aa9405">Advanced configurations</h5>
<div class="outline-text-5" id="text-org9aa9405">
<ul class="org-ul">
<li>provide virtual packages</li>
<li>use classes to reuse tasks</li>
</ul>

<pre class="example">
PROVIDES = "virtual/kernel"
</pre>
</div>
<div id="outline-container-orgec67984" class="outline-6">
<h6 id="orgec67984">Classes</h6>
<div class="outline-text-6" id="text-orgec67984">
<p>
Abstraction for common code to be re-used in recipes. 
Common classes can be found in <code>meta/classes/</code>.
</p>

<p>
Examples:
</p>
<ul class="org-ul">
<li><code>base.bbclass</code> : is automatically inherited by every recipe. Contains common tasks (<code>do_fetch</code> etc.).</li>
<li><code>kernel.bbclass</code> : tasks to configure, compile a kernel</li>
<li><code>autotools.bbclass</code> : <code>do_configure</code>, <code>do_compile</code>, <code>do_install</code></li>
</ul>

<p>
Use a class in your own recipe with e.g.:
</p>
<pre class="example">
inherit autotools
</pre>
</div>
</div>

<div id="outline-container-org29acf3e" class="outline-6">
<h6 id="org29acf3e">bitbake File inclusions</h6>
<div class="outline-text-6" id="text-org29acf3e">
<p>
Includable files are listed in <code>BBPATH</code>. Also the current directory is checked. 
</p>

<p>
Keywords:
</p>
<ul class="org-ul">
<li><code>inherit</code></li>
<li><code>include</code></li>
<li><code>require</code></li>
</ul>

<p>
Take care of layer priorities. You can check the priorities:
</p>
<pre class="example">
bitbake-layers show-layers
</pre>
</div>
</div>
</div>

<div id="outline-container-org65be22f" class="outline-5">
<h5 id="org65be22f">Debugging recipes</h5>
<div class="outline-text-5" id="text-org65be22f">
<ul class="org-ul">
<li>logs in <code>temp</code> directory</li>
<li><p>
development shell
</p>
<pre class="example">
bitbake -c devshell &lt;recipe&gt;
</pre></li>
</ul>
</div>
</div>
<div id="outline-container-org299e6ea" class="outline-5">
<h5 id="org299e6ea">Going further</h5>
<div class="outline-text-5" id="text-org299e6ea">
</div>
<div id="outline-container-orgf3ab67a" class="outline-6">
<h6 id="orgf3ab67a">Package features</h6>
<div class="outline-text-6" id="text-orgf3ab67a">
<p>
Handle features like bluetooth, wifi, openssl, etc. 
</p>

<p>
<code>PACKAGECONFIG</code> will list the features.
</p>

<p>
<code>PACKAGECONFIG[feature]</code>
Example:
</p>
<pre class="example">
=PACKAGECONFIG ??= "wifi openvpn"
PACKAGECONFIG[wifi] = "--enable-wifi"
</pre>


<p>
Conditionally enable features 
</p>
<div class="org-src-container">
<pre class="src src-bb">PACKAGECONFIG ??= "\
						 ${@bb.utils.contains('DISTRO_FEATURES', 'wifi','wifi', '', d)}             \
						 ${@bb.utils.contains('DISTRO_FEATURES', 'bluetooth','bluetooth', '', d)}   \
						 ${@bb.utils.contains('DISTRO_FEATURES', '3g','3g', '', d)}"
</pre>
</div>
<p>
Inline Python code checks the values of "DISTRO_FEATURES". 
</p>
</div>
</div>

<div id="outline-container-org415b233" class="outline-6">
<h6 id="org415b233">Tasks in Python</h6>
<div class="outline-text-6" id="text-org415b233">
<ul class="org-ul">
<li><code>python_function()</code> : prepend functions with <code>python</code>.</li>
<li><code>d</code> variable : BitBake datastore (the environment variables in the shell)
<ul class="org-ul">
<li><code>d.getVar("X", expand=False)</code> Returns the value of X.</li>
<li><code>d.setVar("X", "value")</code> Set X.</li>
<li><code>d.appendVar("X", "value")</code> Append value to X.</li>
<li><code>d.prependVar("X", "value")</code> Prepend value to X.</li>
<li><code>d.expand(expression)</code> Expend variables in expression.</li>
</ul></li>
</ul>

<p>
2 packages are imported automatically
</p>
<ul class="org-ul">
<li><code>bb</code> : to access BitBake’s internal functions.</li>
<li><code>os</code> : Python’s operating system interfaces.</li>
</ul>

<p>
You can also use anonymous functions
</p>
</div>
</div>

<div id="outline-container-org84010eb" class="outline-6">
<h6 id="org84010eb">Variable flags</h6>
<div class="outline-text-6" id="text-org84010eb">
<p>
Example: never execute task
</p>
<pre class="example">
do_compile[noexec] = "1"
</pre>


<ul class="org-ul">
<li><code>dirs</code></li>
<li><code>noexec</code></li>
<li><code>nostamp</code> : don't create stamp file, the task will always be executed</li>
<li><code>doc</code></li>
</ul>
</div>
</div>

<div id="outline-container-orga5c8307" class="outline-6">
<h6 id="orga5c8307">rootfs creation</h6>
<div class="outline-text-6" id="text-orga5c8307">
<p>
<code>do_install</code> task
</p>

<p>
<code>FILES</code> - variable
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org89f4449" class="outline-4">
<h4 id="org89f4449">Layers</h4>
<div class="outline-text-4" id="text-org89f4449">
<p>
A layer is a collection of recipes. 
Naming convention for folders: <code>meta-X</code>.
</p>

<p>
A layer is a set of files and directories. 
</p>

<p>
The list of layers BitBake uses is defined in <code>build/conf/bblayers.conf</code>.
</p>

<p>
<code>bitbake-layers</code> - tool. 
</p>
<ul class="org-ul">
<li><code>bitbake-layers show-layers</code></li>
<li><code>bitbake-layers remove-layer meta-st-stm32mp</code></li>
<li><code>bitbake-layers add-layer meta-st-stm32mp</code></li>
</ul>

<p>
Notes:
</p>
<ul class="org-ul">
<li>layers can be saved everywhere (<code>bblayers.conf</code> will list them)</li>
</ul>

<p>
Interesting layers
</p>
<ul class="org-ul">
<li><code>meta-qt5</code></li>
<li><code>meta-java</code></li>
</ul>
</div>

<div id="outline-container-org8782584" class="outline-5">
<h5 id="org8782584">Poky</h5>
<div class="outline-text-5" id="text-org8782584">
<p>
Poky is a set of commonly used layers to be extended or modified. 
Poky itself should not be modified, instead custom layers are added. 
</p>

<p>
Existing Layers:
<a href="https://layers.openembedded.org/layerindex/branch/master/layers/">https://layers.openembedded.org/layerindex/branch/master/layers/</a>
</p>
</div>
</div>


<div id="outline-container-orgbe7b67e" class="outline-5">
<h5 id="orgbe7b67e">Create a layer</h5>
<div class="outline-text-5" id="text-orgbe7b67e">
<pre class="example">
bitbake-layers create-layer -p &lt;PRIORITY&gt; &lt;layer&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc091b88" class="outline-4">
<h4 id="orgc091b88">BSP Layers</h4>
<div class="outline-text-4" id="text-orgc091b88">
<p>
BSP Layers are device specific layers, i.e. hardware dependent. 
</p>
</div>
<div id="outline-container-org2299642" class="outline-5">
<h5 id="org2299642">Hardware configuration files</h5>
<div class="outline-text-5" id="text-org2299642">
<pre class="example">
meta-&lt;bsp_name&gt;/conf/machine/*.conf
</pre>


<p>
Typical variables
</p>
<ul class="org-ul">
<li><code>TARGET_ARCH</code> : Target architecture.</li>
<li><code>PREFERRED_PROVIDER_virtual/kernel</code> : The default kernel.</li>
<li><code>MACHINE_FEATURES</code> : high level descriptions (wifi, screen, usbhost, etc.)</li>
<li><code>SERIAL_CONSOLES</code> : 115200;ttyS0</li>
<li><code>KERNEL_IMAGETYPE</code> : e.g. zImage</li>
</ul>

<p>
good practice: use <code>?=</code> so the value can be overridden. 
</p>
</div>
</div>

<div id="outline-container-org178a6dc" class="outline-5">
<h5 id="org178a6dc">Bootloader</h5>
<div class="outline-text-5" id="text-org178a6dc">
<p>
Create a custom recipe for <code>U-Boot</code>.
</p>

<p>
<code>kernel.bbclass</code> does not exist for U-Boot
<code>meta/recipes-bsp/u-boot/u-boot.inc</code> file
</p>

<p>
Create a <code>.bb</code> file and include <code>u-boot.inc</code>. 
</p>

<p>
See the <code>u-boot-stm32mp.inc</code> file in <code>meta-st-stm32mp/recipes-bsp/u-boot/u-boot-stm32mp</code>.
</p>
</div>
</div>

<div id="outline-container-org46740ef" class="outline-5">
<h5 id="org46740ef">Kernel</h5>
<div class="outline-text-5" id="text-org46740ef">
<p>
2 ways of compiling the kernel:
</p>
<ul class="org-ul">
<li><code>linux-yocto</code> packages : difficult to use</li>
<li>use custom kernel recipe</li>
</ul>

<pre class="example">
PREFERRED_PROVIDER_virtual/kernel = "linux-yocto"
</pre>


<p>
Kernel Configuration Fragments
</p>
</div>
</div>
</div>

<div id="outline-container-org31da325" class="outline-4">
<h4 id="org31da325">Distro Layers</h4>
<div class="outline-text-4" id="text-org31da325">
<p>
Configuration file for the distro layer is <code>conf/distro/&lt;distro&gt;.conf</code>.
</p>

<p>
<code>DISTRO</code> variable
</p>
</div>
<div id="outline-container-org56073ab" class="outline-5">
<h5 id="org56073ab">Toolchain selection</h5>
<div class="outline-text-5" id="text-org56073ab">
</div>
<div id="outline-container-org94b42cc" class="outline-6">
<h6 id="org94b42cc">Toolchain creation</h6>
<div class="outline-text-6" id="text-org94b42cc">
<ul class="org-ul">
<li>toolchain creation on machine A</li>
<li>build on machine B</li>
<li>target is machine C</li>
</ul>

<p>
Normal: A = B = C - native compiling
A = B != C - cross compiling
A != B = C - cross native compiling
A != B != C - canadian cross compiling
</p>
</div>
</div>
</div>

<div id="outline-container-org6435d29" class="outline-5">
<h5 id="org6435d29">Sample Files</h5>
<div class="outline-text-5" id="text-org6435d29">
<p>
Give you samples for <code>bblayers.conf</code> and <code>local.conf</code>.
</p>

<p>
see: <code>poky/meta-poky/conf</code>
</p>

<p>
<code>TEMPLATETEMPLATECONF</code> controls where to find sample files.
see <code>${OEROOT}/.templateconf</code>
</p>
</div>
</div>

<div id="outline-container-orgd1d8bf5" class="outline-5">
<h5 id="orgd1d8bf5">Release management</h5>
<div class="outline-text-5" id="text-orgd1d8bf5">
<p>
<code>.templateconf</code> with Google's <code>repo</code>, it's a tool to handle multiple GIT
repositories simultaneously.
</p>

<p>
The configuration is stored in a manifest file.
Example:
</p>
<div class="org-src-container">
<pre class="src src-xml"><span class="org-string"><span class="org-nxml-processing-instruction-delimiter">&lt;?</span></span><span class="org-string"><span class="org-nxml-processing-instruction-target">xml</span></span><span class="org-string"> </span><span class="org-string"><span class="org-nxml-processing-instruction-content">version="1.0" encoding="UTF-8"</span></span><span class="org-string"><span class="org-nxml-processing-instruction-delimiter">?&gt;</span></span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">manifest</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">remote</span> <span class="org-nxml-attribute-local-name">name</span>=<span class="org-string">"yocto-project"</span> <span class="org-nxml-attribute-local-name">fetch</span>=<span class="org-string">"git.yoctoproject.org"</span> <span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">remote</span> <span class="org-nxml-attribute-local-name">name</span>=<span class="org-string">"private"</span> <span class="org-nxml-attribute-local-name">fetch</span>=<span class="org-string">"git.example.net"</span> <span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">default</span> <span class="org-nxml-attribute-local-name">revision</span>=<span class="org-string">"dunfell"</span> <span class="org-nxml-attribute-local-name">remote</span>=<span class="org-string">"private"</span> <span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">project</span> <span class="org-nxml-attribute-local-name">name</span>=<span class="org-string">"poky"</span> <span class="org-nxml-attribute-local-name">remote</span>=<span class="org-string">"yocto-project"</span> <span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">project</span> <span class="org-nxml-attribute-local-name">name</span>=<span class="org-string">"meta-ti"</span> <span class="org-nxml-attribute-local-name">remote</span>=<span class="org-string">"yocto-project"</span> <span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">project</span> <span class="org-nxml-attribute-local-name">name</span>=<span class="org-string">"meta-custom"</span> <span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">project</span> <span class="org-nxml-attribute-local-name">name</span>=<span class="org-string">"meta-custom-bsp"</span> <span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">project</span> <span class="org-nxml-attribute-local-name">path</span>=<span class="org-string">"meta-custom-distro"</span> <span class="org-nxml-attribute-local-name">name</span>=<span class="org-string">"distro"</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">copyfile</span> <span class="org-nxml-attribute-local-name">src</span>=<span class="org-string">"templateconf"</span> <span class="org-nxml-attribute-local-name">dest</span>=<span class="org-string">"poky/.templateconf"</span> <span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">project</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">manifest</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org986927d" class="outline-4">
<h4 id="org986927d">Images</h4>
<div class="outline-text-4" id="text-org986927d">
</div>
<div id="outline-container-org6bc9ddb" class="outline-5">
<h5 id="org6bc9ddb">Introduction</h5>
<div class="outline-text-5" id="text-org6bc9ddb">
<p>
An <code>image</code> is the top level recipe. It's architecture agnostic and defines how the
rootfs is built with what packages.
</p>

<p>
The <code>machine</code> describes the hardware.
</p>

<p>
See <code>poky/meta/recipes-core/images</code>.
</p>

<p>
It inherits <code>core-image</code> class.
</p>

<p>
Organization of the image recipe:
</p>
<ul class="org-ul">
<li><code>IMAGE_BASENAME</code> : The name of the output image files. Defaults to ${PN}.</li>
<li><code>IMAGE_INSTALL</code> : List of packages and package groups to install in the generated image.</li>
<li><code>IMAGE_ROOTFS_SIZE</code> : The final root filesystem size.</li>
<li><code>IMAGE_FEATURES</code> : List of features to enable in the image.</li>
<li><code>IMAGE_FSTYPES</code> : List of formats the OpenEmbedded build system will use to create images.</li>
<li><code>IMAGE_LINGUAS</code> : List of the locales to be supported in the image.</li>
<li><code>IMAGE_PKGTYPE</code> : Package type used by the build system. One of deb, rpm, ipk and tar.</li>
<li><code>IMAGE_POSTPROCESS_COMMAND</code> : Shell commands to run at post process.</li>
</ul>
</div>
</div>

<div id="outline-container-org4778bdc" class="outline-5">
<h5 id="org4778bdc">FS types</h5>
<div class="outline-text-5" id="text-org4778bdc">
<p>
Configure the rootfs format, e.g. ext2, ext3, ext4, squashfs, initramfs, etc.
</p>

<p>
<code>initramfs</code> rootfs inside the kernel image, read only, loaded into ram at boot.
</p>

<p>
File system overlays can be used to have a read only rootfs but store log files
etc. on another partition.
</p>

<p>
You can either create your own image or use the <code>wic</code>-tool.
</p>
</div>

<div id="outline-container-org063e7ee" class="outline-6">
<h6 id="org063e7ee"><code>wic</code> tool</h6>
<div class="outline-text-6" id="text-org063e7ee">
<ul class="org-ul">
<li>can create a flashable image</li>
</ul>

<p>
See <code>meta-st-stm32mp/wic</code>
</p>
<div class="org-src-container">
<pre class="src src-wic"># short-description: Create SD card image with a boot partition (1GB)
# long-description: Creates a partitioned SD card image (1GB)
#
#  - ----- --------- -------------- ---------------------------------
# | | TFA | u-boot  |     bootfs   |    vendorfs | rootfs  | userfs |
#  - ----- --------- -------------- ---------------------------------
# ^ ^     ^         ^              ^             ^         ^        ^
# | |     |         |              |             |         |        |
# 0 17kB 529kB     4MB           66.5MB        82.5MB   850.5Mb  1024MB
#
# Warning: the first stage of boot (here fsbl1, fsbl2, ssbl) MUST be on GPT partition to be detected.
#

part fsbl1 --source gptcopy --sourceparams="file=tf-a-stm32mp157c-dk2-trusted.stm32" --ondisk mmcblk --label fsbl1 --part-type 0x8301 --fixed-size 256K --align 17
part fsbl2 --source gptcopy --sourceparams="file=tf-a-stm32mp157c-dk2-trusted.stm32" --ondisk mmcblk --label fsbl2 --part-type 0x8301 --fixed-size 256K
part ssbl  --source gptcopy --sourceparams="file=u-boot-stm32mp157c-dk2-trusted.stm32" --ondisk mmcblk --label ssbl --part-type 0x8301 --fixed-size 2048K

part bootfs --source rawcopy --sourceparams="file=st-image-bootfs-${DISTRO}-${MACHINE}.ext4" --ondisk mmcblk --fstype=ext4 --label bootfs --active --fixed-size 64M
part / --source rootfs --ondisk mmcblk --fstype=ext4 --label rootfs --fixed-size 768M
part usrfs --source rawcopy --sourceparams="file=st-image-userfs-${DISTRO}-${MACHINE}.ext4" --ondisk mmcblk --fstype=ext4 --label userfs --active --fixed-size 173M

bootloader --ptable gpt
</pre>
</div>

<p>
Final result is a <code>.wks</code>-file.
</p>
</div>
</div>

<div id="outline-container-orgd6a8dab" class="outline-6">
<h6 id="orgd6a8dab">Package groups</h6>
<div class="outline-text-6" id="text-orgd6a8dab">
<p>
See <code>poky/meta/recipes-core/packagegroups</code>. 
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org1de1959" class="outline-4">
<h4 id="org1de1959">Application Development (Yocto Project SDK)</h4>
<div class="outline-text-4" id="text-org1de1959">
<p>
How do we use Yocto as a team, etc?
</p>

<p>
You might wanna do different things:
</p>
<ul class="org-ul">
<li>low level (bootloader, kernel) -&gt; <code>gneric SDK</code></li>
<li>application -&gt; <code>SDK</code></li>
<li>debugging, bugfixes -&gt; <code>quilt</code></li>
</ul>

<p>
<code>devtools</code>
</p>
</div>

<div id="outline-container-org56c5d58" class="outline-5">
<h5 id="org56c5d58">Yokto SDK</h5>
<div class="outline-text-5" id="text-org56c5d58">
<p>
You can create a stand alone SDK. 
</p>

<ul class="org-ul">
<li>toolchain with cross compiler</li>
<li>libraries, headers</li>
<li>debugger</li>
</ul>

<p>
The SDK is self-contained and can be used on any computer. No need for poky. 
</p>

<ul class="org-ul">
<li>generic SDK : toolchain, tools, libraries
<ul class="org-ul">
<li>The recipe <code>meta-toolchain</code> (its a recipe, not a layer!) generates the SDK.</li>
</ul></li>
<li>image based SDK : generic SDK + sysroot
<ul class="org-ul">
<li>this is one big shell script</li>
<li><code>populate_sdk</code> : one task (e.g. <code>bitbake -c populate_sdk core-image-minimal</code>)</li>
</ul></li>
</ul>

<p>
Extensible SDK contains <code>devtool</code>. 
</p>
</div>

<div id="outline-container-org4ff8b14" class="outline-6">
<h6 id="org4ff8b14">Use SDK</h6>
<div class="outline-text-6" id="text-org4ff8b14">
<p>
Source a shell script:
</p>
<pre class="example">
cd /opt/poky/2.5
source ./environment-setup-cortexa8hf-neon-poky-linux-gnueabi
</pre>


<p>
Then you can just compile your application: <code>make</code>.
</p>
</div>
</div>

<div id="outline-container-orgd62764c" class="outline-6">
<h6 id="orgd62764c">Devtool</h6>
<div class="outline-text-6" id="text-orgd62764c">
<p>
Manage recipes by automating manual tasks. 
</p>

<ul class="org-ul">
<li>Generate a recipe</li>
<li>Modify a recipe</li>
<li>Update an existing recipe</li>
</ul>

<p>
Adds a workspace layer. 
Create a new recipe
</p>
<pre class="example">
devtool add &lt;recipe&gt; &lt;fetchuri&gt;
</pre>


<p>
Other things:
</p>
<pre class="example">
devtool build &lt;recipe&gt;
devtool deploy-target &lt;recipe&gt; &lt;target&gt;
</pre>
</div>
</div>

<div id="outline-container-orgdb9cc4f" class="outline-6">
<h6 id="orgdb9cc4f">Quilt</h6>
<div class="outline-text-6" id="text-orgdb9cc4f">
<p>
Manage patches in a dirty source tree.
</p>

<p>
Create patches for recipes. 
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orgb531310" class="outline-4">
<h4 id="orgb531310">Runtime Package Management</h4>
<div class="outline-text-4" id="text-orgb531310">
<p>
BitBake builds the packages according to <code>IMAGE_INSTALL</code>. 
These packages are used to generate the rootfs.
</p>

<p>
Internally <code>.deb</code> or <code>.rpm</code> (poky) files are created.
</p>

<p>
If you only want to update one package using Runtime Package Management. 
</p>
</div>

<div id="outline-container-org8a8fccb" class="outline-5">
<h5 id="org8a8fccb">IPK packages</h5>
<div class="outline-text-5" id="text-org8a8fccb">
<p>
You need a package server serving packages with <code>https</code> or <code>http</code>.
</p>

<p>
Tools on the target: <code>opkg</code>.
</p>

<p>
<code>PACKAGE_CLASSES</code>
</p>

<pre class="example">
bitbake package-index
</pre>


<p>
Operations:
</p>
<ul class="org-ul">
<li><code>opkg list</code></li>
<li><code>opkg upgrade</code></li>
<li><code>opkg upgrad &lt;package&gt;</code></li>
<li><code>opkg install &lt;package&gt;</code></li>
</ul>
</div>

<div id="outline-container-orgf129bb0" class="outline-6">
<h6 id="orgf129bb0">Apache2 Configuration</h6>
<div class="outline-text-6" id="text-orgf129bb0">
<div class="org-src-container">
<pre class="src src-conf">&lt;VirtualHost *:80&gt;
   ServerName packages.example.net
   DocumentRoot /path/to/build/tmp/deploy/ipk
   &lt;Directory /path/to/build/tmp/deploy/ipk&gt;
      Options +Indexes
      Options Indexes FollowSymLinks
      Order allow,deny
      allow from all
      AllowOverride None
      Require all granted
   &lt;/Directory&gt;
&lt;/VirtualHost&gt;
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-org025128c" class="outline-4">
<h4 id="org025128c">Labs</h4>
<div class="outline-text-4" id="text-org025128c">
<p>
Install build tools (Note: not copied from script - didn't work). 
</p>
<pre class="example">
sudo apt install gawk wget gitdiffstat unzip texinfo gcc-multilib build-essential chrpath socat libsdl1.2-dev xterm bc cpio python gdisk
</pre>


<p>
Serial Interface via (micro USB, supply via USB-C next to Ethernet connector)
</p>
<pre class="example">
sudo picocom -b 115200 /dev/ttyACM0
</pre>

<p>
Login: root
</p>

<p>
Download bootlin lab material
</p>
<pre class="example">
wget https://bootlin.com/doc/training/yocto-stm32/yocto-stm32-labs.tar.xz
tar xvf yocto-stm32-labs.tar.xz
</pre>


<p>
Now we have a folder <code>yocto-stm32-labs</code>.
</p>
</div>

<div id="outline-container-orgb63c6b7" class="outline-5">
<h5 id="orgb63c6b7">Lab 1 - First Yocto Project Build</h5>
<div class="outline-text-5" id="text-orgb63c6b7">
<p>
Go to your root folder:
</p>
<pre class="example">
~/yocto-stm32-labs
</pre>
</div>

<div id="outline-container-org304e6e0" class="outline-6">
<h6 id="org304e6e0">Download layers</h6>
<div class="outline-text-6" id="text-org304e6e0">
<p>
Clone <code>zeus</code> version of <b>Poky</b>.
</p>
<pre class="example">
git clone git://git.yoctoproject.org/poky.git
cd ~/yocto-stm32-labs/poky
</pre>

<p>
Switch to new branch. 
</p>
<pre class="example">
git checkout -b zeus-22.0.3 zeus-22.0.3
</pre>


<p>
Download the Open Embedded- and STM32MP-layers in the root folder.
</p>
<pre class="example">
cd ~/yocto-stm32-labs
git clone -b zeus git://git.openembedded.org/meta-openembedded
git clone -b zeus https://github.com/STMicroelectronics/meta-st-stm32mp.git
</pre>


<p>
Note: <code>meta-st-stm32mp</code> depends on <code>meta-openembedded</code>.
</p>
</div>
</div>
<div id="outline-container-org3496032" class="outline-6">
<h6 id="org3496032">Create the <code>build</code> folder</h6>
<div class="outline-text-6" id="text-org3496032">
<p>
Source the <code>oe-init-build-env</code> script that sets up the build directory
</p>
<pre class="example">
source ~/yocto-stm32-labs/poky/oe-init-build-env
</pre>

<p>
in the folder <code>~/yocto-stm32-labs</code>.
</p>

<p>
You can also do <code>source ./oe-init-build-env [builddir]</code> with explicit parameter. 
This creates the folder <code>build</code>. This will create different variables. 
</p>

<p>
Inside the <code>build</code> directory we go to <code>conf/</code>.
Change <code>MACHINE</code> in <code>local.conf</code> to <code>stm32mp1</code>.
</p>

<p>
Note: <code>??</code> is used to make default value. 
</p>

<p>
Add layers to <code>bblayers.conf</code> (so you have 6 layers in the end):
</p>
<pre class="example">
/home/jh/yocto-stm32-labs/meta-openembedded/meta-oe
/home/jh/yocto-stm32-labs/meta-openembedded/meta-python
/home/jh/yocto-stm32-labs/meta-st-stm32mp
</pre>
</div>
</div>
<div id="outline-container-org7f343ae" class="outline-6">
<h6 id="org7f343ae">Create the SD-Card image</h6>
<div class="outline-text-6" id="text-org7f343ae">
<p>
Build the image (we are now in the <code>~/yocto-stm32-labs/build</code> folder)
</p>
<pre class="example">
bitbake core-image-minimal
</pre>


<p>
You'll get a list of parallel running tasks now (<code>do_fetch</code>, <code>do_configure</code>, <code>do_install</code>, etc. )
</p>

<p>
Now in <code>$BUILDDIR/tmp/deploy/images/stm32mp1/scripts</code> execute the script
</p>
<pre class="example">
sudo ./create_sdcard_from_flashlayout.sh ../flashlayout_core-image-minimal/FlashLayout_sdcard_stm32mp157a-dk1-basic.tsv
</pre>

<p>
to create the final image. Note: this is specific to the STM32MP1 setup. 
</p>

<p>
Now write the image to the SD-Card and reboot.
</p>
<pre class="example">
umount /dev/sdb*
sudo dd if=../flashlayout_core-image-minimal_FlashLayout_sdcard_stm32mp157a-dk1-basic.raw of=/dev/sdb bs=8M conv=fdatasync status=progress
</pre>


<p>
Note: the script creates the .raw file with "_" instead of "/". It's not a typo!
</p>
</div>
</div>
</div>

<div id="outline-container-org6f1a2da" class="outline-5">
<h5 id="org6f1a2da">Lab 2 - Advanced Yocto Configuration</h5>
<div class="outline-text-5" id="text-org6f1a2da">
</div>
<div id="outline-container-orgc183b8d" class="outline-6">
<h6 id="orgc183b8d">Set up Ethernet and NFS</h6>
<div class="outline-text-6" id="text-orgc183b8d">
</div>
<ul class="org-ul">
<li><a id="org79ecdde"></a>Set up NFS-server on host<br />
<div class="outline-text-7" id="text-org79ecdde">
<p>
Set IP-Address of Host PC (or use the address it has):
</p>
<pre class="example">
nmcli con add type ethernet ifname en... ip4 192.168.0.1/24
</pre>


<p>
Install NFS-server on the Host PC:
</p>
<pre class="example">
sudo apt install nfs-kernel-server
sudo mkdir -m 777 /nfs
</pre>


<p>
Unzip the rootfs into the nfs-folder:
</p>
<pre class="example">
sudo tar xpf /home/jh/yocto-stm32-labs/build/tmp/deploy/images/stm32mp1/core-image-minimal-stm32mp1.tar.xz -C /nfs
</pre>


<p>
Add the folder to <code>/etc/exports</code>
</p>
<pre class="example">
/nfs *(rw,sync,no_root_squash,subtree_check)
</pre>

<p>
Restart NFS server:
</p>
<pre class="example">
sudo service nfs-kernel-server restart
</pre>
</div>
</li>
<li><a id="org94ee5fd"></a>Set up target - change kernel boot arguments<br />
<div class="outline-text-7" id="text-org94ee5fd">
<p>
In the <code>bootfs</code> partition of the SD-Card in the file
</p>
<pre class="example">
sudo vim mmc0_stm32mp157a-dk1_extlinux/extlinux.conf
</pre>

<p>
change the <code>APPEND</code> line to
</p>
<pre class="example">
APPEND root=/dev/nfs rw console=ttyACM0,115200 nfsroot=192.168.0.1:/nfs,vers=3,tcp ip=192.168.10.211:::::eth0
</pre>


<p>
Boot the development board and check with <code>mount</code>. 
</p>

<p>
Notes:
</p>
<ul class="org-ul">
<li><code>ip</code> configures the board ip address</li>
<li><code>nfsroot</code> is the <code>/nfs</code> folder on the host</li>
</ul>

<p>
Note: using folder <code>/nfs</code> didn't work on my laptop, so i used the folder <code>/home/joe/bootlin/yocto/yocto-stm32-labs/nfs</code>.
Troubleshooting:
Manually mounting nfs-folder:
</p>
<pre class="example">
mount -o port=2049,nolock,proto=tcp -t nfs 192.168.1.4:/home/joe/bootlin/yocto/yocto-stm32-labs/nfs /nfs
</pre>
</div>
</li>
</ul>
</div>

<div id="outline-container-orgc78e09f" class="outline-6">
<h6 id="orgc78e09f">Add a package (dropbear ssh server)</h6>
<div class="outline-text-6" id="text-orgc78e09f">
<p>
In <code>build/local.conf</code> the variable <code>IMAGE_INSTALL</code> controls packages included in the final image. 
Add this in <code>local.conf</code>.
</p>
<pre class="example">
IMAGE_INSTALL_append = " dropbear"
</pre>


<p>
Create the image again (only adding dropbear, the rest is already there)
</p>
<pre class="example">
bitbake core-image-minimal
</pre>


<p>
Extract the rootfs again into the nfs-folder:
</p>
<pre class="example">
sudo tar xpf /home/jh/yocto-stm32-labs/build/tmp/deploy/images/stm32mp1/core-image-minimal-stm32mp1.tar.xz -C /nfs
</pre>
</div>
</div>

<div id="outline-container-org7f7346f" class="outline-6">
<h6 id="org7f7346f">Choose a package variant</h6>
<div class="outline-text-6" id="text-org7f7346f">
<p>
Do a BitBake dry-run (<code>-n</code>), <code>-v</code> - verbose
</p>
<pre class="example">
bitbake -vn virtual/kernel
</pre>


<p>
We can see that <code>linux-stm32mp</code> provides the <code>virtual/kernel</code>
</p>
<pre class="example">
NOTE: selecting linux-stm32mp to satisfy virtual/kernel due to PREFERRED_PROVIDERS
</pre>


<p>
Now we force BitBake to use another kernel in our local configuration. We'll switch
from <code>linux-stm32mp</code> to <code>linux-dummy</code>. 
</p>

<p>
Change <code>local.conf</code> 
</p>
<pre class="example">
PREFERRED_PROVIDER_virtual/kernel_stm32mp1 = "linux-dummy"
</pre>

<p>
Appending <code>_stm32mp1</code> in <code>local.conf</code> overrides the configuration in the st-layer. 
</p>

<p>
Check again with
</p>
<pre class="example">
bitbake -vn virtual/kernel|grep virtual/kernel
</pre>
</div>
</div>
</div>

<div id="outline-container-org0ae0ff0" class="outline-5">
<h5 id="org0ae0ff0">Lab 3 - Add a custom application</h5>
<div class="outline-text-5" id="text-org0ae0ff0">
<p>
add nInvaders - Space Invaders with ncurses
</p>
</div>

<div id="outline-container-org3d2a768" class="outline-6">
<h6 id="org3d2a768">Download and compile manually</h6>
<div class="outline-text-6" id="text-org3d2a768">
<p>
Download from Sourcforge: <a href="https://sourceforge.net/projects/ninvaders/">https://sourceforge.net/projects/ninvaders/</a>
</p>

<p>
Install ncurses
</p>
<pre class="example">
sudo apt get install libncurses5-dev 
</pre>


<p>
Now we can compile the application.
</p>
<pre class="example">
make
</pre>
</div>
</div>

<div id="outline-container-org3c401eb" class="outline-6">
<h6 id="org3c401eb">Create recipe</h6>
<div class="outline-text-6" id="text-org3c401eb">
<p>
Create <code>ninvader.bb</code> file
</p>
<div class="org-src-container">
<pre class="src src-bb">require ninvaders.inc

LICENSE = "GPLv2"
LIC_FILES_CHKSUM = "file://gpl.txt;md5=393a5ca445f6965873eca0259a17f833"
</pre>
</div>

<p>
Create <code>ninvader.inc</code> file
</p>
<div class="org-src-container">
<pre class="src src-bb">DESCRIPTION = "ncurses space invaders"
HOMEPAGE = "https://sourceforge.net/"

SRC_URI = "${SOURCEFORGE_MIRROR}/ninvaders/files/${PN}-${PV}.tar.gz"
SRC_URI[md5sum] = "97b2c3fb082241ab5c56ab728522622b"

DEPENDS = "ncurses"

EXTRA_OEMAKE = "-e"

do_compile(){
		  oe_runmake
}

do_install(){
		  install -d ${D}${bindir}  # create destination folder /usr/bin
		  install -m 0755 nInvaders ${D}${bindir}
}
</pre>
</div>

<pre class="example">
bitbake core-image-minimal
</pre>


<p>
Extract the rootfs again into the nfs-folder:
</p>
<pre class="example">
sudo tar xpf /home/jh/yocto-stm32-labs/build/tmp/deploy/images/stm32mp1/core-image-minimal-stm32mp1.tar.xz -C /nfs
</pre>


<p>
The application ends up in <code>/usr/bin</code>. 
</p>
</div>
</div>
</div>

<div id="outline-container-orgf3d4227" class="outline-5">
<h5 id="orgf3d4227">Lab 4 - Create a Yocto Layer</h5>
<div class="outline-text-5" id="text-orgf3d4227">
<p>
Let's list the currently used layers:
</p>
<pre class="example">
bitbake-layers show-layers
</pre>
</div>

<div id="outline-container-org452b2c1" class="outline-6">
<h6 id="org452b2c1">Create a new layer</h6>
<div class="outline-text-6" id="text-org452b2c1">
<p>
Create a new empty layer named <code>meta-bootlinlabs</code> with priority 7 (high):
</p>
<pre class="example">
bitbake-layers create-layer -p 7 meta-bootlinlabs
</pre>


<p>
In <code>build/</code>
</p>
<pre class="example">
bitbake-layers add-layer ../meta-bootlinlabs
</pre>


<p>
Of course we can also add the layer to the <code>build/conf/bblayers.conf</code> file.
</p>

<p>
Check with <code>bitbake-layers show-layers</code>
</p>
</div>
</div>

<div id="outline-container-orgd0f5cc0" class="outline-6">
<h6 id="orgd0f5cc0">Add ninvaders to our layer</h6>
<div class="outline-text-6" id="text-orgd0f5cc0">
<pre class="example">
bitbake-layers show-recipes ninvaders
</pre>


<p>
<code>ninvaders</code> is inside <code>poky/meta/recipes-extended</code> right now.
We want to have it in our own layer. 
</p>

<pre class="example">
mkdir meta-bootlinlabs/recipes-extended
mv poky/meta/recipes-extended/ninvaders/ meta-bootlinlabs/recipes-extended/
</pre>
</div>
</div>
</div>

<div id="outline-container-org220cf12" class="outline-5">
<h5 id="org220cf12">Lab 5 - Extend a recipe</h5>
<div class="outline-text-5" id="text-org220cf12">
<p>
In Lab 4 we created our own layer including nInvaders. We want to extend
the <code>linux-stm32mp</code> kernel to support the Nintendo Wii Nunchuk controller.
In order to do that we will apply the patches:
</p>
<ul class="org-ul">
<li><code>0001-Add-nunchuk-driver.patch</code></li>
<li><code>0002-ARM-dts-stm32mp157a-dk1-add-nunchuk.patch</code> - Device Tree</li>
</ul>
<p>
and change the configuration
</p>
<ul class="org-ul">
<li><code>defconfig</code></li>
</ul>
</div>

<div id="outline-container-org2dde51c" class="outline-6">
<h6 id="org2dde51c">Add Nunchuk (Nintendo wii controller) support</h6>
<div class="outline-text-6" id="text-org2dde51c">
<p>
Create a <code>bbappend</code> file to append the original <code>recipes-kernel</code> that is found in
<code>meta-st-stm32mp/recipes-kernel/linux</code>.
</p>

<p>
Create the <code>bbappend</code> file in the new layer.
</p>
<pre class="example">
mkdir meta-bootlinlabs/recipes-kernel/linux
&gt; linux-stm32mp_4.19.bbappend
</pre>


<p>
Note that patches will be automatically applied when listed in the <code>.bb</code> file.
</p>

<p>
<code>linux-stm32mp_4.19.bbappend</code>
</p>
<div class="org-src-container">
<pre class="src src-bb">FILESEXTRAPATHS_prepend := "${THISDIR}/linux-stm32mp:"

SRC_URI += "file://defconfig \
				file://0001-Add-nunchuk-driver.patch \
				file://0002-ARM-dts-stm32mp157a-dk1-add-nunchuk.patch"

# we need to clear this variable in order to use our own
KERNEL_DEFCONFIG = ""                            
KERNEL_EXTERNAL_DEFCONFIG = "defconfig"
</pre>
</div>

<p>
Check if it will be found: 
</p>
<pre class="example">
bitbake-layers show-appends
</pre>


<p>
Copy the patches into <code>linux-stm32mp</code>.
</p>
<pre class="example">
mkdir linux-stm32mp
cp ~/yocto-stm32-labs/bootlin-lab-data/nunchuk/linux/* linux-stm32mp
</pre>


<p>
Recompile the kernel
</p>
<pre class="example">
bitbake virtual/kernel
</pre>
</div>
</div>

<div id="outline-container-org8d76af4" class="outline-6">
<h6 id="org8d76af4">Patch nInvaders</h6>
<div class="outline-text-6" id="text-org8d76af4">
<p>
Create directory for the patch
</p>
<pre class="example">
mkdir meta-bootlinlabs/recipes-extended/ninvaders/files
</pre>


<p>
Copy the patch <code>joystick-support.patch</code>
</p>
<pre class="example">
cp ~/yocto-stm32-labs/bootlin-lab-data/nunchuk/ninvaders/* files/
</pre>


<p>
Add <code>joystick-support.patch</code> to the <code>SRC_URI</code> variable in the <code>ninvaders.inc</code> file.
</p>

<p>
Build full image and update the NFS root directory.
</p>
<pre class="example">
bitbake core-image-minimal
</pre>
</div>
</div>
</div>


<div id="outline-container-org242b6cc" class="outline-5">
<h5 id="org242b6cc"><span class="todo TODO">TODO</span> Lab 6 - Create a custom machine</h5>
<div class="outline-text-5" id="text-org242b6cc">
<p>
Create a new machine <code>bootlinlabs</code> based on tune <code>cortexa7thf-neon-vfpv4</code> of the <code>stm32mp</code> SoC family.
</p>

<p>
In <code>build/conf/local.conf</code> we will change <code>MACHINE</code> from <code>stm32mp</code> to <code>bootlinlabs</code>.
</p>

<pre class="example">
cd ~/yocto-stm32-labs/meta-bootlinlabs/conf
mkdir machine
vim bootlinlabs.conf
</pre>


<p>
<code>bootlinlabs.conf</code>
</p>
<pre class="example">
require conf/machine/include/st-machine-common-stm32mp.inc

DEFAULTTUNE = "cortexa7thf-neon-vfpv4"
require conf/machine/include/tune-cortexa7.inc

BOOTSCHEME_LABELS += "trusted"
STM32MP_DT_FILES_DK += "stm32mp157a-dk1"
ST_KERNEL_LOADADDR = "0xC2000040"
FLASHLAYOUT_CONFIG_LABELS += "sdcard"

MACHINE_FEATURES = "apm usbgadget usbhost vfat ext2 alsa"

EXTRA_IMAGEDEPENDS += "virtual/bootloader"                     # force building of u-boot
</pre>

<pre class="example">
bitbake core-minimal-image
</pre>


<p>
<code>build/tmp/deploy/images/bootlinlabs</code> should exist now.
</p>
</div>
</div>
<div id="outline-container-orgfaca88a" class="outline-5">
<h5 id="orgfaca88a"><span class="todo TODO">TODO</span> Lab 7 - Create a custom image</h5>
<div class="outline-text-5" id="text-orgfaca88a">
<p>
We will not be using <code>core-image-minimal</code> but create our own image.
</p>

<p>
In <code>mata-boolinlabs</code> we crate the standard folders for images:
</p>
<pre class="example">
mkdir recipes-core
mkdir recipes-core/images
</pre>


<p>
Create the recipe-file <code>bootlinlabs-image-minimal.bb</code>
</p>
<div class="org-src-container">
<pre class="src src-bb">DESCRIPTION = "Custom image"
LICENSE = "MIT"

inherit core-image

# good practice to have list with one item per line because of git diff
IMAGE_INSTALL = "packagegroup-core-boot \
					  ninvaders \
					 "
</pre>
</div>

<p>
Create the image according to our recipe:
</p>
<pre class="example">
bitbake bootlinlabs-image-minimal
</pre>


<p>
Should be there:
<code>build/tmp/deploy/images/</code>
</p>
</div>

<div id="outline-container-org0fcc879" class="outline-6">
<h6 id="org0fcc879">Create a Package Group</h6>
<div class="outline-text-6" id="text-org0fcc879">
<p>
in <code>recipes-core</code> create folder
</p>
<pre class="example">
mkdir packagegroups
</pre>


<p>
And create the file
<code>meta-boolinlabs/recipes-core/packagegroup-bootlinlabs-games.bb</code>
</p>
<div class="org-src-container">
<pre class="src src-bb">DESCRIPTION = "Packagegroup Example"
LICENSE = "MIT"

inherit packagegroup

RDEPEND_${PN} = "ninvaders"
</pre>
</div>

<p>
Add another group file
<code>bootlinlabs-i8mage-minimal.dbg.bb</code>
</p>
<div class="org-src-container">
<pre class="src src-bb">require bootlinlabs-i8mage-minimal.bb

# keep debug symbols
IMAGE_FEATURES += "dbg-pkgs"
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org119d673" class="outline-5">
<h5 id="org119d673"><span class="todo TODO">TODO</span> Lab 8 - Develop your application in the Poky SDK</h5>
<div class="outline-text-5" id="text-org119d673">
<p>
Build, install and use an image based SDK.
</p>
</div>

<div id="outline-container-orgad9b5c7" class="outline-6">
<h6 id="orgad9b5c7">Build SDK</h6>
<div class="outline-text-6" id="text-orgad9b5c7">
<pre class="example">
bitbake -c populate_sdk bootlinlabs-image-minimal
</pre>


<p>
A script will be available in <code>build/tmp/deploy/sdk</code>. 
</p>
</div>
</div>

<div id="outline-container-orgffec36d" class="outline-6">
<h6 id="orgffec36d">Install SDK</h6>
<div class="outline-text-6" id="text-orgffec36d">
<p>
Execute the shell script. 
</p>

<p>
It will be installed in =/opt/
</p>
</div>
</div>

<div id="outline-container-orgeefa026" class="outline-6">
<h6 id="orgeefa026">Compile an application using the SDK</h6>
</div>
</div>
</div>

<div id="outline-container-orgca04907" class="outline-4">
<h4 id="orgca04907">Additional Notes</h4>
<div class="outline-text-4" id="text-orgca04907">
<ul class="org-ul">
<li>Build via ssh on a remote build server (in docker container).</li>
<li><p>
source vs. executing a shell script: 
Set an environment variable:
</p>
<pre class="example">
export FOO="bar"   
</pre>

<p>
If you execute a script the environment variable exists only in the created process.
But if you do <code>source ./text.sh</code> the variable is still available.
So with source you execute the script in your common process. 
</p></li>
<li><code>uImage</code> image for bootloader U-Boot.</li>
<li>Debug a shell script: <code>bash -x script.sh</code></li>
<li><code>ncurses</code> library for creating user interfaces in the terminal (like make menuconfig)</li>
<li>open source licences
<ul class="org-ul">
<li>gplv2, gplv3 : give access to the source code to the customer
<ul class="org-ul">
<li>kernel gplv2</li>
<li>gplv3: source code + tools to deploy the binary to a system (to be able to use the source code)</li>
</ul></li>
<li>mit, bst, apache : no such restriction</li>
</ul></li>
</ul>
</div>
</div>
</div>
</div>

<div id="outline-container-orge086d3e" class="outline-2">
<h2 id="orge086d3e">System Programming</h2>
<div class="outline-text-2" id="text-orge086d3e">
<p>
Programs don't make system calls directly but through the Standard Library.
</p>
</div>

<div id="outline-container-org201997a" class="outline-3">
<h3 id="org201997a">Error Handling</h3>
<div class="outline-text-3" id="text-org201997a">
<ul class="org-ul">
<li><code>errno</code> : global variable</li>
</ul>
</div>
</div>
<div id="outline-container-org85088f1" class="outline-3">
<h3 id="org85088f1">File I/O</h3>
<div class="outline-text-3" id="text-org85088f1">
<p>
(see <a href="Code Snippets.html#org2b93ecd">Code Snippets.org::File I/O</a>)
</p>
<ul class="org-ul">
<li>open</li>
<li>write, read</li>
<li>close</li>
</ul>
</div>
<div id="outline-container-orgc9a5e18" class="outline-4">
<h4 id="orgc9a5e18">File Descriptors</h4>
<div class="outline-text-4" id="text-orgc9a5e18">
<p>
The kernel has one global <i>file table</i> for all open files (any process).
Two processes using the same file have two different entries in the <i>file table</i>.
</p>

<p>
File Descriptors identify entries in the <i>file table</i>.
</p>
</div>
</div>
</div>

<div id="outline-container-orgbbcb89b" class="outline-3">
<h3 id="orgbbcb89b">Devices</h3>
</div>
<div id="outline-container-org78bc18a" class="outline-3">
<h3 id="org78bc18a">Processes</h3>
<div class="outline-text-3" id="text-org78bc18a">
<ul class="org-ul">
<li><code>fork()</code></li>
<li><code>exec()</code></li>
</ul>
</div>
</div>
<div id="outline-container-orgee17095" class="outline-3">
<h3 id="orgee17095">Threads</h3>
</div>
<div id="outline-container-org019f4b7" class="outline-3">
<h3 id="org019f4b7">Signals</h3>
</div>
<div id="outline-container-org6f6fecd" class="outline-3">
<h3 id="org6f6fecd">Interprocesscommunication (IPC)</h3>
</div>
<div id="outline-container-org4f99998" class="outline-3">
<h3 id="org4f99998">Network</h3>
</div>
</div>
<div id="outline-container-orgdf3f3ca" class="outline-2">
<h2 id="orgdf3f3ca">Windows 10 Subsystem</h2>
<div class="outline-text-2" id="text-orgdf3f3ca">
<ul class="org-ul">
<li>from Windows <code>\\wsl$\Ubuntu-18.04</code> : root folder</li>
<li>from Linux <code>/mnt/c</code></li>
</ul>
</div>
</div>
<div id="outline-container-org1e6f4b9" class="outline-2">
<h2 id="org1e6f4b9">Tools and the Shell</h2>
<div class="outline-text-2" id="text-org1e6f4b9">
</div>
<div id="outline-container-orge665d72" class="outline-3">
<h3 id="orge665d72">diff and patch</h3>
<div class="outline-text-3" id="text-orge665d72">
<ul class="org-ul">
<li><a href="https://linuxacademy.com/blog/linux/introduction-using-diff-and-patch/">https://linuxacademy.com/blog/linux/introduction-using-diff-and-patch/</a></li>
<li><a href="http://www.gnu.org/software/diffutils/manual/html_node/index.html#SEC_Contents">http://www.gnu.org/software/diffutils/manual/html_node/index.html#SEC_Contents</a></li>
</ul>

<p>
Get the differences between files and files_updated, so that files
might be turned into files_updated using a single patch file.
</p>

<p>
First you create a <i>patch file</i>:
</p>
<pre class="example">
diff folder1/file folder2/file &gt; file.patch
diff -c folder1/file folder2/file &gt; file.patch
</pre>


<p>
Options:
</p>
<dl class="org-dl">
<dt><code>-c</code></dt><dd>will include the <i>context</i> in the patch file</dd>
<dt><code>-r</code></dt><dd>recursively (for folders)</dd>
</dl>

<p>
The patch file is a text file that contains information about the two files
and the two versions (incl. context) of the part in the files that differ
(incl. line numbers). Those are referred to as <i>hunks</i>. 
</p>

<p>
Then you apply the patch:<br />
(We're in folder1)
</p>
<pre class="example">
patch -i file.patch file
</pre>


<p>
Options:
</p>
<dl class="org-dl">
<dt><code>-i</code></dt><dd>input file (patch-file)</dd>
</dl>

<p>
When there is a conflict inside a hunk, i.e. a change has been made to one of the
two versions of the file (inside a text hunk), e.g.
</p>

<pre class="example">
//Version A
Version B
Version B with change (new version)
</pre>

<p>
an error will occur when patching one of the files. Normally the new version will
then be applied.
</p>

<p>
If you execute this again, the original version will be restored.
</p>

<p>
You can also just apply diff and path to whole folders including sub-folders.
</p>
<pre class="example">
diff -cr folder ../folder &gt; patch_file
patch -p0 -t -i dir.patch
</pre>


<p>
Options:
</p>
<dl class="org-dl">
<dt><code>-pNUM</code></dt><dd>Strip NUM leading components from file names.</dd>
<dt><code>-t</code>   </dt><dd>Force application (e.g. when reversing previously applied patch)</dd>
</dl>
</div>
</div>

<div id="outline-container-org00c4343" class="outline-3">
<h3 id="org00c4343">bash</h3>
<div class="outline-text-3" id="text-org00c4343">
<p>
A <i>shell</i> or <i>command language interpreter</i> is a program that handles the
<i>command line interface</i> (CLI), i.e. a means of interacting with a process
using command lines (lines of text).
</p>
</div>

<div id="outline-container-org28d4b03" class="outline-4">
<h4 id="org28d4b03">Files and Directories</h4>
<div class="outline-text-4" id="text-org28d4b03">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">analyze <b>disk usage</b></td>
<td class="org-left"><code>ncdu</code></td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">delete directory incl. subdirectories</td>
<td class="org-left"><code>rm -r</code></td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><b>copy</b> folder recursively</td>
<td class="org-left"><code>cp -R</code></td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">copy folder recursively with progress</td>
<td class="org-left"><code>rsync -ahr -I --progress source destination</code></td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">create (update) a <b>symlink</b></td>
<td class="org-left"><code>ln -sf /path/to/target /path/to/symlink</code></td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">list all Directories in current folder</td>
<td class="org-left"><code>ls -1 -d */</code></td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">show free <b>disk space</b></td>
<td class="org-left"><code>df -h</code></td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">show size of folders in current folder</td>
<td class="org-left"><code>du -sh *</code></td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">show folder size</td>
<td class="org-left"><code>du -d 1 -h folder</code></td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
Note: The "|" character in the above commands is fake. You have to replace it when copying the commands.
</p>
</div>

<div id="outline-container-org30c7ef1" class="outline-5">
<h5 id="org30c7ef1"><code>find</code> command</h5>
<div class="outline-text-5" id="text-org30c7ef1">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">count nr. files recursively in current folder</td>
<td class="org-left"><code>find -type f ǀ wc -l</code></td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">count nr. directories recursively in current folder</td>
<td class="org-left"><code>find -mindepth 1 -type d ǀ wc -l</code></td>
<td class="org-left">-mindepth 1 to avoid listing DIR</td>
</tr>

<tr>
<td class="org-left"><b>find</b> all pdfs (filename only) and sort them</td>
<td class="org-left"><code>find -type f -name '*.pdf' -printf "%f\n" ǀ sort -n</code></td>
<td class="org-left">"*" will not match "."!</td>
</tr>

<tr>
<td class="org-left">remove all directories and subdirectories named DIR</td>
<td class="org-left"><code>find -type d -name DIR* -print0 ǀ xargs -0 rm -r</code></td>
<td class="org-left">use also <code>-regex</code> instead of <code>-name</code></td>
</tr>

<tr>
<td class="org-left">sort files rec. by size in decending order</td>
<td class="org-left"><code>find -name *.c -ls ǀ sort -r -k7</code></td>
<td class="org-left">sort by 7th column</td>
</tr>

<tr>
<td class="org-left">find all symlinks in folder</td>
<td class="org-left"><code>find FOLDER -type l -ls</code></td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>

<div id="outline-container-orgf387626" class="outline-4">
<h4 id="orgf387626">System</h4>
<div class="outline-text-4" id="text-orgf387626">
<p>
<b>Devices</b>
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides" style="margin-left:35px;">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">get <b>UUID</b> of device</td>
<td class="org-left"><code>sudo blkid</code></td>
</tr>

<tr>
<td class="org-left">list all <b>block devices</b></td>
<td class="org-left"><code>lsblk</code></td>
</tr>

<tr>
<td class="org-left">list <b>ids of block devices</b></td>
<td class="org-left"><code>blkid</code></td>
</tr>

<tr>
<td class="org-left">list connected <b>usb devices</b></td>
<td class="org-left"><code>lsusb</code></td>
</tr>

<tr>
<td class="org-left">list devices and partitions</td>
<td class="org-left"><code>sudo fdisk -l</code></td>
</tr>

<tr>
<td class="org-left">list processes using device</td>
<td class="org-left"><code>lsof /dev/sdc1</code></td>
</tr>
</tbody>
</table>


<p>
<b>Users, Groups</b>
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides" style="margin-left:35px;">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">add new user</td>
<td class="org-left"><code>adduser username</code></td>
</tr>

<tr>
<td class="org-left">change current user</td>
<td class="org-left"><code>su newUser</code></td>
</tr>

<tr>
<td class="org-left">list all current users</td>
<td class="org-left"><code>cut -d: -f1 /etc/passwd</code></td>
</tr>

<tr>
<td class="org-left">list all groups a user belongs to</td>
<td class="org-left"><code>groups user</code></td>
</tr>

<tr>
<td class="org-left">set user / su password</td>
<td class="org-left"><code>passwd (user)/ sudo passwd</code></td>
</tr>
</tbody>
</table>

<p>
<code>ps -aux</code> Command
</p>
<pre class="example">
USER       PID  %CPU %MEM  VSZ RSS     TTY   STAT START   TIME COMMAND
timothy  29217  0.0  0.0 11916 4560 pts/21   S+   08:15   0:00 pine  
</pre>


<ul class="org-ul">
<li>USER = user owning the process</li>
<li>PID = process ID of the process</li>
<li>%CPU = It is the CPU time used divided by the time the process has been running.</li>
<li>%MEM = ratio of the process’s resident set size to the physical memory on the machine</li>
<li>VSZ = virtual memory usage of entire process (in KiB)</li>
<li>RSS = resident set size, the non-swapped physical memory that a task has used (in KiB)</li>
<li>TTY = controlling tty (terminal)</li>
<li>STAT = multi-character process state</li>
<li>START = starting time or date of the process</li>
<li>TIME = cumulative CPU time</li>
<li>COMMAND = command with all its arguments</li>
</ul>

<p>
<b>Kernel</b>
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides" style="margin-left:35px;">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">show current <b>kernel version</b></td>
<td class="org-left"><code>uname -r</code> or <code>cat /proc/version_signature</code></td>
<td class="org-left">only the 2nd gives you the mainline version</td>
</tr>
</tbody>
</table>
</div>


<div id="outline-container-org8ed45dc" class="outline-5">
<h5 id="org8ed45dc">Grub</h5>
<div class="outline-text-5" id="text-org8ed45dc">
<ul class="org-ul">
<li><code>/etc/defaults/grub</code></li>
<li><code>/etc/grub.d</code></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgefe6651" class="outline-4">
<h4 id="orgefe6651">Commands</h4>
<div class="outline-text-4" id="text-orgefe6651">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">execute history cmd nr 20</td>
<td class="org-left"><code>!20</code></td>
</tr>

<tr>
<td class="org-left">search for previous cmds</td>
<td class="org-left"><code>Ctrl + r</code></td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-org6a13dd1" class="outline-4">
<h4 id="org6a13dd1">Scripts</h4>
<div class="outline-text-4" id="text-org6a13dd1">
</div>
<div id="outline-container-org8ca29d4" class="outline-5">
<h5 id="org8ca29d4">Branching</h5>
<div class="outline-text-5" id="text-org8ca29d4">
<p>
if condition; then &#x2026; else &#x2026; fi
</p>
<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">the space " " before "]" is necessary !</span>
<span class="org-keyword">if</span> [ 7 -lt 8 ]; <span class="org-keyword">then</span>
   <span class="org-comment-delimiter"># </span><span class="org-comment">operators</span>
   <span class="org-comment-delimiter"># </span><span class="org-comment">-lt &lt;,  -gt &gt;,  -eq ==, -ne !=, </span>
   <span class="org-comment-delimiter"># </span><span class="org-comment">[ 001 = 1 ]   is false </span>
   <span class="org-comment-delimiter"># </span><span class="org-comment">[ 001 -eq 1 ] is true</span>
   command
   ...
<span class="org-keyword">else</span>
   command
   ...
<span class="org-keyword">fi</span>
</pre>
</div>

<p>
case statement
</p>
<div class="org-src-container">
<pre class="src src-sh"><span class="org-keyword">case</span> $<span class="org-variable-name">1</span><span class="org-keyword"> in</span>
   start)
      <span class="org-builtin">echo</span> starting
      ;;
   stop)
      <span class="org-builtin">echo</span> stoping
      ;;
   restart)
      <span class="org-builtin">echo</span> restarting
      ;;
   *)
      <span class="org-builtin">echo</span> don<span class="org-string">\'</span>t know
      ;;
<span class="org-keyword">esac</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc1891e9" class="outline-5">
<h5 id="orgc1891e9">Loops</h5>
<div class="outline-text-5" id="text-orgc1891e9">
<p>
while condition; do &#x2026; done
</p>
<div class="org-src-container">
<pre class="src src-sh"><span class="org-keyword">while</span> [[ -e wait.txt ]] ; <span class="org-keyword">do</span>
  sleep 3 <span class="org-comment-delimiter"># </span><span class="org-comment">"sleep" for three seconds</span>
<span class="org-keyword">done</span>
</pre>
</div>

<p>
for i in &#x2026;; do &#x2026; done
</p>
<div class="org-src-container">
<pre class="src src-sh"><span class="org-keyword">for</span> i<span class="org-keyword"> in</span> {1..20} ; <span class="org-keyword">do</span>
  <span class="org-builtin">echo</span> <span class="org-string">"$i"</span>
<span class="org-keyword">done</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org3b618db" class="outline-5">
<h5 id="org3b618db">Variables</h5>
<div class="outline-text-5" id="text-org3b618db">
<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">no space around "=" !</span>
<span class="org-variable-name">location</span>=world               <span class="org-comment-delimiter"># </span><span class="org-comment">store "world" in the variable "location"</span>
<span class="org-builtin">echo</span> <span class="org-string">"Hello, $location!"</span>     <span class="org-comment-delimiter"># </span><span class="org-comment">variable expansion</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org76b8736" class="outline-5">
<h5 id="org76b8736">Functions</h5>
<div class="outline-text-5" id="text-org76b8736">
<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter">#</span><span class="org-comment">!/bin/</span><span class="org-keyword">bash</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">Usage:     get_password VARNAME</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">Asks the user for a password; saves it as $VARNAME.</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">Returns a non-zero exit status if standard input is not a terminal, or if the</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">"read" command returns a non-zero exit status.</span>
<span class="org-function-name">get_password</span>() {
  <span class="org-keyword">if</span> [[ -t 0 ]] ; <span class="org-keyword">then</span>
    <span class="org-builtin">read</span> -r -p <span class="org-string">'Password:'</span> -s <span class="org-string">"$1"</span> &amp;&amp; <span class="org-builtin">echo</span>
  <span class="org-keyword">else</span>
    <span class="org-keyword">return</span> 1
  <span class="org-keyword">fi</span>
}

get_password PASSWORD &amp;&amp; <span class="org-builtin">echo</span> <span class="org-string">"$PASSWORD"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org242a363" class="outline-5">
<h5 id="org242a363">Redirect Output and Input</h5>
<div class="outline-text-5" id="text-org242a363">
<p>
override output file
</p>
<pre class="example">
cat file.txt &gt; output.txt
</pre>


<p>
append to output file
</p>
<pre class="example">
cat file.txt &gt;&gt; output.txt
</pre>


<p>
standard out plus standard error (file-descriptor 2)
</p>
<pre class="example">
cat file.txt &gt;&gt; output.txt 2&gt;&amp;1
</pre>
</div>
</div>



<div id="outline-container-org994d53b" class="outline-5">
<h5 id="org994d53b">Error checking</h5>
<div class="outline-text-5" id="text-org994d53b">
<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">the space " " before "]" is necessary !</span>
<span class="org-keyword">if</span> [ <span class="org-string">"$?"</span> -ne 0 ]; <span class="org-keyword">then</span>
   <span class="org-builtin">echo</span> <span class="org-string">"command failed"</span>
   <span class="org-keyword">exit</span> 1
<span class="org-keyword">else</span>
   <span class="org-builtin">echo</span> <span class="org-string">"USB Drives connected"</span>
<span class="org-keyword">fi</span>
</pre>
</div>

<pre class="example">
The variable $ (echo $?)
</pre>

<p>
0 is supposed to mean success, everything else is an error.
</p>
</div>
</div>
<div id="outline-container-orgf16ccf7" class="outline-5">
<h5 id="orgf16ccf7">Monitor changes in a folder</h5>
<div class="outline-text-5" id="text-orgf16ccf7">
<p>
Use <code>inotifywait</code>. 
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter">#</span><span class="org-comment">!/bin/</span><span class="org-keyword">sh</span>
<span class="org-keyword">while</span> inotifywait -e modify /var/log/messages; <span class="org-keyword">do</span>
  <span class="org-keyword">if</span> tail -n1 /var/log/messages | grep apache; <span class="org-keyword">then</span>
    kdialog --msgbox <span class="org-string">"Blah blah Apache"</span>
  <span class="org-keyword">fi</span>
<span class="org-keyword">done</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-org329f8cc" class="outline-3">
<h3 id="org329f8cc">Nano Editor</h3>
<div class="outline-text-3" id="text-org329f8cc">
<p>
Shortcuts
</p>
<dl class="org-dl">
<dt><code>Ctrl + G</code></dt><dd>Show complete list of shortcuts</dd>
<dt><code>Ctrl + W</code></dt><dd>Search (Where Is)</dd>
<dt><code>Alt + W</code></dt><dd>Repeat last Search</dd>
</dl>
</div>
</div>
<div id="outline-container-orga6403b4" class="outline-3">
<h3 id="orga6403b4">Vim</h3>
<div class="outline-text-3" id="text-orga6403b4">
<p style="column-count: 3;">
<b>Insert</b>
</p>
<ul class="org-ul">
<li><code>i</code> / <code>I</code> : before cursor / line</li>
<li><code>a</code> / <code>A</code> : after cursor / line</li>
<li><code>o</code> / <code>O</code> : new line after / before current line</li>
</ul>

<p>
<b>Edit</b>
</p>
<ul class="org-ul">
<li><code>n dd</code>   : delete next n lines</li>
<li><code>u</code>      : undo</li>
<li><code>v</code>, <code>V</code> : select characters, whole line</li>
<li><code>y</code>      : copy (yank)</li>
<li><code>P</code>, <code>p</code> : paste before, after cursor</li>
</ul>

<p>
<b>Motion</b>
</p>
<ul class="org-ul">
<li><code>G</code>  : last line</li>
<li><code>gg</code> : first line</li>
<li><code>nG</code> : line n (especially n=1)</li>
<li><code>$</code>  : end of line</li>
<li><code>0</code>  : beginning of line</li>
</ul>

<p>
<b>Search &amp; Replace</b>
</p>
<ul class="org-ul">
<li><code>/pattern</code>             : Very simple Search (<code>n</code> / <code>N</code> jump to next/previous matches)</li>
<li><code>:s/pattern</code>           : Simple Search</li>
<li><code>:%s/pattern/replace</code>  : Replace every occurrence</li>
</ul>
</div>
</div>
<div id="outline-container-org89a3109" class="outline-3">
<h3 id="org89a3109">ssh</h3>
<div class="outline-text-3" id="text-org89a3109">
</div>
<div id="outline-container-orgf808053" class="outline-4">
<h4 id="orgf808053">start a process and leave ssh:</h4>
<div class="outline-text-4" id="text-orgf808053">
<p>
use tmux, detach: 
</p>
<pre class="example">
Ctrl-q d
</pre>


<p>
re-attach:
</p>
<pre class="example">
tmux ls
tmux attach-session -t &lt;ID&gt;
</pre>
</div>
</div>
<div id="outline-container-org36e0364" class="outline-4">
<h4 id="org36e0364">Transfer files with scp</h4>
<div class="outline-text-4" id="text-org36e0364">
<p>
using pscp (on Windows)
</p>
<pre class="example">
pscp c:\documents\info.txt userid@server.example.com:/tmp/foo/info.txt
scp /path/to/source pi@192.168.10.61:/home/pi/destination
</pre>
</div>
</div>
</div>
<div id="outline-container-org61a96e9" class="outline-3">
<h3 id="org61a96e9">tmux</h3>
<div class="outline-text-3" id="text-org61a96e9">
<p>
Config file: <code>/etc/tmux.conf</code>
</p>

<p>
You can either use shortcuts starting with a prefix.
(we use <code>Ctrl-q</code> as prefix) or enter commands in the CLI.
</p>

<dl class="org-dl">
<dt><code>Ctrl-q d</code>                   </dt><dd>Detach.</dd>
<dt><code>tmux ls</code>                    </dt><dd>List running tmux sessions.</dd>
<dt><code>tmux attach-session -t &lt;ID&gt;</code></dt><dd>Re-attach to a session.</dd>
<dt><code>tmux kill-server</code>         </dt><dd>End all sessions (Useful when changing <code>tmux.conf</code>).</dd>
</dl>

<p>
<b>Windows &amp; Panes</b> <br />
Windows are actually Tabs. Panes are used to split windows into
different areas, so you'll have different command lines that you can 
see simultaneously. 
</p>

<dl class="org-dl">
<dt><code>Ctrl-q c</code> or <code>tmux new-window</code></dt><dd>Create a new Tab.</dd>
<dt><code>Ctrl-q 0-9</code> or <code>tmux select-window -t 0-9</code></dt><dd>Select a Tab.</dd>

<dt><code>Ctrl-q "</code> or <code>tmux split-window</code></dt><dd>split window vertically -</dd>
<dt><code>Ctrl-q %</code> or <code>tmux split-window -h</code></dt><dd>split window horizontally |</dd>
<dt><code>Ctrl-q arrow-key</code></dt><dd>move around to next pane</dd>

<dt><code>Ctrl-q Ctrl-arrow-key</code></dt><dd>resize pane</dd>
</dl>
</div>
</div>

<div id="outline-container-org45170c3" class="outline-3">
<h3 id="org45170c3">grep</h3>
<div class="outline-text-3" id="text-org45170c3">
<dl class="org-dl">
<dt><code>grep -e pattern1 -e pattern2 -e pattern3</code></dt><dd>match multiple lines</dd>
</dl>
</div>
</div>

<div id="outline-container-org797aa5b" class="outline-3">
<h3 id="org797aa5b">zsh</h3>
<div class="outline-text-3" id="text-org797aa5b">
<ul class="org-ul">
<li>switch to <code>zsh</code> : <code>exec zsh</code></li>
<li>switch back : <code>exec bash</code></li>
</ul>

<p>
Make <code>zsh</code> default login shell: <code>chsh</code> (change your login shell)
</p>
<ul class="org-ul">
<li><code>chsh -s $(wich zsh)</code></li>
<li><code>chsh -s /usr/bin/bash</code></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orge7cc5d4" class="outline-2">
<h2 id="orge7cc5d4">KDE</h2>
<div class="outline-text-2" id="text-orge7cc5d4">
</div>
<div id="outline-container-org47aace6" class="outline-3">
<h3 id="org47aace6">Activities</h3>
<div class="outline-text-3" id="text-org47aace6">
<p>
Virtual desktops for specific purposes, each containing again multiple
desktops. 
</p>

<p>
What can differ?
</p>
<ul class="org-ul">
<li>desktop background</li>
<li>widgets</li>
<li>icon position
(though the icons themselves are the same)</li>
</ul>
</div>
</div>
<div id="outline-container-org7a11045" class="outline-3">
<h3 id="org7a11045">Plasmoids</h3>
<div class="outline-text-3" id="text-org7a11045">
<p>
Widgets or gadgets. 
</p>
</div>
</div>
<div id="outline-container-org9a851aa" class="outline-3">
<h3 id="org9a851aa">Bookmarks</h3>
<div class="outline-text-3" id="text-org9a851aa">
<ul class="org-ul">
<li>Places - global</li>
<li>Application Bookmarks
yellow star in the file open dialog</li>
</ul>
</div>
</div>
<div id="outline-container-orgf8ec9de" class="outline-3">
<h3 id="orgf8ec9de">Dolphin</h3>
<div class="outline-text-3" id="text-orgf8ec9de">
<ul class="org-ul">
<li>FTP conncetion</li>
</ul>
</div>
</div>
<div id="outline-container-org29df452" class="outline-3">
<h3 id="org29df452">Applications</h3>
<div class="outline-text-3" id="text-org29df452">
<ul class="org-ul">
<li>KSnapshot</li>
<li>KRunner
Program starter.</li>
<li>KMail</li>
</ul>
</div>
</div>
<div id="outline-container-org36b6048" class="outline-3">
<h3 id="org36b6048">Baloo Indexer</h3>
<div class="outline-text-3" id="text-org36b6048">
<p>
Show index information on a file
</p>
<pre class="example">
balooshow myFile.org
</pre>


<p>
Control ballo
</p>
<pre class="example">
balooctl ARG
</pre>

<ul class="org-ul">
<li><code>status</code></li>
<li><code>purge</code> : Delete database.</li>
<li><code>index</code> : Index specified file (<code>balooctl index FILE</code>).</li>
<li><code>monitor</code> : Check live what <code>baloo</code> is doing.</li>
<li><code>config</code> : Configure <code>baloo</code>.</li>
</ul>
</div>
</div>
<div id="outline-container-orgbf7c406" class="outline-3">
<h3 id="orgbf7c406">KDE neon</h3>
<div class="outline-text-3" id="text-orgbf7c406">
</div>
<div id="outline-container-org72c0c7a" class="outline-4">
<h4 id="org72c0c7a">Customize KDE Plasma</h4>
<div class="outline-text-4" id="text-org72c0c7a">
<ol class="org-ol">
<li>Delete Default Panel</li>
<li>Add Application Menu Bar (Widget)</li>
<li>Add Widgets Application Menu Bar</li>
<li>Add Shortcut for Win - Key</li>
<li>Install Latte - Dock</li>
<li>Choose Theme Breeze Dark (or Materia)</li>
<li>Add System Tray Widget</li>
</ol>
</div>
</div>

<div id="outline-container-orgfb36b69" class="outline-4">
<h4 id="orgfb36b69">Install applications</h4>
<div class="outline-text-4" id="text-orgfb36b69">
<ul class="org-ul">
<li>Emacs
<ul class="org-ul">
<li>add symbolic links to <code>.emacs</code>, <code>.emacs.d</code>, <code>org-config.el</code></li>
</ul></li>
<li>CopyQ</li>
<li>Thunderbird</li>
<li>Vim</li>
<li><p>
Visual Studio Code
</p>
<pre class="example">
sudo snap install --classic code
</pre></li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-orgd9a2889" class="outline-2">
<h2 id="orgd9a2889">History</h2>
<div class="outline-text-2" id="text-orgd9a2889">
<p>
Multics
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Created: 2021-03-24 Wed 06:00</p>
</div>
</body>
</html>
